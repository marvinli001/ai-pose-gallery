{% extends "base.html" %}

{% block title %}å°çº¢ä¹¦æ•°æ®æºç®¡ç† - AIå§¿åŠ¿å‚è€ƒå›¾åº“{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- é¡µå¤´ -->
    <div class="row mb-4">
        <div class="col">
            <h2><i class="fas fa-heart text-danger"></i> å°çº¢ä¹¦æ•°æ®æºç®¡ç†</h2>
            <p class="text-muted">ä»å°çº¢ä¹¦å¯¼å…¥é«˜è´¨é‡çš„å§¿åŠ¿å‚è€ƒå†…å®¹ï¼Œä½¿ç”¨GPT-4oè¿›è¡Œæ™ºèƒ½åˆ†æå’Œç­›é€‰</p>
        </div>
    </div>
    
    <!-- ç»Ÿè®¡å¡ç‰‡ -->
    <div class="row mb-4" id="statsCards">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">æ€»å†…å®¹æ•°</h6>
                            <h3 id="totalContent">-</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-file-alt fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">æ´»è·ƒå†…å®¹</h6>
                            <h3 id="activeContent">-</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-check-circle fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">å·²å¤„ç†</h6>
                            <h3 id="processedContent">-</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-cogs fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">å¹³å‡è´¨é‡åˆ†</h6>
                            <h3 id="avgQuality">-</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-star fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- åŠŸèƒ½åŒºåŸŸ -->
    <div class="row mb-4">
        <!-- å¯¼å…¥é…ç½® -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-download"></i> æ‰¹é‡å¯¼å…¥å†…å®¹</h5>
                </div>
                <div class="card-body">
                    <form id="importForm">
                        <div class="mb-3">
                            <label for="keywords" class="form-label">æœç´¢å…³é”®è¯</label>
                            <textarea class="form-control" id="keywords" rows="3" 
                                placeholder="è¯·è¾“å…¥æœç´¢å…³é”®è¯ï¼Œæ¯è¡Œä¸€ä¸ªï¼Œä¾‹å¦‚ï¼š&#10;å§¿åŠ¿å‚è€ƒ&#10;äººç‰©å§¿åŠ¿&#10;æ‹ç…§å§¿åŠ¿"></textarea>
                            <div class="form-text">æ¯è¡Œè¾“å…¥ä¸€ä¸ªå…³é”®è¯ï¼Œç³»ç»Ÿå°†é€ä¸ªæœç´¢å¹¶å¯¼å…¥</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="limitPerKeyword" class="form-label">æ¯ä¸ªå…³é”®è¯æœç´¢æ•°é‡</label>
                            <select class="form-select" id="limitPerKeyword">
                                <option value="5">5ä¸ª</option>
                                <option value="10" selected>10ä¸ª</option>
                                <option value="20">20ä¸ª</option>
                                <option value="30">30ä¸ª</option>
                            </select>
                        </div>
                        
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-play"></i> å¼€å§‹å¯¼å…¥
                        </button>
                    </form>
                    
                    <div id="importResult" class="mt-3" style="display: none;"></div>
                </div>
            </div>
        </div>
        
        <!-- å®æ—¶æœç´¢ -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-search"></i> å®æ—¶æœç´¢é¢„è§ˆ</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="searchKeyword" class="form-label">æœç´¢å…³é”®è¯</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="searchKeyword" 
                                placeholder="è¾“å…¥å…³é”®è¯è¿›è¡Œå®æ—¶æœç´¢">
                            <button class="btn btn-outline-primary" type="button" id="searchBtn">
                                <i class="fas fa-search"></i> æœç´¢
                            </button>
                        </div>
                    </div>
                    
                    <div id="searchResult" class="search-result" style="max-height: 300px; overflow-y: auto;">
                        <div class="text-center text-muted py-3">
                            <i class="fas fa-search fa-2x mb-2"></i>
                            <p>è¾“å…¥å…³é”®è¯å¼€å§‹æœç´¢</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- å†…å®¹åˆ—è¡¨ -->
    <div class="card">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-list"></i> å·²å¯¼å…¥å†…å®¹</h5>
                <div>
                    <select class="form-select form-select-sm" id="keywordFilter" style="width: auto; display: inline-block;">
                        <option value="">æ‰€æœ‰å…³é”®è¯</option>
                    </select>
                    <button class="btn btn-sm btn-outline-primary ms-2" onclick="loadContent()">
                        <i class="fas fa-refresh"></i> åˆ·æ–°
                    </button>
                </div>
            </div>
        </div>
        <div class="card-body">
            <div id="contentList">
                <div class="text-center py-4">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">åŠ è½½ä¸­...</span>
                    </div>
                    <p class="mt-2">æ­£åœ¨åŠ è½½å†…å®¹...</p>
                </div>
            </div>
            
            <!-- åˆ†é¡µ -->
            <nav id="pagination" style="display: none;">
                <ul class="pagination justify-content-center" id="paginationList">
                </ul>
            </nav>
        </div>
    </div>
</div>
{% endblock %}

{% block styles %}
<style>
.search-result {
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    background-color: #f8f9fa;
}

.content-item {
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    padding: 1rem;
    margin-bottom: 1rem;
    background: white;
}

.content-item:hover {
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.score-badge {
    font-size: 0.75rem;
}

.image-preview {
    width: 60px;
    height: 60px;
    object-fit: cover;
    border-radius: 0.25rem;
    margin-right: 0.5rem;
}

.quality-bar {
    height: 4px;
    border-radius: 2px;
    background: #e9ecef;
    overflow: hidden;
}

.quality-fill {
    height: 100%;
    transition: width 0.3s ease;
}
</style>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // åˆå§‹åŒ–é¡µé¢
    loadStats();
    loadContent();
    
    // å¯¼å…¥è¡¨å•æäº¤
    document.getElementById('importForm').addEventListener('submit', function(e) {
        e.preventDefault();
        startImport();
    });
    
    // æœç´¢æŒ‰é’®
    document.getElementById('searchBtn').addEventListener('click', function() {
        performSearch();
    });
    
    // å…³é”®è¯è¿‡æ»¤
    document.getElementById('keywordFilter').addEventListener('change', function() {
        loadContent();
    });
});

async function loadStats() {
    try {
        const response = await fetch('/api/xiaohongshu/stats');
        const data = await response.json();
        
        if (data.success) {
            const stats = data.data;
            document.getElementById('totalContent').textContent = stats.total_content;
            document.getElementById('activeContent').textContent = stats.active_content;
            document.getElementById('processedContent').textContent = stats.processed_content;
            document.getElementById('avgQuality').textContent = (stats.avg_quality_score * 100).toFixed(1) + '%';
            
            // æ›´æ–°å…³é”®è¯è¿‡æ»¤å™¨
            const keywordFilter = document.getElementById('keywordFilter');
            keywordFilter.innerHTML = '<option value="">æ‰€æœ‰å…³é”®è¯</option>';
            
            stats.keyword_distribution.forEach(item => {
                const option = document.createElement('option');
                option.value = item.keyword;
                option.textContent = `${item.keyword} (${item.count})`;
                keywordFilter.appendChild(option);
            });
        }
    } catch (error) {
        console.error('åŠ è½½ç»Ÿè®¡å¤±è´¥:', error);
    }
}

async function startImport() {
    const keywordsText = document.getElementById('keywords').value.trim();
    const limitPerKeyword = document.getElementById('limitPerKeyword').value;
    
    if (!keywordsText) {
        alert('è¯·è¾“å…¥æœç´¢å…³é”®è¯');
        return;
    }
    
    const keywords = keywordsText.split('\n').map(k => k.trim()).filter(k => k);
    
    if (keywords.length === 0) {
        alert('è¯·è¾“å…¥æœ‰æ•ˆçš„å…³é”®è¯');
        return;
    }
    
    const importResult = document.getElementById('importResult');
    importResult.innerHTML = `
        <div class="alert alert-info">
            <i class="fas fa-spinner fa-spin"></i> æ­£åœ¨å¯åŠ¨å¯¼å…¥ä»»åŠ¡...
            <br><small>å…³é”®è¯: ${keywords.join(', ')}</small>
        </div>
    `;
    importResult.style.display = 'block';
    
    try {
        const params = new URLSearchParams();
        keywords.forEach(keyword => params.append('keywords', keyword));
        params.append('limit_per_keyword', limitPerKeyword);
        
        const response = await fetch(`/api/xiaohongshu/import?${params}`, {
            method: 'POST'
        });
        
        const data = await response.json();
        
        if (data.success) {
            importResult.innerHTML = `
                <div class="alert alert-success">
                    <i class="fas fa-check"></i> ${data.message}
                    <br><small>è¯·ç­‰å¾…åå°å¤„ç†å®Œæˆï¼Œå¯ä»¥åˆ·æ–°é¡µé¢æŸ¥çœ‹è¿›åº¦</small>
                </div>
            `;
            
            // 5ç§’åå¼€å§‹è½®è¯¢æ›´æ–°ç»Ÿè®¡
            setTimeout(() => {
                const interval = setInterval(() => {
                    loadStats();
                    loadContent();
                }, 3000);
                
                // 30ç§’ååœæ­¢è½®è¯¢
                setTimeout(() => clearInterval(interval), 30000);
            }, 5000);
            
        } else {
            importResult.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i> å¯¼å…¥å¤±è´¥: ${data.detail || 'æœªçŸ¥é”™è¯¯'}
                </div>
            `;
        }
    } catch (error) {
        importResult.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle"></i> å¯¼å…¥å¤±è´¥: ${error.message}
            </div>
        `;
    }
}

async function performSearch() {
    const keyword = document.getElementById('searchKeyword').value.trim();
    const searchResult = document.getElementById('searchResult');
    
    if (!keyword) {
        alert('è¯·è¾“å…¥æœç´¢å…³é”®è¯');
        return;
    }
    
    searchResult.innerHTML = `
        <div class="text-center py-3">
            <div class="spinner-border spinner-border-sm" role="status"></div>
            <p class="mt-2 mb-0">æ­£åœ¨æœç´¢ "${keyword}"...</p>
        </div>
    `;
    
    try {
        const response = await fetch(`/api/xiaohongshu/search?keyword=${encodeURIComponent(keyword)}&limit=5`);
        const data = await response.json();
        
        if (data.success && data.data.results.length > 0) {
            const results = data.data.results;
            let html = '';
            
            results.forEach(item => {
                html += `
                    <div class="border-bottom py-2">
                        <h6 class="mb-1">${item.title}</h6>
                        <p class="small text-muted mb-1">${item.description}</p>
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">ä½œè€…: ${item.author}</small>
                            <div>
                                <span class="badge bg-primary me-1">â¤ï¸ ${item.like_count}</span>
                                <span class="badge bg-secondary">ğŸ’¬ ${item.comment_count}</span>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            searchResult.innerHTML = html;
        } else {
            searchResult.innerHTML = `
                <div class="text-center py-3 text-muted">
                    <i class="fas fa-search fa-2x mb-2"></i>
                    <p>æ²¡æœ‰æ‰¾åˆ°ç›¸å…³å†…å®¹</p>
                </div>
            `;
        }
    } catch (error) {
        searchResult.innerHTML = `
            <div class="text-center py-3 text-danger">
                <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                <p>æœç´¢å¤±è´¥: ${error.message}</p>
            </div>
        `;
    }
}

async function loadContent(page = 1) {
    const keyword = document.getElementById('keywordFilter').value;
    const contentList = document.getElementById('contentList');
    
    try {
        let url = `/api/xiaohongshu/content?page=${page}&per_page=10`;
        if (keyword) {
            url += `&keyword=${encodeURIComponent(keyword)}`;
        }
        
        const response = await fetch(url);
        const data = await response.json();
        
        if (data.success) {
            const contents = data.data.contents;
            const pagination = data.data.pagination;
            
            if (contents.length === 0) {
                contentList.innerHTML = `
                    <div class="text-center py-4 text-muted">
                        <i class="fas fa-inbox fa-3x mb-3"></i>
                        <h5>æš‚æ— å†…å®¹</h5>
                        <p>å¼€å§‹å¯¼å…¥å°çº¢ä¹¦å†…å®¹å§ï¼</p>
                    </div>
                `;
                document.getElementById('pagination').style.display = 'none';
                return;
            }
            
            // æ¸²æŸ“å†…å®¹åˆ—è¡¨
            let html = '';
            contents.forEach(content => {
                const qualityPercent = (content.ai_quality_score || 0) * 100;
                const relevancePercent = (content.ai_relevance_score || 0) * 100;
                
                html += `
                    <div class="content-item">
                        <div class="row">
                            <div class="col-md-2">
                                ${content.image_urls && content.image_urls.length > 0 ? 
                                    content.image_urls.slice(0, 3).map(url => 
                                        `<img src="${url}" class="image-preview" alt="é¢„è§ˆå›¾">`
                                    ).join('') : 
                                    '<div class="image-preview bg-light d-flex align-items-center justify-content-center"><i class="fas fa-image text-muted"></i></div>'
                                }
                            </div>
                            <div class="col-md-7">
                                <h6>${content.title}</h6>
                                <p class="text-muted small mb-2">${content.description}</p>
                                <div class="mb-2">
                                    <small class="text-muted">ä½œè€…: ${content.author} | å…³é”®è¯: ${content.import_keyword}</small>
                                </div>
                                <div class="d-flex gap-2">
                                    ${content.ai_suggested_tags ? content.ai_suggested_tags.map(tag => 
                                        `<span class="badge bg-light text-dark">${tag}</span>`
                                    ).join('') : ''}
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-2">
                                    <small>è´¨é‡è¯„åˆ†</small>
                                    <div class="quality-bar">
                                        <div class="quality-fill bg-success" style="width: ${qualityPercent}%"></div>
                                    </div>
                                    <small class="text-muted">${qualityPercent.toFixed(1)}%</small>
                                </div>
                                <div class="mb-2">
                                    <small>ç›¸å…³æ€§è¯„åˆ†</small>
                                    <div class="quality-bar">
                                        <div class="quality-fill bg-info" style="width: ${relevancePercent}%"></div>
                                    </div>
                                    <small class="text-muted">${relevancePercent.toFixed(1)}%</small>
                                </div>
                                <div class="d-flex gap-1">
                                    <span class="badge bg-danger score-badge">â¤ï¸ ${content.like_count}</span>
                                    <span class="badge bg-secondary score-badge">ğŸ’¬ ${content.comment_count}</span>
                                    <span class="badge bg-warning score-badge">ğŸ“¤ ${content.share_count}</span>
                                </div>
                                <div class="mt-2">
                                    <a href="${content.source_url}" target="_blank" class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-external-link-alt"></i> æŸ¥çœ‹åŸæ–‡
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            contentList.innerHTML = html;
            
            // æ¸²æŸ“åˆ†é¡µ
            renderPagination(pagination);
        }
    } catch (error) {
        console.error('åŠ è½½å†…å®¹å¤±è´¥:', error);
        contentList.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle"></i> åŠ è½½å¤±è´¥: ${error.message}
            </div>
        `;
    }
}

function renderPagination(pagination) {
    const paginationElement = document.getElementById('pagination');
    const paginationList = document.getElementById('paginationList');
    
    if (pagination.pages <= 1) {
        paginationElement.style.display = 'none';
        return;
    }
    
    let html = '';
    
    // ä¸Šä¸€é¡µ
    if (pagination.page > 1) {
        html += `<li class="page-item"><a class="page-link" href="#" onclick="loadContent(${pagination.page - 1})">ä¸Šä¸€é¡µ</a></li>`;
    }
    
    // é¡µç 
    const startPage = Math.max(1, pagination.page - 2);
    const endPage = Math.min(pagination.pages, pagination.page + 2);
    
    for (let i = startPage; i <= endPage; i++) {
        html += `<li class="page-item ${i === pagination.page ? 'active' : ''}">
            <a class="page-link" href="#" onclick="loadContent(${i})">${i}</a>
        </li>`;
    }
    
    // ä¸‹ä¸€é¡µ
    if (pagination.page < pagination.pages) {
        html += `<li class="page-item"><a class="page-link" href="#" onclick="loadContent(${pagination.page + 1})">ä¸‹ä¸€é¡µ</a></li>`;
    }
    
    paginationList.innerHTML = html;
    paginationElement.style.display = 'block';
}
</script>
{% endblock %}