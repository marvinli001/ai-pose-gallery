<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”¨æˆ·ç®¡ç† - AIå§¿åŠ¿å‚è€ƒå›¾åº“</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <style>
        /* ===== å…¨å±€æ ·å¼ ===== */
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --success-gradient: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
            --warning-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --info-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --danger-gradient: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
            --shadow-light: 0 2px 10px rgba(0,0,0,0.1);
            --shadow-medium: 0 5px 20px rgba(0,0,0,0.15);
            --shadow-heavy: 0 10px 30px rgba(0,0,0,0.2);
            --border-radius: 15px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #2c3e50;
        }

        /* ===== å®¹å™¨å¸ƒå±€ ===== */
        .main-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 25px;
            margin: 20px;
            overflow: hidden;
            box-shadow: var(--shadow-heavy);
            min-height: calc(100vh - 40px);
        }

        /* ===== é¡µé¢å¤´éƒ¨ ===== */
        .admin-header {
            background: var(--success-gradient);
            color: white;
            padding: 2.5rem 2rem;
            position: relative;
            overflow: hidden;
        }

        .admin-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="white" opacity="0.1"/><circle cx="75" cy="75" r="1.5" fill="white" opacity="0.08"/><circle cx="50" cy="10" r="0.5" fill="white" opacity="0.12"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
        }

        .admin-header .row {
            position: relative;
            z-index: 2;
        }

        .admin-header h1 {
            font-weight: 700;
            font-size: 2.2rem;
            margin-bottom: 0.5rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .admin-header p {
            opacity: 0.85;
            font-size: 1.1rem;
        }

        /* ===== ç»Ÿè®¡å¡ç‰‡ ===== */
        .stats-cards {
            padding: 2rem;
            margin-bottom: 1rem;
        }

        .stat-card {
            background: linear-gradient(135deg, #fff 0%, #f8f9ff 100%);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: var(--shadow-medium);
            transition: var(--transition);
            height: 100%;
            border: 1px solid rgba(102, 126, 234, 0.1);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--success-gradient);
        }

        .stat-card:hover {
            transform: translateY(-10px) scale(1.02);
            box-shadow: 0 20px 40px rgba(86, 171, 47, 0.2);
        }

        .stat-card .fa-2x {
            background: var(--success-gradient);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
            margin-bottom: 0.5rem;
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 800;
            margin: 0.5rem 0;
            background: var(--success-gradient);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #6c757d;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* ===== ç­›é€‰åŒºåŸŸ ===== */
        .filter-section {
            background: linear-gradient(135deg, #fff 0%, #f8f9ff 100%);
            padding: 2rem;
            margin: 0 2rem 2rem;
            border-radius: 20px;
            box-shadow: var(--shadow-medium);
            border: 1px solid rgba(102, 126, 234, 0.1);
        }

        /* ===== æ‰¹é‡æ“ä½œæ  ===== */
        .batch-actions-bar {
            background: var(--success-gradient);
            color: white;
            padding: 1.5rem 2rem;
            margin: 0 2rem 2rem;
            border-radius: 20px;
            display: none;
            box-shadow: var(--shadow-medium);
            position: relative;
            overflow: hidden;
        }

        .batch-actions-bar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 10px,
                rgba(255,255,255,0.05) 10px,
                rgba(255,255,255,0.05) 20px
            );
        }

        .batch-actions-bar .row {
            position: relative;
            z-index: 1;
        }

        /* ===== è¡¨æ ¼å®¹å™¨ ===== */
        .table-container {
            background: linear-gradient(135deg, #fff 0%, #f8f9ff 100%);
            border-radius: 20px;
            margin: 0 2rem 2rem;
            overflow: hidden;
            box-shadow: var(--shadow-medium);
            border: 1px solid rgba(102, 126, 234, 0.1);
        }

        .table {
            margin: 0;
        }

        .table thead {
            background: var(--success-gradient);
            color: white;
        }

        .table th {
            border: none;
            padding: 1.2rem 1rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 0.85rem;
        }

        .table td {
            border: none;
            padding: 1rem;
            vertical-align: middle;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        .table tbody tr {
            transition: var(--transition);
        }

        .table tbody tr:hover {
            background: rgba(86, 171, 47, 0.05);
            transform: scale(1.01);
        }

        .selected-row {
            background: rgba(86, 171, 47, 0.15) !important;
            border-left: 4px solid #56ab2f;
        }

        /* ===== ç”¨æˆ·å¤´åƒ ===== */
        .user-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--success-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.4rem;
            box-shadow: var(--shadow-light);
            transition: var(--transition);
            border: 3px solid rgba(255, 255, 255, 0.8);
        }

        .user-avatar:hover {
            transform: scale(1.1) rotate(5deg);
            box-shadow: var(--shadow-medium);
        }

        /* ===== è§’è‰²å¾½ç«  ===== */
        .role-badge {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
        }

        .role-user { 
            background: linear-gradient(135deg, #e3f2fd, #bbdefb); 
            color: #1565c0; 
        }

        .role-moderator { 
            background: linear-gradient(135deg, #fff3e0, #ffcc80); 
            color: #e65100; 
        }

        .role-admin { 
            background: linear-gradient(135deg, #ffebee, #ffcdd2); 
            color: #c62828; 
        }

        /* ===== æ´»è·ƒåº¦æŒ‡ç¤ºå™¨ ===== */
        .activity-indicator {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 0.5rem;
            box-shadow: 0 0 10px currentColor;
            animation: pulse 2s infinite;
        }

        .activity-today { 
            background: #4caf50; 
            box-shadow: 0 0 10px #4caf50;
        }

        .activity-week { 
            background: #ff9800; 
            box-shadow: 0 0 10px #ff9800;
        }

        .activity-month { 
            background: #2196f3; 
            box-shadow: 0 0 10px #2196f3;
        }

        .activity-older { 
            background: #9e9e9e; 
            box-shadow: 0 0 10px #9e9e9e;
        }

        .activity-never { 
            background: #f44336; 
            box-shadow: 0 0 10px #f44336;
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* ===== ç»Ÿè®¡è¿·ä½ å¡ç‰‡ ===== */
        .stats-mini {
            font-size: 0.75rem;
            color: #6c757d;
            background: rgba(0,0,0,0.03);
            padding: 0.3rem 0.6rem;
            border-radius: 10px;
            margin-top: 0.3rem;
        }

        /* ===== æŒ‰é’®æ ·å¼ ===== */
        .btn {
            border-radius: 12px;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            transition: var(--transition);
            border: none;
            position: relative;
            overflow: hidden;
            font-size: 0.95rem;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn-primary {
            background: var(--primary-gradient);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: var(--success-gradient);
            box-shadow: 0 4px 15px rgba(86, 171, 47, 0.3);
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(86, 171, 47, 0.4);
        }

        .btn-info {
            background: var(--info-gradient);
            box-shadow: 0 4px 15px rgba(79, 172, 254, 0.3);
        }

        .btn-warning {
            background: var(--warning-gradient);
            box-shadow: 0 4px 15px rgba(240, 147, 251, 0.3);
        }

        .btn-danger {
            background: var(--danger-gradient);
            box-shadow: 0 4px 15px rgba(255, 65, 108, 0.3);
        }

        .btn-light {
            background: rgba(255,255,255,0.9);
            color: #2c3e50;
            backdrop-filter: blur(10px);
        }

        .btn-outline-light {
            border: 2px solid rgba(255,255,255,0.8);
            color: white;
            background: transparent;
        }

        .btn-outline-light:hover {
            background: rgba(255,255,255,0.2);
            color: white;
        }

        .btn-group-vertical .btn {
            margin-bottom: 0.3rem;
            border-radius: 8px;
            padding: 0.4rem 0.8rem;
            font-size: 0.8rem;
        }

        /* ===== è¡¨å•æ§ä»¶ ===== */
        .form-control, .form-select {
            border-radius: 12px;
            border: 2px solid rgba(0,0,0,0.1);
            padding: 0.75rem 1rem;
            transition: var(--transition);
            background: rgba(255,255,255,0.9);
            font-size: 0.95rem;
        }

        .form-control:focus, .form-select:focus {
            border-color: #56ab2f;
            box-shadow: 0 0 0 0.2rem rgba(86, 171, 47, 0.25);
            background: white;
        }

        .form-label {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }

        /* ===== åˆ†é¡µ ===== */
        .pagination {
            margin: 0;
        }

        .page-link {
            border: none;
            color: #56ab2f;
            padding: 0.75rem 1rem;
            margin: 0 0.2rem;
            border-radius: 12px;
            transition: var(--transition);
            font-weight: 600;
        }

        .page-link:hover {
            background: var(--success-gradient);
            color: white;
            transform: translateY(-2px);
        }

        .page-item.active .page-link {
            background: var(--success-gradient);
            color: white;
            box-shadow: var(--shadow-light);
        }

        /* ===== æ¨¡æ€æ¡† ===== */
        .modal-content {
            border-radius: 20px;
            border: none;
            box-shadow: var(--shadow-heavy);
            overflow: hidden;
        }

        .modal-header {
            background: var(--success-gradient);
            color: white;
            border: none;
            padding: 1.5rem 2rem;
        }

        .modal-body {
            padding: 2rem;
        }

        .modal-footer {
            border: none;
            padding: 1.5rem 2rem;
            background: rgba(0,0,0,0.02);
        }

        .btn-close-white {
            filter: brightness(0) invert(1);
        }

        /* ===== åŠ è½½é®ç½© ===== */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            display: none;
            backdrop-filter: blur(10px);
        }

        .loading-content {
            background: white;
            padding: 3rem;
            border-radius: 20px;
            text-align: center;
            box-shadow: var(--shadow-heavy);
            animation: loadingPulse 2s ease-in-out infinite;
        }

        @keyframes loadingPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* ===== é€šçŸ¥æ ·å¼ ===== */
        .alert {
            border-radius: var(--border-radius);
            border: none;
            padding: 1rem 1.5rem;
            font-weight: 500;
            box-shadow: var(--shadow-light);
        }

        .alert-success {
            background: linear-gradient(135deg, #d4edda, #a8e6cf);
            color: #155724;
        }

        .alert-danger {
            background: linear-gradient(135deg, #f8d7da, #fab1a0);
            color: #721c24;
        }

        .alert-info {
            background: linear-gradient(135deg, #cce7ff, #a8d8ea);
            color: #0c5460;
        }

        .alert-warning {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
            color: #856404;
        }

        /* ===== å›¾è¡¨å®¹å™¨ ===== */
        .chart-container {
            background: white;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--shadow-light);
            margin-bottom: 1rem;
        }

        /* ===== å¾½ç« æ ·å¼ ===== */
        .badge {
            border-radius: 20px;
            padding: 0.5rem 1rem;
            font-weight: 600;
        }

        .badge.bg-success {
            background: var(--success-gradient) !important;
        }

        .badge.bg-danger {
            background: var(--danger-gradient) !important;
        }

        .badge.bg-primary {
            background: var(--primary-gradient) !important;
        }

        .badge.bg-warning {
            background: var(--warning-gradient) !important;
        }

        .badge.bg-info {
            background: var(--info-gradient) !important;
        }

        /* ===== å“åº”å¼è®¾è®¡ ===== */
        @media (max-width: 768px) {
            .main-container {
                margin: 10px;
                border-radius: 20px;
            }
            
            .admin-header {
                padding: 2rem 1.5rem;
            }
            
            .admin-header h1 {
                font-size: 1.8rem;
            }
            
            .stats-cards, .filter-section, .batch-actions-bar, .table-container {
                margin-left: 1rem;
                margin-right: 1rem;
                padding: 1.5rem;
            }
            
            .stat-card {
                padding: 1.5rem;
                margin-bottom: 1rem;
            }
            
            .stat-number {
                font-size: 2rem;
            }
            
            .table-responsive {
                font-size: 0.875rem;
            }
            
            .user-avatar {
                width: 40px;
                height: 40px;
                font-size: 1rem;
            }
        }

        /* ===== æ»šåŠ¨æ¡æ ·å¼ ===== */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.1);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--success-gradient);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #4a8c2a, #7bc96f);
        }

        /* ===== åŠ¨ç”»å¢å¼º ===== */
        .animate-fade-in {
            animation: fadeIn 0.6s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .animate-slide-up {
            animation: slideUp 0.5s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ===== ç‰¹æ®Šæ•ˆæœ ===== */
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .glow-effect {
            box-shadow: 0 0 20px rgba(86, 171, 47, 0.3);
        }

        .pulse-animation {
            animation: pulse 2s infinite;
        }

        /* ===== å·¥å…·æç¤º ===== */
        [data-tooltip] {
            position: relative;
            cursor: help;
        }

        [data-tooltip]::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.8rem;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        [data-tooltip]:hover::after {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(-5px);
        }
    </style>
</head>
<body>
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    {% include "components/admin_nav.html" %}

    <div class="main-container animate-fade-in">
        <!-- é¡µé¢æ ‡é¢˜ -->
        <div class="admin-header">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1>
                        <i class="fas fa-users me-3"></i>ç”¨æˆ·ç®¡ç†ä¸­å¿ƒ
                    </h1>
                    <p class="mb-0">æ™ºèƒ½ç®¡ç†ç³»ç»Ÿç”¨æˆ·å’Œæƒé™ Â· æ‰¹é‡æ“ä½œ Â· æ•°æ®åˆ†æ Â· ç”¨æˆ·æ´å¯Ÿ</p>
                </div>
                <div class="col-md-4 text-end">
                    <div class="btn-group" role="group">
                        <button class="btn btn-light" onclick="showCreateUserModal()" data-tooltip="åˆ›å»ºæ–°ç”¨æˆ·">
                            <i class="fas fa-user-plus me-2"></i>åˆ›å»ºç”¨æˆ·
                        </button>
                        <button class="btn btn-light" onclick="refreshData()" data-tooltip="åˆ·æ–°æ‰€æœ‰æ•°æ®">
                            <i class="fas fa-sync-alt me-2"></i>åˆ·æ–°æ•°æ®
                        </button>
                        <button class="btn btn-light" onclick="showAnalytics()" data-tooltip="æŸ¥çœ‹ç”¨æˆ·åˆ†æ">
                            <i class="fas fa-chart-bar me-2"></i>ç”¨æˆ·åˆ†æ
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç»Ÿè®¡å¡ç‰‡ -->
        <div class="stats-cards">
            <div class="row">
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="stat-card animate-slide-up">
                        <div class="d-flex align-items-center justify-content-between">
                            <div>
                                <div class="stat-label">æ€»ç”¨æˆ·æ•°</div>
                                <div class="stat-number" id="totalUsers">-</div>
                                <div class="small text-muted">
                                    <i class="fas fa-database me-1"></i>
                                    ç³»ç»Ÿæ³¨å†Œç”¨æˆ·
                                </div>
                            </div>
                            <div>
                                <i class="fas fa-users fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="stat-card animate-slide-up" style="animation-delay: 0.1s;">
                        <div class="d-flex align-items-center justify-content-between">
                            <div>
                                <div class="stat-label">æ´»è·ƒç”¨æˆ·</div>
                                <div class="stat-number" id="activeUsers">-</div>
                                <div class="small text-success">
                                    <i class="fas fa-user-check me-1"></i>
                                    è´¦æˆ·æ­£å¸¸
                                </div>
                            </div>
                            <div>
                                <i class="fas fa-user-check fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="stat-card animate-slide-up" style="animation-delay: 0.2s;">
                        <div class="d-flex align-items-center justify-content-between">
                            <div>
                                <div class="stat-label">ä»Šæ—¥æ´»è·ƒ</div>
                                <div class="stat-number" id="todayActive">-</div>
                                <div class="small text-warning">
                                    <i class="fas fa-clock me-1"></i>
                                    ä»Šå¤©ç™»å½•
                                </div>
                            </div>
                            <div>
                                <i class="fas fa-clock fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="stat-card animate-slide-up" style="animation-delay: 0.3s;">
                        <div class="d-flex align-items-center justify-content-between">
                            <div>
                                <div class="stat-label">ç®¡ç†å‘˜</div>
                                <div class="stat-number" id="adminUsers">-</div>
                                <div class="small text-danger">
                                    <i class="fas fa-user-shield me-1"></i>
                                    é«˜æƒé™ç”¨æˆ·
                                </div>
                            </div>
                            <div>
                                <i class="fas fa-user-shield fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç­›é€‰å’Œæœç´¢ -->
        <div class="filter-section">
            <div class="row align-items-end">
                <div class="col-md-2">
                    <label class="form-label">
                        <i class="fas fa-user-tag me-1"></i>è§’è‰²ç­›é€‰
                    </label>
                    <select class="form-select" id="roleFilter" onchange="loadUsers()">
                        <option value="">ğŸ”„ å…¨éƒ¨è§’è‰²</option>
                        <option value="user">ğŸ‘¤ æ™®é€šç”¨æˆ·</option>
                        <option value="moderator">ğŸ‘® ç‰ˆä¸»</option>
                        <option value="admin">ğŸ‘‘ ç®¡ç†å‘˜</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">
                        <i class="fas fa-toggle-on me-1"></i>çŠ¶æ€ç­›é€‰
                    </label>
                    <select class="form-select" id="statusFilter" onchange="loadUsers()">
                        <option value="">ğŸ“‹ å…¨éƒ¨çŠ¶æ€</option>
                        <option value="active">âœ… æ´»è·ƒ</option>
                        <option value="inactive">âŒ ç¦ç”¨</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">
                        <i class="fas fa-certificate me-1"></i>éªŒè¯çŠ¶æ€
                    </label>
                    <select class="form-select" id="verifiedFilter" onchange="loadUsers()">
                        <option value="">ğŸ”„ å…¨éƒ¨</option>
                        <option value="true">âœ… å·²éªŒè¯</option>
                        <option value="false">â³ æœªéªŒè¯</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">
                        <i class="fas fa-search me-1"></i>æ™ºèƒ½æœç´¢
                    </label>
                    <input type="text" class="form-control" id="searchInput" 
                           placeholder="æœç´¢ç”¨æˆ·åã€é‚®ç®±ã€çœŸå®å§“å..." onkeyup="searchUsers(event)">
                </div>
                <div class="col-md-3">
                    <label class="form-label">
                        <i class="fas fa-tools me-1"></i>å¿«é€Ÿæ“ä½œ
                    </label>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-primary" onclick="toggleBatchActions()" data-tooltip="æ‰¹é‡ç®¡ç†ç”¨æˆ·">
                            <i class="fas fa-tasks me-1"></i>æ‰¹é‡æ“ä½œ
                        </button>
                        <button class="btn btn-outline-success" onclick="exportData()" data-tooltip="å¯¼å‡ºç”¨æˆ·æ•°æ®">
                            <i class="fas fa-download me-1"></i>å¯¼å‡º
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ‰¹é‡æ“ä½œæ  -->
        <div class="batch-actions-bar" id="batchActionsBar">
            <div class="row align-items-center">
                <div class="col-md-2">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                        <label class="form-check-label text-white fw-bold">
                            <i class="fas fa-check-square me-1"></i>å…¨é€‰
                        </label>
                    </div>
                </div>
                <div class="col-md-8">
                    <div class="d-flex align-items-center gap-2 flex-wrap">
                        <div class="btn-group" role="group">
                            <button class="btn btn-outline-light btn-sm" onclick="batchAction('activate')" data-tooltip="æ¿€æ´»é€‰ä¸­ç”¨æˆ·">
                                <i class="fas fa-check me-1"></i>æ¿€æ´»
                            </button>
                            <button class="btn btn-outline-light btn-sm" onclick="batchAction('deactivate')" data-tooltip="ç¦ç”¨é€‰ä¸­ç”¨æˆ·">
                                <i class="fas fa-ban me-1"></i>ç¦ç”¨
                            </button>
                            <button class="btn btn-outline-light btn-sm" onclick="batchAction('verify')" data-tooltip="éªŒè¯é€‰ä¸­ç”¨æˆ·">
                                <i class="fas fa-certificate me-1"></i>éªŒè¯
                            </button>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            <select class="form-select form-select-sm text-dark" id="batchRoleSelect" style="width: auto;">
                                <option value="">æ‰¹é‡è®¾ç½®è§’è‰²</option>
                                <option value="user">ğŸ‘¤ æ™®é€šç”¨æˆ·</option>
                                <option value="moderator">ğŸ‘® ç‰ˆä¸»</option>
                                <option value="admin">ğŸ‘‘ ç®¡ç†å‘˜</option>
                            </select>
                            <button class="btn btn-outline-light btn-sm" onclick="batchChangeRole()" data-tooltip="åº”ç”¨é€‰ä¸­è§’è‰²">
                                <i class="fas fa-user-cog me-1"></i>åº”ç”¨è§’è‰²
                            </button>
                        </div>
                    </div>
                </div>
                <div class="col-md-2 text-end">
                    <span id="selectedCount" class="text-white fw-bold">
                        <i class="fas fa-check-circle me-1"></i>å·²é€‰æ‹© 0 é¡¹
                    </span>
                </div>
            </div>
        </div>

        <!-- ç”¨æˆ·åˆ—è¡¨ -->
        <div class="table-container">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th width="50" class="select-column" style="display: none;">
                                <input type="checkbox" id="selectAllHeader" onchange="toggleSelectAll()">
                            </th>
                            <th width="100">
                                <i class="fas fa-user-circle me-1"></i>å¤´åƒ
                            </th>
                            <th>
                                <i class="fas fa-id-card me-1"></i>ç”¨æˆ·ä¿¡æ¯
                            </th>
                            <th>
                                <i class="fas fa-user-tag me-1"></i>è§’è‰²
                            </th>
                            <th>
                                <i class="fas fa-toggle-on me-1"></i>çŠ¶æ€
                            </th>
                            <th>
                                <i class="fas fa-chart-pulse me-1"></i>æ´»è·ƒåº¦
                            </th>
                            <th>
                                <i class="fas fa-chart-bar me-1"></i>ç»Ÿè®¡
                            </th>
                            <th>
                                <i class="fas fa-calendar me-1"></i>æ³¨å†Œæ—¶é—´
                            </th>
                            <th width="150">
                                <i class="fas fa-cogs me-1"></i>æ“ä½œ
                            </th>
                        </tr>
                    </thead>
                    <tbody id="userTableBody">
                        <tr>
                            <td colspan="9" class="text-center py-5">
                                <div class="spinner-border text-primary pulse-animation" role="status" style="width: 3rem; height: 3rem;">
                                    <span class="visually-hidden">åŠ è½½ä¸­...</span>
                                </div>
                                <p class="mt-3 text-muted fw-semibold">æ­£åœ¨åŠ è½½ç”¨æˆ·æ•°æ®...</p>
                                <small class="text-muted">è¯·ç¨å€™ï¼Œç³»ç»Ÿæ­£åœ¨å¤„ç†æ‚¨çš„è¯·æ±‚</small>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- åˆ†é¡µ -->
            <div class="d-flex justify-content-between align-items-center p-3 border-top bg-light">
                <div>
                    <span class="text-muted fw-semibold" id="pageInfo">
                        <i class="fas fa-info-circle me-1"></i>æ˜¾ç¤º 0 - 0 æ¡ï¼Œå…± 0 æ¡è®°å½•
                    </span>
                </div>
                <nav>
                    <ul class="pagination mb-0" id="pagination">
                        <!-- åˆ†é¡µæŒ‰é’®å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                    </ul>
                </nav>
            </div>
        </div>
    </div>

    <!-- åŠ è½½é®ç½© -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
                <span class="visually-hidden">åŠ è½½ä¸­...</span>
            </div>
            <h5 id="loadingText">ç³»ç»Ÿå¤„ç†ä¸­...</h5>
            <p class="text-muted mb-0">è¯·ç¨å€™ï¼Œæ­£åœ¨æ‰§è¡Œæ“ä½œ</p>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let currentPage = 1;
        let totalPages = 1;
        let selectedUsers = new Set();
        let batchActionsVisible = false;
        let currentData = null;

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            loadStats();
            loadUsers();
            
            // è®¾ç½®è‡ªåŠ¨åˆ·æ–°
            setInterval(loadStats, 60000); // 1åˆ†é’Ÿåˆ·æ–°ç»Ÿè®¡
        });

        // æ£€æŸ¥ç”¨æˆ·æƒé™
        async function checkAuth() {
            try {
                const response = await fetch('/api/auth/check');
                const data = await response.json();
                
                if (!data.authenticated) {
                    window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname);
                    return;
                }
                
                if (data.user.role !== 'admin' && data.user.role !== 'moderator') {
                    showError('æ‚¨æ²¡æœ‰ç®¡ç†å‘˜æƒé™è®¿é—®æ­¤é¡µé¢');
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 2000);
                    return;
                }
            } catch (error) {
                console.error('æƒé™æ£€æŸ¥å¤±è´¥:', error);
                showError('æƒé™éªŒè¯å¤±è´¥ï¼Œè¯·é‡æ–°ç™»å½•');
                setTimeout(() => {
                    window.location.href = '/login';
                }, 2000);
            }
        }

        // åŠ è½½ç»Ÿè®¡æ•°æ®
        async function loadStats() {
            try {
                const response = await fetch('/api/admin/stats');
                const data = await response.json();
                
                if (data.success) {
                    // ä½¿ç”¨åŠ¨ç”»æ•ˆæœæ›´æ–°æ•°å­—
                    animateNumber('totalUsers', data.data.overview.total_users || 0);
                    animateNumber('activeUsers', data.data.overview.active_users || 0);
                    animateNumber('todayActive', data.data.today.active_users || 0);
                    animateNumber('adminUsers', data.data.overview.admin_users || 0);
                }
            } catch (error) {
                console.error('åŠ è½½ç»Ÿè®¡å¤±è´¥:', error);
            }
        }

        // æ•°å­—åŠ¨ç”»æ•ˆæœ
        function animateNumber(elementId, targetValue) {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            const currentValue = parseInt(element.textContent.replace(/[^\d]/g, '')) || 0;
            const difference = targetValue - currentValue;
            const duration = 1500;
            const steps = 30;
            const stepValue = difference / steps;
            
            let currentStep = 0;
            const timer = setInterval(() => {
                currentStep++;
                const newValue = Math.round(currentValue + (stepValue * currentStep));
                element.textContent = formatNumber(newValue);
                
                if (currentStep >= steps) {
                    element.textContent = formatNumber(targetValue);
                    clearInterval(timer);
                }
            }, duration / steps);
        }

        function formatNumber(num) {
            if (num >= 1000000) {
                return (num / 1000000).toFixed(1) + 'M';
            } else if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'K';
            }
            return num.toString();
        }

        // åŠ è½½ç”¨æˆ·åˆ—è¡¨
        async function loadUsers(page = 1) {
            try {
                const role = document.getElementById('roleFilter').value;
                const status = document.getElementById('statusFilter').value;
                const verified = document.getElementById('verifiedFilter').value;
                const search = document.getElementById('searchInput').value;
                
                const params = new URLSearchParams({
                    page: page,
                    per_page: 20,
                    sort_by: 'created_at',
                    sort_order: 'desc'
                });
                
                if (role) params.append('role', role);
                if (status) params.append('status', status);
                if (verified) params.append('verified', verified);
                if (search) params.append('search', search);
                
                const response = await fetch(`/api/admin/users/list?${params}`);
                const data = await response.json();
                
                if (data.success) {
                    currentData = data.data;
                    displayUsers(data.data.users);
                    updatePagination(data.data.pagination);
                    currentPage = page;
                    totalPages = data.data.pagination.pages;
                } else {
                    showError('åŠ è½½ç”¨æˆ·åˆ—è¡¨å¤±è´¥');
                }
            } catch (error) {
                console.error('åŠ è½½ç”¨æˆ·å¤±è´¥:', error);
                showError('ç½‘ç»œé”™è¯¯');
            }
        }

        // æ˜¾ç¤ºç”¨æˆ·åˆ—è¡¨
        function displayUsers(users) {
            const tbody = document.getElementById('userTableBody');
            
            if (users.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="text-center py-5">
                            <div class="mb-4">
                                <i class="fas fa-users fa-4x text-muted opacity-50"></i>
                            </div>
                            <h5 class="text-muted">æ²¡æœ‰æ‰¾åˆ°ç”¨æˆ·</h5>
                            <p class="text-muted">è¯·å°è¯•è°ƒæ•´ç­›é€‰æ¡ä»¶æˆ–æœç´¢å…³é”®è¯</p>
                            <button class="btn btn-primary" onclick="loadUsers(1)">
                                <i class="fas fa-refresh me-1"></i>é‡æ–°åŠ è½½
                            </button>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = users.map(user => {
                const isSelected = selectedUsers.has(user.id);
                const activityClass = getActivityClass(user.last_login);
                const activityText = getActivityText(user.last_login);
                
                return `
                    <tr id="row_${user.id}" class="${isSelected ? 'selected-row' : ''}">
                        <td class="select-column" style="display: ${batchActionsVisible ? 'table-cell' : 'none'};">
                            <input type="checkbox" class="form-check-input user-checkbox" 
                                   value="${user.id}" onchange="toggleUserSelection(${user.id})"
                                   ${isSelected ? 'checked' : ''}>
                        </td>
                        <td>
                            <div class="user-avatar" title="${user.full_name || user.username}" data-tooltip="ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…" onclick="viewUserDetails(${user.id})">
                                ${(user.full_name || user.username).charAt(0).toUpperCase()}
                            </div>
                        </td>
                        <td>
                            <div class="fw-bold mb-1">
                                <i class="fas fa-user me-1 text-primary"></i>
                                ${user.username}
                            </div>
                            <div class="text-muted small mb-1">
                                <i class="fas fa-envelope me-1"></i>
                                ${user.email}
                            </div>
                            ${user.full_name ? `
                            <div class="text-secondary small">
                                <i class="fas fa-id-badge me-1"></i>
                                ${user.full_name}
                            </div>
                            ` : ''}
                        </td>
                        <td>
                            <span class="role-badge role-${user.role}">
                                ${getRoleIcon(user.role)} ${getRoleText(user.role)}
                            </span>
                        </td>
                        <td>
                            <div class="d-flex flex-column gap-1">
                                <span class="badge bg-${user.is_active ? 'success' : 'danger'}">
                                    ${user.is_active ? 'âœ… æ´»è·ƒ' : 'âŒ ç¦ç”¨'}
                                </span>
                                <span class="badge bg-${user.is_verified ? 'info' : 'secondary'}">
                                    ${user.is_verified ? 'ğŸ“§ å·²éªŒè¯' : 'â³ æœªéªŒè¯'}
                                </span>
                            </div>
                        </td>
                        <td>
                            <div class="d-flex align-items-center mb-2">
                                <div class="activity-indicator activity-${activityClass}"></div>
                                <small class="fw-semibold">${activityText}</small>
                            </div>
                            <div class="stats-mini">
                                <i class="fas fa-images me-1"></i>
                                æœ€è¿‘: ${user.stats?.recent_uploads || 0} å¼ 
                            </div>
                        </td>
                        <td>
                            <div class="stats-mini">
                                <div class="mb-1">
                                    <i class="fas fa-upload me-1"></i>
                                    ä¸Šä¼ : <span class="fw-bold">${user.stats?.total_uploads || 0}</span> å¼ 
                                </div>
                                <div class="mb-1">
                                    <i class="fas fa-hdd me-1"></i>
                                    å¤§å°: ${formatFileSize(user.stats?.total_size || 0)}
                                </div>
                                <div>
                                    <i class="fas fa-percentage me-1"></i>
                                    ç½®ä¿¡åº¦: ${user.stats?.avg_confidence || 0}%
                                </div>
                            </div>
                        </td>
                        <td>
                            <div class="small">
                                <i class="fas fa-calendar-plus me-1 text-success"></i>
                                ${formatDate(user.created_at)}
                            </div>
                        </td>
                        <td>
                            <div class="btn-group-vertical">
                                <button class="btn btn-outline-primary btn-sm" onclick="viewUserDetails(${user.id})" 
                                        data-tooltip="æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯">
                                    <i class="fas fa-info-circle me-1"></i>è¯¦æƒ…
                                </button>
                                <button class="btn btn-outline-success btn-sm" onclick="editUser(${user.id})" 
                                        data-tooltip="ç¼–è¾‘ç”¨æˆ·ä¿¡æ¯">
                                    <i class="fas fa-edit me-1"></i>ç¼–è¾‘
                                </button>
                                <button class="btn btn-outline-warning btn-sm" onclick="showUserActions(${user.id})" 
                                        data-tooltip="æ›´å¤šæ“ä½œ">
                                    <i class="fas fa-ellipsis-v me-1"></i>æ›´å¤š
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // æ›´æ–°åˆ†é¡µ
        function updatePagination(pagination) {
            const paginationEl = document.getElementById('pagination');
            const pageInfo = document.getElementById('pageInfo');
            
            // æ›´æ–°é¡µé¢ä¿¡æ¯
            const start = (pagination.page - 1) * pagination.per_page + 1;
            const end = Math.min(pagination.page * pagination.per_page, pagination.total);
            pageInfo.innerHTML = `
                <i class="fas fa-info-circle me-1"></i>
                æ˜¾ç¤º <span class="fw-bold">${start}</span> - <span class="fw-bold">${end}</span> æ¡ï¼Œ
                å…± <span class="fw-bold text-success">${pagination.total}</span> æ¡è®°å½•
            `;
            
            // ç”Ÿæˆåˆ†é¡µæŒ‰é’®
            let paginationHtml = '';
            
            // ä¸Šä¸€é¡µ
            if (pagination.page > 1) {
                paginationHtml += `
                    <li class="page-item">
                        <a class="page-link" href="#" onclick="loadUsers(${pagination.page - 1})">
                            <i class="fas fa-chevron-left me-1"></i>ä¸Šä¸€é¡µ
                        </a>
                    </li>
                `;
            }
            
            // é¡µç 
            const startPage = Math.max(1, pagination.page - 2);
            const endPage = Math.min(pagination.pages, pagination.page + 2);
            
            for (let i = startPage; i <= endPage; i++) {
                paginationHtml += `
                    <li class="page-item ${i === pagination.page ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="loadUsers(${i})">${i}</a>
                    </li>
                `;
            }
            
            // ä¸‹ä¸€é¡µ
            if (pagination.page < pagination.pages) {
                paginationHtml += `
                    <li class="page-item">
                        <a class="page-link" href="#" onclick="loadUsers(${pagination.page + 1})">
                            ä¸‹ä¸€é¡µ<i class="fas fa-chevron-right ms-1"></i>
                        </a>
                    </li>
                `;
            }
            
            paginationEl.innerHTML = paginationHtml;
        }

        // æœç´¢åŠŸèƒ½
        function searchUsers(event) {
            if (event.key === 'Enter') {
                loadUsers(1);
            }
        }

        // æ‰¹é‡æ“ä½œåŠŸèƒ½
        function toggleBatchActions() {
            batchActionsVisible = !batchActionsVisible;
            const batchBar = document.getElementById('batchActionsBar');
            const selectColumns = document.querySelectorAll('.select-column');
            
            if (batchActionsVisible) {
                batchBar.style.display = 'block';
                selectColumns.forEach(col => col.style.display = 'table-cell');
                showInfo('æ‰¹é‡æ“ä½œæ¨¡å¼å·²å¯ç”¨ï¼Œè¯·é€‰æ‹©è¦æ“ä½œçš„ç”¨æˆ·');
            } else {
                batchBar.style.display = 'none';
                selectColumns.forEach(col => col.style.display = 'none');
                selectedUsers.clear();
                updateSelectedCount();
                clearSelections();
                showInfo('æ‰¹é‡æ“ä½œæ¨¡å¼å·²å…³é—­');
            }
        }

        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('selectAll') || document.getElementById('selectAllHeader');
            const checkboxes = document.querySelectorAll('.user-checkbox');
            
            if (selectAllCheckbox.checked) {
                checkboxes.forEach(checkbox => {
                    const userId = parseInt(checkbox.value);
                    selectedUsers.add(userId);
                    checkbox.checked = true;
                    document.getElementById(`row_${userId}`).classList.add('selected-row');
                });
            } else {
                selectedUsers.clear();
                checkboxes.forEach(checkbox => {
                    const userId = parseInt(checkbox.value);
                    checkbox.checked = false;
                    document.getElementById(`row_${userId}`).classList.remove('selected-row');
                });
            }
            
            updateSelectedCount();
        }

        function toggleUserSelection(userId) {
            const checkbox = document.querySelector(`input[value="${userId}"]`);
            const row = document.getElementById(`row_${userId}`);
            
            if (selectedUsers.has(userId)) {
                selectedUsers.delete(userId);
                row.classList.remove('selected-row');
            } else {
                selectedUsers.add(userId);
                row.classList.add('selected-row');
            }
            
            updateSelectedCount();
        }

        function updateSelectedCount() {
            const countElement = document.getElementById('selectedCount');
            if (countElement) {
                countElement.innerHTML = `
                    <i class="fas fa-check-circle me-1"></i>
                    å·²é€‰æ‹© <span class="badge bg-light text-dark">${selectedUsers.size}</span> é¡¹
                `;
            }
        }

        function clearSelections() {
            document.querySelectorAll('.user-checkbox').forEach(checkbox => {
                checkbox.checked = false;
            });
            document.querySelectorAll('.selected-row').forEach(row => {
                row.classList.remove('selected-row');
            });
        }

        // æ‰¹é‡æ“ä½œæ‰§è¡Œ
        async function batchAction(action) {
            if (selectedUsers.size === 0) {
                showError('è¯·å…ˆé€‰æ‹©è¦æ“ä½œçš„ç”¨æˆ·');
                return;
            }
            
            let confirmMessage = '';
            
            switch (action) {
                case 'activate':
                    confirmMessage = `ç¡®å®šè¦æ¿€æ´»é€‰ä¸­çš„ ${selectedUsers.size} ä¸ªç”¨æˆ·å—ï¼Ÿ`;
                    break;
                case 'deactivate':
                    confirmMessage = `ç¡®å®šè¦ç¦ç”¨é€‰ä¸­çš„ ${selectedUsers.size} ä¸ªç”¨æˆ·å—ï¼Ÿ`;
                    break;
                case 'verify':
                    confirmMessage = `ç¡®å®šè¦éªŒè¯é€‰ä¸­çš„ ${selectedUsers.size} ä¸ªç”¨æˆ·çš„é‚®ç®±å—ï¼Ÿ`;
                    break;
                default:
                    return;
            }
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            try {
                showLoading('æ­£åœ¨æ‰§è¡Œæ‰¹é‡æ“ä½œ...');
                
                const response = await fetch('/api/admin/users/batch-update', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_ids: Array.from(selectedUsers),
                        action: action
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showSuccess(`âœ… æ‰¹é‡æ“ä½œæˆåŠŸï¼š${result.message}`);
                    selectedUsers.clear();
                    loadUsers(currentPage);
                    loadStats();
                    toggleBatchActions();
                } else {
                    showError(`æ‰¹é‡æ“ä½œå¤±è´¥ï¼š${result.detail || 'æœªçŸ¥é”™è¯¯'}`);
                }
            } catch (error) {
                console.error('æ‰¹é‡æ“ä½œå¤±è´¥:', error);
                showError('ç½‘ç»œé”™è¯¯ï¼š' + error.message);
            } finally {
                hideLoading();
            }
        }

        async function batchChangeRole() {
            const newRole = document.getElementById('batchRoleSelect').value;
            
            if (!newRole) {
                showError('è¯·é€‰æ‹©è¦è®¾ç½®çš„è§’è‰²');
                return;
            }
            
            if (selectedUsers.size === 0) {
                showError('è¯·å…ˆé€‰æ‹©è¦æ“ä½œçš„ç”¨æˆ·');
                return;
            }
            
            if (!confirm(`ğŸ”„ ç¡®å®šè¦å°†é€‰ä¸­çš„ ${selectedUsers.size} ä¸ªç”¨æˆ·è®¾ç½®ä¸º ${getRoleText(newRole)} å—ï¼Ÿ\n\næ­¤æ“ä½œä¼šç«‹å³ç”Ÿæ•ˆï¼Œè¯·è°¨æ…æ“ä½œã€‚`)) {
                return;
            }
            
            try {
                showLoading('æ­£åœ¨æ›´æ–°ç”¨æˆ·è§’è‰²...');
                
                const response = await fetch('/api/admin/users/batch-update', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_ids: Array.from(selectedUsers),
                        action: 'change_role',
                        value: newRole
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showSuccess(`âœ… è§’è‰²æ›´æ–°æˆåŠŸï¼š${result.message}`);
                    selectedUsers.clear();
                    loadUsers(currentPage);
                    toggleBatchActions();
                    document.getElementById('batchRoleSelect').value = '';
                } else {
                    showError(`è§’è‰²æ›´æ–°å¤±è´¥ï¼š${result.detail || 'æœªçŸ¥é”™è¯¯'}`);
                }
            } catch (error) {
                console.error('è§’è‰²æ›´æ–°å¤±è´¥:', error);
                showError('ç½‘ç»œé”™è¯¯ï¼š' + error.message);
            } finally {
                hideLoading();
            }
        }

        // ç»§ç»­å®Œæˆå…¶ä½™åŠŸèƒ½...ï¼ˆç”±äºç¯‡å¹…é™åˆ¶ï¼Œè¿™é‡Œå…ˆå±•ç¤ºå‰åŠéƒ¨åˆ†ï¼‰
        // è¾…åŠ©å‡½æ•°
        function getRoleText(role) {
            const roleMap = {
                'user': 'æ™®é€šç”¨æˆ·',
                'moderator': 'ç‰ˆä¸»',
                'admin': 'ç®¡ç†å‘˜'
            };
            return roleMap[role] || role;
        }

        function getRoleIcon(role) {
            const iconMap = {
                'user': 'ğŸ‘¤',
                'moderator': 'ğŸ‘®',
                'admin': 'ğŸ‘‘'
            };
            return iconMap[role] || 'ğŸ‘¤';
        }

        function getActivityClass(lastLogin) {
            if (!lastLogin) return 'never';
            
            const now = new Date();
            const loginDate = new Date(lastLogin);
            const diffMs = now - loginDate;
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            
            if (diffDays === 0) return 'today';
            if (diffDays <= 7) return 'week';
            if (diffDays <= 30) return 'month';
            return 'older';
        }

        function getActivityText(lastLogin) {
            if (!lastLogin) return 'ä»æœªç™»å½•';
            
            const now = new Date();
            const loginDate = new Date(lastLogin);
            const diffMs = now - loginDate;
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            
            if (diffDays === 0) return 'ä»Šå¤©æ´»è·ƒ';
            if (diffDays === 1) return 'æ˜¨å¤©æ´»è·ƒ';
            if (diffDays <= 7) return `${diffDays}å¤©å‰`;
            if (diffDays <= 30) return `${diffDays}å¤©å‰`;
            return `${Math.floor(diffDays / 30)}ä¸ªæœˆå‰`;
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('zh-CN') + ' ' + date.toLocaleTimeString('zh-CN', {hour: '2-digit', minute: '2-digit'});
        }

        function getRankBadgeClass(index) {
            if (index === 0) return 'warning';
            if (index === 1) return 'secondary';
            if (index === 2) return 'dark';
            return 'light';
        }

        // å•ä¸ªç”¨æˆ·æ“ä½œ
        async function viewUserDetails(userId) {
            try {
                showLoading('æ­£åœ¨åŠ è½½ç”¨æˆ·è¯¦æƒ…...');
                
                const response = await fetch(`/api/admin/users/${userId}/details`);
                const result = await response.json();
                
                if (result.success) {
                    showUserDetailsModal(result.data);
                } else {
                    showError('è·å–ç”¨æˆ·è¯¦æƒ…å¤±è´¥');
                }
            } catch (error) {
                console.error('è·å–ç”¨æˆ·è¯¦æƒ…å¤±è´¥:', error);
                showError('ç½‘ç»œé”™è¯¯ï¼š' + error.message);
            } finally {
                hideLoading();
            }
        }

        async function editUser(userId) {
            try {
                showLoading('æ­£åœ¨åŠ è½½ç”¨æˆ·ä¿¡æ¯...');
                const response = await fetch(`/api/admin/users/${userId}/details`);
                const result = await response.json();
                
                if (result.success) {
                    showEditUserModal(result.data.user);
                } else {
                    showError('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥');
                }
            } catch (error) {
                console.error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
                showError('ç½‘ç»œé”™è¯¯ï¼š' + error.message);
            } finally {
                hideLoading();
            }
        }

        function showUserActions(userId) {
            const actionsModalHtml = `
                <div class="modal fade" id="userActionsModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    <i class="fas fa-user-cog me-2"></i>ç”¨æˆ·æ“ä½œä¸­å¿ƒ
                                </h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="d-grid gap-3">
                                    <button class="btn btn-outline-primary" onclick="sendMessageToUser(${userId}); bootstrap.Modal.getInstance(document.getElementById('userActionsModal')).hide();">
                                        <i class="fas fa-envelope me-2"></i>å‘é€æ¶ˆæ¯
                                        <small class="d-block text-muted">å‘ç”¨æˆ·å‘é€ç³»ç»Ÿé€šçŸ¥</small>
                                    </button>
                                    <button class="btn btn-outline-warning" onclick="resetUserPassword(${userId}); bootstrap.Modal.getInstance(document.getElementById('userActionsModal')).hide();">
                                        <i class="fas fa-key me-2"></i>é‡ç½®å¯†ç 
                                        <small class="d-block text-muted">ä¸ºç”¨æˆ·ç”Ÿæˆæ–°å¯†ç </small>
                                    </button>
                                    <button class="btn btn-outline-info" onclick="viewUserImages(${userId}); bootstrap.Modal.getInstance(document.getElementById('userActionsModal')).hide();">
                                        <i class="fas fa-images me-2"></i>æŸ¥çœ‹å›¾ç‰‡
                                        <small class="d-block text-muted">æŸ¥çœ‹ç”¨æˆ·ä¸Šä¼ çš„æ‰€æœ‰å›¾ç‰‡</small>
                                    </button>
                                    <hr class="my-2">
                                    <button class="btn btn-outline-danger" onclick="deleteUser(${userId}); bootstrap.Modal.getInstance(document.getElementById('userActionsModal')).hide();">
                                        <i class="fas fa-trash me-2"></i>åˆ é™¤ç”¨æˆ·
                                        <small class="d-block text-muted">æ°¸ä¹…åˆ é™¤ç”¨æˆ·è´¦æˆ·</small>
                                    </button>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                    <i class="fas fa-times me-1"></i>å–æ¶ˆ
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            removeModal('userActionsModal');
            document.body.insertAdjacentHTML('beforeend', actionsModalHtml);
            
            const modal = new bootstrap.Modal(document.getElementById('userActionsModal'));
            modal.show();
        }

        // æ˜¾ç¤ºç”¨æˆ·è¯¦æƒ…æ¨¡æ€æ¡†
        function showUserDetailsModal(data) {
            const user = data.user;
            const stats = data.image_stats || {};
            
            const modalHtml = `
                <div class="modal fade" id="userDetailsModal" tabindex="-1">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    <i class="fas fa-user me-2"></i>ç”¨æˆ·è¯¦ç»†ä¿¡æ¯
                                </h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="text-center mb-4">
                                            <div class="user-avatar mx-auto mb-3 glow-effect" style="width: 120px; height: 120px; font-size: 3rem;">
                                                ${(user.full_name || user.username).charAt(0).toUpperCase()}
                                            </div>
                                            <h4 class="fw-bold">${user.username}</h4>
                                            <p class="text-muted mb-2">
                                                <i class="fas fa-envelope me-1"></i>${user.email}
                                            </p>
                                            <span class="role-badge role-${user.role} fs-6">
                                                ${getRoleIcon(user.role)} ${getRoleText(user.role)}
                                            </span>
                                        </div>
                                        
                                        <div class="card shadow">
                                            <div class="card-header">
                                                <h6 class="mb-0">
                                                    <i class="fas fa-info-circle text-primary me-2"></i>åŸºæœ¬ä¿¡æ¯
                                                </h6>
                                            </div>
                                            <div class="card-body">
                                                <table class="table table-sm">
                                                    <tr>
                                                        <th width="80"><i class="fas fa-hashtag me-1"></i>ID</th>
                                                        <td><span class="badge bg-primary">${user.id}</span></td>
                                                    </tr>
                                                    <tr>
                                                        <th><i class="fas fa-id-badge me-1"></i>çœŸå®å§“å</th>
                                                        <td>${user.full_name || '<em class="text-muted">æœªè®¾ç½®</em>'}</td>
                                                    </tr>
                                                    <tr>
                                                        <th><i class="fas fa-user-tag me-1"></i>è§’è‰²</th>
                                                        <td>${getRoleIcon(user.role)} ${getRoleText(user.role)}</td>
                                                    </tr>
                                                    <tr>
                                                        <th><i class="fas fa-toggle-on me-1"></i>çŠ¶æ€</th>
                                                        <td>
                                                            <span class="badge bg-${user.is_active ? 'success' : 'danger'}">
                                                                ${user.is_active ? 'âœ… æ´»è·ƒ' : 'âŒ ç¦ç”¨'}
                                                            </span>
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <th><i class="fas fa-certificate me-1"></i>é‚®ç®±éªŒè¯</th>
                                                        <td>
                                                            <span class="badge bg-${user.is_verified ? 'info' : 'secondary'}">
                                                                ${user.is_verified ? 'ğŸ“§ å·²éªŒè¯' : 'â³ æœªéªŒè¯'}
                                                            </span>
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <th><i class="fas fa-calendar-plus me-1"></i>æ³¨å†Œæ—¶é—´</th>
                                                        <td>${formatDate(user.created_at)}</td>
                                                    </tr>
                                                    <tr>
                                                        <th><i class="fas fa-sign-in-alt me-1"></i>æœ€åç™»å½•</th>
                                                        <td>
                                                            ${user.last_login ? formatDate(user.last_login) : 
                                                              '<em class="text-muted">ä»æœªç™»å½•</em>'}
                                                        </td>
                                                    </tr>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-8">
                                        <!-- ç»Ÿè®¡ä¿¡æ¯ -->
                                        <div class="row mb-4">
                                            <div class="col-md-3">
                                                <div class="card text-center bg-primary bg-opacity-10 border-primary">
                                                    <div class="card-body">
                                                        <i class="fas fa-upload fa-2x text-primary mb-2"></i>
                                                        <h4 class="text-primary">${stats.total_count || 0}</h4>
                                                        <small class="text-muted">æ€»ä¸Šä¼ é‡</small>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="card text-center bg-success bg-opacity-10 border-success">
                                                    <div class="card-body">
                                                        <i class="fas fa-check-circle fa-2x text-success mb-2"></i>
                                                        <h4 class="text-success">${stats.active_count || 0}</h4>
                                                        <small class="text-muted">æ´»è·ƒå›¾ç‰‡</small>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="card text-center bg-info bg-opacity-10 border-info">
                                                    <div class="card-body">
                                                        <i class="fas fa-hdd fa-2x text-info mb-2"></i>
                                                        <h4 class="text-info">${formatFileSize(stats.total_size || 0)}</h4>
                                                        <small class="text-muted">æ€»å­˜å‚¨</small>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="card text-center bg-warning bg-opacity-10 border-warning">
                                                    <div class="card-body">
                                                        <i class="fas fa-percentage fa-2x text-warning mb-2"></i>
                                                        <h4 class="text-warning">${stats.avg_confidence || 0}%</h4>
                                                        <small class="text-muted">å¹³å‡ç½®ä¿¡åº¦</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- AIçŠ¶æ€åˆ†å¸ƒ -->
                                        ${data.ai_stats && data.ai_stats.length > 0 ? `
                                        <div class="card mb-4 shadow">
                                            <div class="card-header">
                                                <h6 class="mb-0">
                                                    <i class="fas fa-chart-pie text-success me-2"></i>AIåˆ†æçŠ¶æ€
                                                </h6>
                                            </div>
                                            <div class="card-body">
                                                <canvas id="userAIStatusChart" width="400" height="200"></canvas>
                                            </div>
                                        </div>
                                        ` : ''}
                                        
                                        <!-- æœ€è¿‘æ´»åŠ¨ -->
                                        ${data.recent_activity && data.recent_activity.length > 0 ? `
                                        <div class="card mb-4 shadow">
                                            <div class="card-header">
                                                <h6 class="mb-0">
                                                    <i class="fas fa-chart-line text-info me-2"></i>æœ€è¿‘30å¤©æ´»åŠ¨
                                                </h6>
                                            </div>
                                            <div class="card-body">
                                                <canvas id="userActivityChart" width="400" height="150"></canvas>
                                            </div>
                                        </div>
                                        ` : ''}
                                        
                                        <!-- æœ€è¿‘å›¾ç‰‡ -->
                                        ${data.recent_images && data.recent_images.length > 0 ? `
                                        <div class="card shadow">
                                            <div class="card-header">
                                                <h6 class="mb-0">
                                                    <i class="fas fa-images text-primary me-2"></i>æœ€è¿‘ä¸Šä¼ å›¾ç‰‡
                                                </h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="table-responsive">
                                                    <table class="table table-sm table-hover">
                                                        <thead class="table-light">
                                                            <tr>
                                                                <th>æ–‡ä»¶å</th>
                                                                <th>ä¸Šä¼ æ—¶é—´</th>
                                                                <th>AIçŠ¶æ€</th>
                                                                <th>çŠ¶æ€</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            ${data.recent_images.map(img => `
                                                                <tr>
                                                                    <td class="text-truncate" style="max-width: 200px;" title="${img.filename}">
                                                                        <i class="fas fa-image me-1 text-primary"></i>
                                                                        ${img.filename}
                                                                    </td>
                                                                    <td>${formatDate(img.upload_time)}</td>
                                                                    <td>
                                                                        <span class="status-badge status-${img.ai_analysis_status}">
                                                                            ${getStatusText(img.ai_analysis_status)}
                                                                        </span>
                                                                    </td>
                                                                    <td>
                                                                        <span class="badge bg-${img.is_active ? 'success' : 'danger'}">
                                                                            ${img.is_active ? 'âœ… æ´»è·ƒ' : 'âŒ ç¦ç”¨'}
                                                                        </span>
                                                                    </td>
                                                                </tr>
                                                            `).join('')}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                        ` : `
                                        <div class="card shadow">
                                            <div class="card-body text-center py-5">
                                                <i class="fas fa-images fa-3x text-muted mb-3"></i>
                                                <h5 class="text-muted">æš‚æ— ä¸Šä¼ å›¾ç‰‡</h5>
                                                <p class="text-muted">è¯¥ç”¨æˆ·è¿˜æ²¡æœ‰ä¸Šä¼ ä»»ä½•å›¾ç‰‡</p>
                                            </div>
                                        </div>
                                        `}
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-primary" onclick="editUser(${user.id}); bootstrap.Modal.getInstance(document.getElementById('userDetailsModal')).hide();">
                                    <i class="fas fa-edit me-1"></i>ç¼–è¾‘ç”¨æˆ·
                                </button>
                                <button type="button" class="btn btn-info" onclick="sendMessageToUser(${user.id}); bootstrap.Modal.getInstance(document.getElementById('userDetailsModal')).hide();">
                                    <i class="fas fa-envelope me-1"></i>å‘é€æ¶ˆæ¯
                                </button>
                                <button type="button" class="btn btn-warning" onclick="showUserActions(${user.id}); bootstrap.Modal.getInstance(document.getElementById('userDetailsModal')).hide();">
                                    <i class="fas fa-cogs me-1"></i>æ›´å¤šæ“ä½œ
                                </button>
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            removeModal('userDetailsModal');
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            const modal = new bootstrap.Modal(document.getElementById('userDetailsModal'));
            modal.show();
            
            // ç»˜åˆ¶å›¾è¡¨
            setTimeout(() => {
                if (data.ai_stats && data.ai_stats.length > 0) {
                    drawUserAIStatusChart(data.ai_stats);
                }
                if (data.recent_activity && data.recent_activity.length > 0) {
                    drawUserActivityChart(data.recent_activity);
                }
            }, 500);
        }

        // æ˜¾ç¤ºç¼–è¾‘ç”¨æˆ·æ¨¡æ€æ¡†
        function showEditUserModal(user) {
            const modalHtml = `
                <div class="modal fade" id="editUserModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    <i class="fas fa-edit me-2"></i>ç¼–è¾‘ç”¨æˆ·ä¿¡æ¯
                                </h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-md-4 text-center">
                                        <div class="user-avatar mx-auto mb-3" style="width: 100px; height: 100px; font-size: 2.5rem;">
                                            ${(user.full_name || user.username).charAt(0).toUpperCase()}
                                        </div>
                                        <h5>${user.username}</h5>
                                        <p class="text-muted small">${user.email}</p>
                                    </div>
                                    <div class="col-md-8">
                                        <form id="editUserForm">
                                            <input type="hidden" id="editUserId" value="${user.id}">
                                            
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <div class="mb-3">
                                                        <label class="form-label">
                                                            <i class="fas fa-user me-1"></i>ç”¨æˆ·å
                                                        </label>
                                                        <input type="text" class="form-control" value="${user.username}" readonly>
                                                        <div class="form-text">ç”¨æˆ·åä¸å¯ä¿®æ”¹</div>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="mb-3">
                                                        <label class="form-label">
                                                            <i class="fas fa-envelope me-1"></i>é‚®ç®±
                                                        </label>
                                                        <input type="email" class="form-control" value="${user.email}" readonly>
                                                        <div class="form-text">é‚®ç®±ä¸å¯ä¿®æ”¹</div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label class="form-label">
                                                    <i class="fas fa-id-badge me-1"></i>çœŸå®å§“å
                                                </label>
                                                <input type="text" class="form-control" id="editUserFullName" 
                                                       value="${user.full_name || ''}" placeholder="è¾“å…¥çœŸå®å§“åï¼ˆå¯é€‰ï¼‰">
                                                <div class="form-text">ç”¨äºæ˜¾ç¤ºå’Œèº«ä»½è¯†åˆ«</div>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label class="form-label">
                                                    <i class="fas fa-user-tag me-1"></i>ç”¨æˆ·è§’è‰²
                                                </label>
                                                <select class="form-select" id="editUserRole">
                                                    <option value="user" ${user.role === 'user' ? 'selected' : ''}>ğŸ‘¤ æ™®é€šç”¨æˆ·</option>
                                                    <option value="moderator" ${user.role === 'moderator' ? 'selected' : ''}>ğŸ‘® ç‰ˆä¸»</option>
                                                    <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>ğŸ‘‘ ç®¡ç†å‘˜</option>
                                                </select>
                                                <div class="form-text">è§’è‰²å†³å®šäº†ç”¨æˆ·çš„æƒé™èŒƒå›´</div>
                                            </div>
                                            
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <div class="mb-3">
                                                        <label class="form-label">
                                                            <i class="fas fa-toggle-on me-1"></i>è´¦æˆ·çŠ¶æ€
                                                        </label>
                                                        <select class="form-select" id="editUserActive">
                                                            <option value="true" ${user.is_active ? 'selected' : ''}>âœ… æ´»è·ƒ</option>
                                                            <option value="false" ${!user.is_active ? 'selected' : ''}>âŒ ç¦ç”¨</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="mb-3">
                                                        <label class="form-label">
                                                            <i class="fas fa-certificate me-1"></i>é‚®ç®±éªŒè¯
                                                        </label>
                                                        <select class="form-select" id="editUserVerified">
                                                            <option value="true" ${user.is_verified ? 'selected' : ''}>ğŸ“§ å·²éªŒè¯</option>
                                                            <option value="false" ${!user.is_verified ? 'selected' : ''}>â³ æœªéªŒè¯</option>
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div class="alert alert-info">
                                                <i class="fas fa-info-circle me-2"></i>
                                                <strong>æç¤ºï¼š</strong>ä¿®æ”¹åçš„ä¿¡æ¯å°†ç«‹å³ç”Ÿæ•ˆï¼Œè¯·è°¨æ…æ“ä½œã€‚
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                    <i class="fas fa-times me-1"></i>å–æ¶ˆ
                                </button>
                                <button type="button" class="btn btn-primary" onclick="saveUserEdit()">
                                    <i class="fas fa-save me-1"></i>ä¿å­˜æ›´æ”¹
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            removeModal('editUserModal');
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            const modal = new bootstrap.Modal(document.getElementById('editUserModal'));
            modal.show();
        }

        // ä¿å­˜ç”¨æˆ·ç¼–è¾‘
        async function saveUserEdit() {
            const userId = document.getElementById('editUserId').value;
            const fullName = document.getElementById('editUserFullName').value;
            const role = document.getElementById('editUserRole').value;
            const isActive = document.getElementById('editUserActive').value === 'true';
            const isVerified = document.getElementById('editUserVerified').value === 'true';
            
            try {
                showLoading('æ­£åœ¨ä¿å­˜æ›´æ”¹...');
                
                const response = await fetch(`/api/admin/users/${userId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        full_name: fullName,
                        role: role,
                        is_active: isActive,
                        is_verified: isVerified
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showSuccess('âœ… ç”¨æˆ·ä¿¡æ¯æ›´æ–°æˆåŠŸï¼');
                    
                    // å…³é—­æ¨¡æ€æ¡†
                    const modal = bootstrap.Modal.getInstance(document.getElementById('editUserModal'));
                    modal.hide();
                    
                    // åˆ·æ–°åˆ—è¡¨
                    loadUsers(currentPage);
                    loadStats();
                } else {
                    showError('æ›´æ–°å¤±è´¥ï¼š' + (result.detail || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                console.error('ä¿å­˜ç”¨æˆ·ç¼–è¾‘å¤±è´¥:', error);
                showError('ç½‘ç»œé”™è¯¯ï¼š' + error.message);
            } finally {
                hideLoading();
            }
        }

        // åˆ›å»ºç”¨æˆ·åŠŸèƒ½
        function showCreateUserModal() {
            const modalHtml = `
                <div class="modal fade" id="createUserModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    <i class="fas fa-user-plus me-2"></i>åˆ›å»ºæ–°ç”¨æˆ·
                                </h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-md-12">
                                        <form id="createUserForm">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <div class="mb-3">
                                                        <label class="form-label">
                                                            <i class="fas fa-user me-1"></i>ç”¨æˆ·å <span class="text-danger">*</span>
                                                        </label>
                                                        <input type="text" class="form-control" id="createUsername" 
                                                               placeholder="è¾“å…¥ç”¨æˆ·å" required>
                                                        <div class="form-text">ç”¨æˆ·ååªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿</div>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="mb-3">
                                                        <label class="form-label">
                                                            <i class="fas fa-envelope me-1"></i>é‚®ç®± <span class="text-danger">*</span>
                                                        </label>
                                                        <input type="email" class="form-control" id="createEmail" 
                                                               placeholder="è¾“å…¥é‚®ç®±åœ°å€" required>
                                                        <div class="form-text">ç”¨äºç™»å½•å’Œæ¥æ”¶é€šçŸ¥</div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <div class="mb-3">
                                                        <label class="form-label">
                                                            <i class="fas fa-key me-1"></i>å¯†ç  <span class="text-danger">*</span>
                                                        </label>
                                                        <input type="password" class="form-control" id="createPassword" 
                                                               placeholder="è¾“å…¥å¯†ç " required>
                                                        <div class="form-text">å¯†ç è‡³å°‘6ä½å­—ç¬¦</div>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="mb-3">
                                                        <label class="form-label">
                                                            <i class="fas fa-id-badge me-1"></i>çœŸå®å§“å
                                                        </label>
                                                        <input type="text" class="form-control" id="createFullName" 
                                                               placeholder="è¾“å…¥çœŸå®å§“åï¼ˆå¯é€‰ï¼‰">
                                                        <div class="form-text">å¯é€‰ï¼Œç”¨äºèº«ä»½è¯†åˆ«</div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label class="form-label">
                                                    <i class="fas fa-user-tag me-1"></i>ç”¨æˆ·è§’è‰²
                                                </label>
                                                <select class="form-select" id="createRole">
                                                    <option value="user">ğŸ‘¤ æ™®é€šç”¨æˆ·</option>
                                                    <option value="moderator">ğŸ‘® ç‰ˆä¸»</option>
                                                    <option value="admin">ğŸ‘‘ ç®¡ç†å‘˜</option>
                                                </select>
                                                <div class="form-text">è§’è‰²å†³å®šç”¨æˆ·çš„æƒé™èŒƒå›´</div>
                                            </div>
                                            
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <div class="form-check form-switch">
                                                        <input class="form-check-input" type="checkbox" id="createActive" checked>
                                                        <label class="form-check-label">
                                                            <i class="fas fa-toggle-on me-1"></i>æ¿€æ´»è´¦æˆ·
                                                        </label>
                                                        <div class="form-text">åˆ›å»ºåç«‹å³æ¿€æ´»è´¦æˆ·</div>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="form-check form-switch">
                                                        <input class="form-check-input" type="checkbox" id="createVerified">
                                                        <label class="form-check-label">
                                                            <i class="fas fa-certificate me-1"></i>éªŒè¯é‚®ç®±
                                                        </label>
                                                        <div class="form-text">è·³è¿‡é‚®ç®±éªŒè¯æµç¨‹</div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div class="alert alert-success mt-3">
                                                <i class="fas fa-lightbulb me-2"></i>
                                                <strong>æç¤ºï¼š</strong>åˆ›å»ºæˆåŠŸåï¼Œç³»ç»Ÿå°†ç”Ÿæˆç”¨æˆ·IDï¼Œæ‚¨å¯ä»¥é€šè¿‡ç”¨æˆ·ç®¡ç†é¡µé¢è¿›è¡Œåç»­ç®¡ç†ã€‚
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                    <i class="fas fa-times me-1"></i>å–æ¶ˆ
                                </button>
                                <button type="button" class="btn btn-success" onclick="createUser()">
                                    <i class="fas fa-plus me-1"></i>åˆ›å»ºç”¨æˆ·
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            removeModal('createUserModal');
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            const modal = new bootstrap.Modal(document.getElementById('createUserModal'));
            modal.show();
        }

        async function createUser() {
            const username = document.getElementById('createUsername').value.trim();
            const email = document.getElementById('createEmail').value.trim();
            const password = document.getElementById('createPassword').value;
            const fullName = document.getElementById('createFullName').value.trim();
            const role = document.getElementById('createRole').value;
            const isActive = document.getElementById('createActive').checked;
            const isVerified = document.getElementById('createVerified').checked;
            
            // åŸºæœ¬éªŒè¯
            if (!username || !email || !password) {
                showError('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ');
                return;
            }
            
            if (password.length < 6) {
                showError('å¯†ç è‡³å°‘éœ€è¦6ä½å­—ç¬¦');
                return;
            }
            
            try {
                showLoading('æ­£åœ¨åˆ›å»ºç”¨æˆ·...');
                
                const response = await fetch('/api/admin/users/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username: username,
                        email: email,
                        password: password,
                        full_name: fullName || null,
                        role: role,
                        is_active: isActive,
                        is_verified: isVerified
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showSuccess(`âœ… ç”¨æˆ·åˆ›å»ºæˆåŠŸï¼ç”¨æˆ·ID: ${result.user_id}`);
                    
                    // å…³é—­æ¨¡æ€æ¡†
                    const modal = bootstrap.Modal.getInstance(document.getElementById('createUserModal'));
                    modal.hide();
                    
                    // åˆ·æ–°åˆ—è¡¨
                    loadUsers(1);
                    loadStats();
                } else {
                    showError('åˆ›å»ºå¤±è´¥ï¼š' + (result.detail || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                console.error('åˆ›å»ºç”¨æˆ·å¤±è´¥:', error);
                showError('ç½‘ç»œé”™è¯¯ï¼š' + error.message);
            } finally {
                hideLoading();
            }
        }

        // å‘é€æ¶ˆæ¯åŠŸèƒ½
        async function sendMessageToUser(userId) {
            const modalHtml = `
                <div class="modal fade" id="sendMessageModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    <i class="fas fa-envelope me-2"></i>å‘é€ç³»ç»Ÿæ¶ˆæ¯
                                </h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <form id="sendMessageForm">
                                    <input type="hidden" id="messageUserId" value="${userId}">
                                    
                                    <div class="mb-3">
                                        <label class="form-label">
                                            <i class="fas fa-tag me-1"></i>æ¶ˆæ¯ä¸»é¢˜ <span class="text-danger">*</span>
                                        </label>
                                        <input type="text" class="form-control" id="messageSubject" 
                                               placeholder="è¾“å…¥æ¶ˆæ¯ä¸»é¢˜" required>
                                        <div class="form-text">ç®€æ´æ˜äº†çš„ä¸»é¢˜ï¼Œä¾¿äºç”¨æˆ·å¿«é€Ÿäº†è§£</div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">
                                            <i class="fas fa-align-left me-1"></i>æ¶ˆæ¯å†…å®¹ <span class="text-danger">*</span>
                                        </label>
                                        <textarea class="form-control" id="messageContent" rows="8" 
                                                  placeholder="è¾“å…¥è¯¦ç»†çš„æ¶ˆæ¯å†…å®¹..." required></textarea>
                                        <div class="form-text">æ”¯æŒæ¢è¡Œï¼Œå»ºè®®å†…å®¹æ¸…æ™°ã€å‹å¥½</div>
                                    </div>
                                    
                                    <div class="alert alert-info">
                                        <i class="fas fa-info-circle me-2"></i>
                                        <strong>å‘é€è¯´æ˜ï¼š</strong>
                                        <ul class="mb-0 mt-2">
                                            <li>æ¶ˆæ¯å°†é€šè¿‡é‚®ä»¶å‘é€ç»™ç”¨æˆ·</li>
                                            <li>è¯·ç¡®ä¿å†…å®¹å‡†ç¡®ã€å‹å¥½</li>
                                            <li>å‘é€åæ— æ³•æ’¤å›ï¼Œè¯·è°¨æ…æ“ä½œ</li>
                                        </ul>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                    <i class="fas fa-times me-1"></i>å–æ¶ˆ
                                </button>
                                <button type="button" class="btn btn-primary" onclick="sendMessage()">
                                    <i class="fas fa-paper-plane me-1"></i>å‘é€æ¶ˆæ¯
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            removeModal('sendMessageModal');
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            const modal = new bootstrap.Modal(document.getElementById('sendMessageModal'));
            modal.show();
        }

        async function sendMessage() {
            const userId = document.getElementById('messageUserId').value;
            const subject = document.getElementById('messageSubject').value.trim();
            const content = document.getElementById('messageContent').value.trim();
            
            if (!subject || !content) {
                showError('è¯·å¡«å†™ä¸»é¢˜å’Œæ¶ˆæ¯å†…å®¹');
                return;
            }
            
            try {
                showLoading('æ­£åœ¨å‘é€æ¶ˆæ¯...');
                
                const response = await fetch(`/api/admin/users/${userId}/send-message`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        subject: subject,
                        message: content
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showSuccess('âœ… æ¶ˆæ¯å‘é€æˆåŠŸï¼');
                    
                    // å…³é—­æ¨¡æ€æ¡†
                    const modal = bootstrap.Modal.getInstance(document.getElementById('sendMessageModal'));
                    modal.hide();
                } else {
                    showError('å‘é€å¤±è´¥ï¼š' + (result.message || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                console.error('å‘é€æ¶ˆæ¯å¤±è´¥:', error);
                showError('ç½‘ç»œé”™è¯¯ï¼š' + error.message);
            } finally {
                hideLoading();
            }
        }

        // é‡ç½®å¯†ç åŠŸèƒ½
        async function resetUserPassword(userId) {
            const newPassword = prompt('ğŸ” è¯·è¾“å…¥æ–°å¯†ç ï¼ˆè‡³å°‘6ä½ï¼‰ï¼š');
            
            if (!newPassword) {
                return;
            }
            
            if (newPassword.length < 6) {
                showError('å¯†ç è‡³å°‘éœ€è¦6ä½å­—ç¬¦');
                return;
            }
            
            const sendNotification = confirm('ğŸ“§ æ˜¯å¦å‘é€å¯†ç é‡ç½®é€šçŸ¥é‚®ä»¶ç»™ç”¨æˆ·ï¼Ÿ\n\nâœ… ç¡®å®š = å‘é€é‚®ä»¶é€šçŸ¥\nâŒ å–æ¶ˆ = ä»…é‡ç½®å¯†ç ');
            
            try {
                showLoading('æ­£åœ¨é‡ç½®å¯†ç ...');
                
                const response = await fetch(`/api/admin/users/${userId}/reset-password`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        new_password: newPassword,
                        send_notification: sendNotification
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showSuccess(result.message);
                } else {
                    showError('é‡ç½®å¤±è´¥ï¼š' + (result.detail || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                console.error('é‡ç½®å¯†ç å¤±è´¥:', error);
                showError('ç½‘ç»œé”™è¯¯ï¼š' + error.message);
            } finally {
                hideLoading();
            }
        }

        // åˆ é™¤ç”¨æˆ·åŠŸèƒ½
        async function deleteUser(userId) {
            const transferImages = confirm('ğŸ—‚ï¸ é€‰æ‹©å›¾ç‰‡å¤„ç†æ–¹å¼ï¼š\n\nâœ… ç¡®å®š = è½¬ç§»å›¾ç‰‡åˆ°å½“å‰ç®¡ç†å‘˜\nâŒ å–æ¶ˆ = ç¦ç”¨ç”¨æˆ·çš„å›¾ç‰‡');
            
            if (!confirm(`âš ï¸ ç¡®å®šè¦åˆ é™¤è¿™ä¸ªç”¨æˆ·å—ï¼Ÿ\n\nğŸ“¸ ç”¨æˆ·çš„å›¾ç‰‡å°†${transferImages ? 'è½¬ç§»åˆ°æ‚¨çš„è´¦æˆ·' : 'è¢«ç¦ç”¨'}ã€‚\n\næ­¤æ“ä½œä¸å¯æ’¤é”€ï¼Œè¯·è°¨æ…æ“ä½œï¼`)) {
                return;
            }
            
            try {
                showLoading('æ­£åœ¨åˆ é™¤ç”¨æˆ·...');
                
                const response = await fetch(`/api/admin/users/${userId}?transfer_images=${transferImages}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showSuccess(`âœ… ${result.message}ï¼ˆå½±å“ ${result.affected_images} å¼ å›¾ç‰‡ï¼‰`);
                    loadUsers(currentPage);
                    loadStats();
                } else {
                    showError('åˆ é™¤å¤±è´¥ï¼š' + (result.detail || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                console.error('åˆ é™¤ç”¨æˆ·å¤±è´¥:', error);
                showError('ç½‘ç»œé”™è¯¯ï¼š' + error.message);
            } finally {
                hideLoading();
            }
        }

        // æŸ¥çœ‹ç”¨æˆ·å›¾ç‰‡
        function viewUserImages(userId) {
            // è·³è½¬åˆ°å›¾ç‰‡ç®¡ç†é¡µé¢ï¼Œé¢„å¡«å……è¯¥ç”¨æˆ·çš„ç­›é€‰æ¡ä»¶
            window.open(`/admin/images?uploader=${encodeURIComponent(userId)}`, '_blank');
        }

        // ç”¨æˆ·åˆ†æåŠŸèƒ½
        async function showAnalytics() {
            try {
                showLoading('æ­£åœ¨åŠ è½½ç”¨æˆ·åˆ†ææ•°æ®...');
                
                const response = await fetch('/api/admin/users/analytics');
                const data = await response.json();
                
                if (data.success) {
                    showAnalyticsModal(data.data);
                } else {
                    showError('åŠ è½½åˆ†ææ•°æ®å¤±è´¥');
                }
            } catch (error) {
                console.error('åŠ è½½åˆ†æå¤±è´¥:', error);
                showError('ç½‘ç»œé”™è¯¯ï¼š' + error.message);
            } finally {
                hideLoading();
            }
        }

        function showAnalyticsModal(data) {
            const modalHtml = `
                <div class="modal fade" id="analyticsModal" tabindex="-1">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    <i class="fas fa-chart-bar me-2"></i>ç”¨æˆ·æ•°æ®åˆ†ææŠ¥å‘Š
                                </h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <!-- æ³¨å†Œè¶‹åŠ¿ -->
                                    <div class="col-md-6 mb-4">
                                        <div class="chart-container">
                                            <h6>
                                                <i class="fas fa-chart-line text-primary me-2"></i>ç”¨æˆ·æ³¨å†Œè¶‹åŠ¿ï¼ˆè¿‘30å¤©ï¼‰
                                            </h6>
                                            <canvas id="registrationTrendChart" width="400" height="250"></canvas>
                                        </div>
                                    </div>
                                    
                                    <!-- æ´»è·ƒåº¦åˆ†å¸ƒ -->
                                    <div class="col-md-6 mb-4">
                                        <div class="chart-container">
                                            <h6>
                                                <i class="fas fa-chart-pie text-success me-2"></i>ç”¨æˆ·æ´»è·ƒåº¦åˆ†å¸ƒ
                                            </h6>
                                            <canvas id="activityDistChart" width="400" height="250"></canvas>
                                        </div>
                                    </div>
                                    
                                    <!-- è§’è‰²åˆ†å¸ƒ -->
                                    <div class="col-md-6 mb-4">
                                        <div class="chart-container">
                                            <h6>
                                                <i class="fas fa-chart-doughnut text-warning me-2"></i>ç”¨æˆ·è§’è‰²åˆ†å¸ƒ
                                            </h6>
                                            <canvas id="roleDistChart" width="400" height="250"></canvas>
                                        </div>
                                    </div>
                                    
                                    <!-- ä¸Šä¼ æ´»è·ƒåº¦ -->
                                    <div class="col-md-6 mb-4">
                                        <div class="chart-container">
                                            <h6>
                                                <i class="fas fa-chart-bar text-info me-2"></i>ä¸Šä¼ æ´»è·ƒåº¦åˆ†å¸ƒ
                                            </h6>
                                            <canvas id="uploadDistChart" width="400" height="250"></canvas>
                                        </div>
                                    </div>
                                    
                                    <!-- æœ€æ´»è·ƒç”¨æˆ·æ’è¡Œ -->
                                    <div class="col-md-12">
                                        <div class="chart-container">
                                            <h6>
                                                <i class="fas fa-trophy text-warning me-2"></i>æœ€æ´»è·ƒç”¨æˆ·æ’è¡Œæ¦œ
                                            </h6>
                                            <div class="table-responsive">
                                                <table class="table table-striped table-hover">
                                                    <thead class="table-light">
                                                        <tr>
                                                            <th width="80">æ’å</th>
                                                            <th>ç”¨æˆ·å</th>
                                                            <th>ä¸Šä¼ æ•°é‡</th>
                                                            <th>æ€»å­˜å‚¨å¤§å°</th>
                                                            <th>å¹³å‡ç½®ä¿¡åº¦</th>
                                                            <th>æœ€åæ´»è·ƒ</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        ${data.top_uploaders?.map((user, index) => `
                                                            <tr>
                                                                <td>
                                                                    <span class="badge bg-${getRankBadgeClass(index)} fs-6">
                                                                        ${getRankIcon(index)} ${index + 1}
                                                                    </span>
                                                                </td>
                                                                <td>
                                                                    <div class="d-flex align-items-center">
                                                                        <div class="user-avatar me-2" style="width: 32px; height: 32px; font-size: 0.8rem;">
                                                                            ${user.username.charAt(0).toUpperCase()}
                                                                        </div>
                                                                        <div>
                                                                            <div class="fw-bold">${user.username}</div>
                                                                            <small class="text-muted">${getRoleIcon(user.role)} ${getRoleText(user.role)}</small>
                                                                        </div>
                                                                    </div>
                                                                </td>
                                                                <td>
                                                                    <span class="badge bg-primary fs-6">
                                                                        <i class="fas fa-images me-1"></i>${user.upload_count}
                                                                    </span>
                                                                </td>
                                                                <td>
                                                                    <span class="fw-bold">${formatFileSize(user.total_size)}</span>
                                                                </td>
                                                                <td>
                                                                    <div class="d-flex align-items-center">
                                                                        <div class="confidence-bar me-2" style="width: 50px; height: 6px;">
                                                                            <div class="confidence-fill bg-${getConfidenceColor(user.avg_confidence / 100)}" 
                                                                                 style="width: ${user.avg_confidence}%"></div>
                                                                        </div>
                                                                        <small>${user.avg_confidence}%</small>
                                                                    </div>
                                                                </td>
                                                                <td>
                                                                    <small class="text-muted">
                                                                        ${user.last_login ? formatDate(user.last_login) : 'ä»æœªç™»å½•'}
                                                                    </small>
                                                                </td>
                                                            </tr>
                                                        `).join('') || '<tr><td colspan="6" class="text-center text-muted">æš‚æ— æ•°æ®</td></tr>'}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <div class="text-muted me-auto">
                                    <small>
                                        <i class="fas fa-clock me-1"></i>
                                        æŠ¥å‘Šç”Ÿæˆæ—¶é—´: ${new Date().toLocaleString('zh-CN')}
                                    </small>
                                </div>
                                <button type="button" class="btn btn-success" onclick="exportAnalyticsReport()">
                                    <i class="fas fa-download me-1"></i>å¯¼å‡ºæŠ¥å‘Š
                                </button>
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            removeModal('analyticsModal');
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            const modal = new bootstrap.Modal(document.getElementById('analyticsModal'));
            modal.show();
            
            // ç­‰å¾…æ¨¡æ€æ¡†æ˜¾ç¤ºåç»˜åˆ¶å›¾è¡¨
            setTimeout(() => {
                if (data.registration_trend) drawRegistrationTrendChart(data.registration_trend);
                if (data.activity_distribution) drawActivityDistChart(data.activity_distribution);
                if (data.role_distribution) drawRoleDistChart(data.role_distribution);
                if (data.upload_distribution) drawUploadDistChart(data.upload_distribution);
            }, 500);
        }

        // å¯¼å‡ºæ•°æ®
        async function exportData() {
            const includeStats = confirm('ğŸ“Š æ˜¯å¦åŒ…å«è¯¦ç»†ç»Ÿè®¡æ•°æ®ï¼Ÿ\n\nâœ… ç¡®å®š = åŒ…å«ç»Ÿè®¡\nâŒ å–æ¶ˆ = ä»…åŸºæœ¬ä¿¡æ¯');
            const format = prompt('ğŸ“ é€‰æ‹©å¯¼å‡ºæ ¼å¼ï¼š\n\n1ï¸âƒ£ = CSVæ ¼å¼ (Excelå…¼å®¹)\n2ï¸âƒ£ = JSONæ ¼å¼ (ç¨‹åºå¤„ç†)', '1');
            
            if (!format || !['1', '2'].includes(format)) {
                return;
            }
            
            const exportFormat = format === '1' ? 'csv' : 'json';
            
            try {
                showLoading(`æ­£åœ¨å¯¼å‡º${exportFormat.toUpperCase()}æ ¼å¼æ•°æ®...`);
                
                const response = await fetch(`/api/admin/users/export?format=${exportFormat}&include_stats=${includeStats}`);
                
                if (response.ok) {
                    // åˆ›å»ºä¸‹è½½é“¾æ¥
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = `users_export_${new Date().toISOString().slice(0,10)}.${exportFormat}`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    
                    showSuccess(`âœ… ${exportFormat.toUpperCase()}æ•°æ®å¯¼å‡ºæˆåŠŸï¼`);
                } else {
                    showError('å¯¼å‡ºæ•°æ®å¤±è´¥');
                }
            } catch (error) {
                console.error('å¯¼å‡ºå¤±è´¥:', error);
                showError('ç½‘ç»œé”™è¯¯ï¼š' + error.message);
            } finally {
                hideLoading();
            }
        }

        // åˆ·æ–°æ•°æ®
        function refreshData() {
            loadStats();
            loadUsers(currentPage);
            showSuccess('ğŸ”„ æ•°æ®å·²åˆ·æ–°ï¼');
        }

        // è¾…åŠ©å‡½æ•°
        function getStatusText(status) {
            const statusMap = {
                'pending': 'å¾…åˆ†æ',
                'completed': 'å·²å®Œæˆ',
                'failed': 'åˆ†æå¤±è´¥',
                'running': 'åˆ†æä¸­'
            };
            return statusMap[status] || status;
        }

        function getRankIcon(index) {
            if (index === 0) return 'ğŸ¥‡';
            if (index === 1) return 'ğŸ¥ˆ';
            if (index === 2) return 'ğŸ¥‰';
            return 'ğŸ“';
        }

        function getConfidenceColor(confidence) {
            if (confidence >= 0.8) return 'success';
            if (confidence >= 0.6) return 'warning';
            return 'danger';
        }

        function removeModal(modalId) {
            const existingModal = document.getElementById(modalId);
            if (existingModal) {
                existingModal.remove();
            }
        }

        // ===== UIé€šçŸ¥ç³»ç»Ÿ =====
        function showLoading(text = 'å¤„ç†ä¸­...') {
            document.getElementById('loadingText').textContent = text;
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        function showSuccess(message) {
            showNotification(message, 'success', 5000);
        }

        function showError(message) {
            showNotification(message, 'danger', 8000);
        }

        function showWarning(message) {
            showNotification(message, 'warning', 6000);
        }

        function showInfo(message) {
            showNotification(message, 'info', 4000);
        }

        function showNotification(message, type, duration) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed animate-slide-up`;
            alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 10000; min-width: 350px; max-width: 500px;';
            
            const icon = getNotificationIcon(type);
            alertDiv.innerHTML = `
                <div class="d-flex align-items-center">
                    <div class="me-2">${icon}</div>
                    <div class="flex-grow-1">${message}</div>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            document.body.appendChild(alertDiv);
            
            // è‡ªåŠ¨ç§»é™¤
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.classList.remove('show');
                    setTimeout(() => {
                        if (alertDiv.parentNode) {
                            alertDiv.parentNode.removeChild(alertDiv);
                        }
                    }, 300);
                }
            }, duration);
        }

        function getNotificationIcon(type) {
            const iconMap = {
                'success': '<i class="fas fa-check-circle text-success"></i>',
                'danger': '<i class="fas fa-exclamation-triangle text-danger"></i>',
                'warning': '<i class="fas fa-exclamation-circle text-warning"></i>',
                'info': '<i class="fas fa-info-circle text-info"></i>'
            };
            return iconMap[type] || '<i class="fas fa-bell"></i>';
        }

        // ===== å›¾è¡¨ç»˜åˆ¶å‡½æ•° =====
        function drawRegistrationTrendChart(data) {
            const ctx = document.getElementById('registrationTrendChart');
            if (!ctx) return;
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(item => item.date),
                    datasets: [{
                        label: 'æ¯æ—¥æ³¨å†Œæ•°',
                        data: data.map(item => item.count),
                        borderColor: '#56ab2f',
                        backgroundColor: 'rgba(86, 171, 47, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: '#56ab2f',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 5,
                        pointHoverRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            },
                            grid: {
                                color: 'rgba(0,0,0,0.05)'
                            }
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    }
                }
            });
        }

        function drawActivityDistChart(data) {
            const ctx = document.getElementById('activityDistChart');
            if (!ctx) return;
            
            const activityLabels = {
                'today': 'ä»Šå¤©æ´»è·ƒ',
                'week': 'æœ¬å‘¨æ´»è·ƒ',
                'month': 'æœ¬æœˆæ´»è·ƒ',
                'older': 'è¾ƒæ—©æ´»è·ƒ',
                'never': 'ä»æœªç™»å½•'
            };
            
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: data.map(item => activityLabels[item.activity] || item.activity),
                    datasets: [{
                        data: data.map(item => item.count),
                        backgroundColor: ['#28a745', '#ffc107', '#17a2b8', '#6c757d', '#dc3545'],
                        borderWidth: 0,
                        hoverOffset: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                                    return `${context.label}: ${context.parsed} äºº (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function drawRoleDistChart(data) {
            const ctx = document.getElementById('roleDistChart');
            if (!ctx) return;
            
            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: data.map(item => getRoleText(item.role)),
                    datasets: [{
                        data: data.map(item => item.count),
                        backgroundColor: ['#007bff', '#fd7e14', '#dc3545'],
                        borderWidth: 0,
                        hoverOffset: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                                    return `${context.label}: ${context.parsed} äºº (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function drawUploadDistChart(data) {
            const ctx = document.getElementById('uploadDistChart');
            if (!ctx) return;
            
            const levelLabels = {
                'none': 'æ— ä¸Šä¼ ',
                'low': 'ä½æ´»è·ƒ(1-5)',
                'medium': 'ä¸­æ´»è·ƒ(6-20)',
                'high': 'é«˜æ´»è·ƒ(21-100)',
                'very_high': 'è¶…æ´»è·ƒ(100+)'
            };
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(item => levelLabels[item.level] || item.level),
                    datasets: [{
                        label: 'ç”¨æˆ·æ•°é‡',
                        data: data.map(item => item.count),
                        backgroundColor: ['#6c757d', '#17a2b8', '#28a745', '#ffc107', '#fd7e14'],
                        borderWidth: 0,
                        borderRadius: 8,
                        borderSkipped: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.label}: ${context.parsed.y} äºº`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            },
                            grid: {
                                color: 'rgba(0,0,0,0.05)'
                            }
                        }
                    }
                }
            });
        }

        function drawUserAIStatusChart(data) {
            const ctx = document.getElementById('userAIStatusChart');
            if (!ctx) return;
            
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: data.map(item => getStatusText(item.status)),
                    datasets: [{
                        data: data.map(item => item.count),
                        backgroundColor: ['#28a745', '#ffc107', '#dc3545', '#17a2b8'],
                        borderWidth: 0,
                        hoverOffset: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                                    return `${context.label}: ${context.parsed} å¼  (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function drawUserActivityChart(data) {
            const ctx = document.getElementById('userActivityChart');
            if (!ctx) return;
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(item => item.date),
                    datasets: [{
                        label: 'ä¸Šä¼ æ•°é‡',
                        data: data.map(item => item.count),
                        borderColor: '#007bff',
                        backgroundColor: 'rgba(0, 123, 255, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: '#007bff',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            },
                            grid: {
                                color: 'rgba(0,0,0,0.05)'
                            }
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    }
                }
            });
        }

        // ===== å ä½å‡½æ•°ï¼ˆå¯ä»¥åç»­å®ç°ï¼‰ =====
        function exportAnalyticsReport() {
            showInfo('ğŸ“Š åˆ†ææŠ¥å‘Šå¯¼å‡ºåŠŸèƒ½å¼€å‘ä¸­ï¼Œæ•¬è¯·æœŸå¾…...');
        }

        // ===== é¢å¤–çš„æ ·å¼ç±» =====
        const additionalStyles = `
            <style>
                .confidence-bar {
                    height: 6px;
                    background: rgba(0,0,0,0.1);
                    border-radius: 3px;
                    overflow: hidden;
                }
                
                .confidence-fill {
                    height: 100%;
                    border-radius: 3px;
                    transition: width 0.3s ease;
                }
                
                .status-badge {
                    padding: 0.3rem 0.6rem;
                    border-radius: 10px;
                    font-size: 0.75rem;
                    font-weight: 600;
                    display: inline-flex;
                    align-items: center;
                    gap: 0.2rem;
                }
                
                .status-pending {
                    background: #fff3cd;
                    color: #856404;
                }
                
                .status-completed {
                    background: #d1eddc;
                    color: #155724;
                }
                
                .status-failed {
                    background: #f8d7da;
                    color: #721c24;
                }
                
                .status-running {
                    background: #cce7ff;
                    color: #004085;
                }
                
                .animate-number {
                    transition: all 0.3s ease;
                }
                
                .card:hover .card-body i {
                    animation: iconBounce 0.6s ease;
                }
                
                @keyframes iconBounce {
                    0%, 20%, 60%, 100% {
                        transform: translateY(0);
                    }
                    40% {
                        transform: translateY(-10px);
                    }
                    80% {
                        transform: translateY(-5px);
                    }
                }
                
                .table tbody tr:hover .user-avatar {
                    transform: scale(1.1);
                }
                
                .modal-content {
                    animation: modalSlideIn 0.3s ease;
                }
                
                @keyframes modalSlideIn {
                    from {
                        opacity: 0;
                        transform: translateY(-50px);
                    }
                    to {
                        opacity: 1;
                        transform: translateY(0);
                    }
                }
                
                .chart-container canvas {
                    border-radius: 10px;
                }
                
                .btn:active {
                    transform: translateY(1px) scale(0.98);
                }
                
                .search-highlight {
                    background: linear-gradient(120deg, #f093fb 0%, #f5576c 100%);
                    color: white;
                    padding: 0.2rem 0.4rem;
                    border-radius: 4px;
                    font-weight: bold;
                }
                
                .loading-dots::after {
                    content: '';
                    animation: loadingDots 1.5s infinite;
                }
                
                @keyframes loadingDots {
                    0%, 20% {
                        content: '.';
                    }
                    40% {
                        content: '..';
                    }
                    60%, 100% {
                        content: '...';
                    }
                }
                
                .glass-card {
                    background: rgba(255, 255, 255, 0.1);
                    backdrop-filter: blur(15px);
                    border: 1px solid rgba(255, 255, 255, 0.2);
                    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
                }
                
                .hover-lift {
                    transition: transform 0.3s ease, box-shadow 0.3s ease;
                }
                
                .hover-lift:hover {
                    transform: translateY(-5px);
                    box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
                }
            </style>
        `;
        
        // æ’å…¥é¢å¤–æ ·å¼
        document.head.insertAdjacentHTML('beforeend', additionalStyles);

        // ===== é”®ç›˜å¿«æ·é”®æ”¯æŒ =====
        document.addEventListener('keydown', function(e) {
            // Ctrl/Cmd + R: åˆ·æ–°æ•°æ®
            if ((e.ctrlKey || e.metaKey) && e.key === 'r') {
                e.preventDefault();
                refreshData();
            }
            
            // Ctrl/Cmd + N: åˆ›å»ºæ–°ç”¨æˆ·
            if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
                e.preventDefault();
                showCreateUserModal();
            }
            
            // Ctrl/Cmd + E: å¯¼å‡ºæ•°æ®
            if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
                e.preventDefault();
                exportData();
            }
            
            // Ctrl/Cmd + A: æ˜¾ç¤ºåˆ†æ
            if ((e.ctrlKey || e.metaKey) && e.key === 'a') {
                e.preventDefault();
                showAnalytics();
            }
            
            // B: åˆ‡æ¢æ‰¹é‡æ“ä½œ
            if (e.key === 'b' || e.key === 'B') {
                if (!e.target.matches('input, textarea')) {
                    e.preventDefault();
                    toggleBatchActions();
                }
            }
            
            // ESC: å…³é—­æ¨¡æ€æ¡†å’Œæ‰¹é‡æ“ä½œ
            if (e.key === 'Escape') {
                // å…³é—­æ‰€æœ‰æ¨¡æ€æ¡†
                document.querySelectorAll('.modal.show').forEach(modal => {
                    const bsModal = bootstrap.Modal.getInstance(modal);
                    if (bsModal) {
                        bsModal.hide();
                    }
                });
                
                // å…³é—­æ‰¹é‡æ“ä½œ
                if (batchActionsVisible) {
                    toggleBatchActions();
                }
            }
        });

        // ===== æœç´¢å¢å¼ºåŠŸèƒ½ =====
        let searchTimeout;
        
        document.getElementById('searchInput').addEventListener('input', function(e) {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                if (e.target.value.length >= 2 || e.target.value.length === 0) {
                    loadUsers(1);
                }
            }, 500);
        });

        // ===== é¡µé¢å¯è§æ€§æ£€æµ‹ =====
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                // é¡µé¢é‡æ–°å¯è§æ—¶åˆ·æ–°ç»Ÿè®¡æ•°æ®
                loadStats();
            }
        });

        // ===== åˆå§‹åŒ–å®Œæˆæç¤º =====
        console.log('ğŸ‘¥ AIå§¿åŠ¿å‚è€ƒå›¾åº“ - ç”¨æˆ·ç®¡ç†ç³»ç»Ÿå·²å°±ç»ª');
        console.log('ğŸ‘¤ å½“å‰ç”¨æˆ·:', 'marvinli001'); 
        console.log('ğŸ•’ åˆå§‹åŒ–æ—¶é—´:', new Date().toLocaleString('zh-CN'));
        console.log('ğŸ“Š åŠŸèƒ½æ¨¡å—: ç”¨æˆ·ç®¡ç†ã€æ‰¹é‡æ“ä½œã€æ•°æ®åˆ†æã€æƒé™æ§åˆ¶');
        console.log('âŒ¨ï¸  å¿«æ·é”®: Ctrl+R(åˆ·æ–°) | Ctrl+N(æ–°å»º) | Ctrl+E(å¯¼å‡º) | Ctrl+A(åˆ†æ) | B(æ‰¹é‡æ“ä½œ)');
        console.log('ğŸ¨ UIä¸»é¢˜: ç°ä»£åŒ–æ¸å˜è®¾è®¡ | å“åº”å¼å¸ƒå±€ | åŠ¨ç”»æ•ˆæœ');

        // ===== æ€§èƒ½ç›‘æ§ =====
        window.addEventListener('load', function() {
            const loadTime = performance.now();
            console.log(`âš¡ é¡µé¢åŠ è½½å®Œæˆï¼Œè€—æ—¶: ${Math.round(loadTime)}ms`);
            
            // å¦‚æœåŠ è½½æ—¶é—´è¿‡é•¿ï¼Œæ˜¾ç¤ºæç¤º
            if (loadTime > 3000) {
                setTimeout(() => {
                    showInfo('é¡µé¢åŠ è½½å®Œæˆï¼å¦‚æœé‡åˆ°æ€§èƒ½é—®é¢˜ï¼Œè¯·å°è¯•åˆ·æ–°é¡µé¢ã€‚');
                }, 1000);
            }
        });

        // ===== é”™è¯¯å¤„ç†å¢å¼º =====
        window.addEventListener('error', function(e) {
            console.error('é¡µé¢é”™è¯¯:', e.error);
            showError('é¡µé¢å‘ç”Ÿé”™è¯¯ï¼Œè¯·åˆ·æ–°é‡è¯•');
        });

        window.addEventListener('unhandledrejection', function(e) {
            console.error('æœªå¤„ç†çš„Promiseé”™è¯¯:', e.reason);
            showError('ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥è¿æ¥åé‡è¯•');
        });

        // ===== è‡ªåŠ¨ä¿å­˜ç”¨æˆ·åå¥½ =====
        function saveUserPreferences() {
            const preferences = {
                roleFilter: document.getElementById('roleFilter').value,
                statusFilter: document.getElementById('statusFilter').value,
                verifiedFilter: document.getElementById('verifiedFilter').value,
                searchInput: document.getElementById('searchInput').value
            };
            localStorage.setItem('userManagementPreferences', JSON.stringify(preferences));
        }

        function loadUserPreferences() {
            const saved = localStorage.getItem('userManagementPreferences');
            if (saved) {
                try {
                    const preferences = JSON.parse(saved);
                    if (preferences.roleFilter) document.getElementById('roleFilter').value = preferences.roleFilter;
                    if (preferences.statusFilter) document.getElementById('statusFilter').value = preferences.statusFilter;
                    if (preferences.verifiedFilter) document.getElementById('verifiedFilter').value = preferences.verifiedFilter;
                    if (preferences.searchInput) document.getElementById('searchInput').value = preferences.searchInput;
                } catch (e) {
                    console.warn('åŠ è½½ç”¨æˆ·åå¥½è®¾ç½®å¤±è´¥:', e);
                }
            }
        }

        // åœ¨ç­›é€‰å™¨å˜åŒ–æ—¶ä¿å­˜åå¥½
        ['roleFilter', 'statusFilter', 'verifiedFilter', 'searchInput'].forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.addEventListener('change', saveUserPreferences);
                if (id === 'searchInput') {
                    element.addEventListener('input', saveUserPreferences);
                }
            }
        });

        // é¡µé¢åŠ è½½æ—¶æ¢å¤åå¥½è®¾ç½®
        setTimeout(loadUserPreferences, 100);

        // ===== ç»“æŸè„šæœ¬ =====
    </script>
</body>
</html>