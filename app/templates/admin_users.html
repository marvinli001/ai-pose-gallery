<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>用户管理 - AI姿势参考图库</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <style>
        /* ===== 全局样式 ===== */
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --success-gradient: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
            --warning-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --info-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --danger-gradient: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
            --shadow-light: 0 2px 10px rgba(0,0,0,0.1);
            --shadow-medium: 0 5px 20px rgba(0,0,0,0.15);
            --shadow-heavy: 0 10px 30px rgba(0,0,0,0.2);
            --border-radius: 15px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #2c3e50;
        }

        /* ===== 容器布局 ===== */
        .main-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 25px;
            margin: 20px;
            overflow: hidden;
            box-shadow: var(--shadow-heavy);
            min-height: calc(100vh - 40px);
        }

        /* ===== 页面头部 ===== */
        .admin-header {
            background: var(--success-gradient);
            color: white;
            padding: 2.5rem 2rem;
            position: relative;
            overflow: hidden;
        }

        .admin-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="white" opacity="0.1"/><circle cx="75" cy="75" r="1.5" fill="white" opacity="0.08"/><circle cx="50" cy="10" r="0.5" fill="white" opacity="0.12"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
        }

        .admin-header .row {
            position: relative;
            z-index: 2;
        }

        .admin-header h1 {
            font-weight: 700;
            font-size: 2.2rem;
            margin-bottom: 0.5rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .admin-header p {
            opacity: 0.85;
            font-size: 1.1rem;
        }

        /* ===== 统计卡片 ===== */
        .stats-cards {
            padding: 2rem;
            margin-bottom: 1rem;
        }

        .stat-card {
            background: linear-gradient(135deg, #fff 0%, #f8f9ff 100%);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: var(--shadow-medium);
            transition: var(--transition);
            height: 100%;
            border: 1px solid rgba(102, 126, 234, 0.1);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--success-gradient);
        }

        .stat-card:hover {
            transform: translateY(-10px) scale(1.02);
            box-shadow: 0 20px 40px rgba(86, 171, 47, 0.2);
        }

        .stat-card .fa-2x {
            background: var(--success-gradient);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
            margin-bottom: 0.5rem;
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 800;
            margin: 0.5rem 0;
            background: var(--success-gradient);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #6c757d;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* ===== 筛选区域 ===== */
        .filter-section {
            background: linear-gradient(135deg, #fff 0%, #f8f9ff 100%);
            padding: 2rem;
            margin: 0 2rem 2rem;
            border-radius: 20px;
            box-shadow: var(--shadow-medium);
            border: 1px solid rgba(102, 126, 234, 0.1);
        }

        /* ===== 批量操作栏 ===== */
        .batch-actions-bar {
            background: var(--success-gradient);
            color: white;
            padding: 1.5rem 2rem;
            margin: 0 2rem 2rem;
            border-radius: 20px;
            display: none;
            box-shadow: var(--shadow-medium);
            position: relative;
            overflow: hidden;
        }

        .batch-actions-bar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 10px,
                rgba(255,255,255,0.05) 10px,
                rgba(255,255,255,0.05) 20px
            );
        }

        .batch-actions-bar .row {
            position: relative;
            z-index: 1;
        }

        /* ===== 表格容器 ===== */
        .table-container {
            background: linear-gradient(135deg, #fff 0%, #f8f9ff 100%);
            border-radius: 20px;
            margin: 0 2rem 2rem;
            overflow: hidden;
            box-shadow: var(--shadow-medium);
            border: 1px solid rgba(102, 126, 234, 0.1);
        }

        .table {
            margin: 0;
        }

        .table thead {
            background: var(--success-gradient);
            color: white;
        }

        .table th {
            border: none;
            padding: 1.2rem 1rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 0.85rem;
        }

        .table td {
            border: none;
            padding: 1rem;
            vertical-align: middle;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        .table tbody tr {
            transition: var(--transition);
        }

        .table tbody tr:hover {
            background: rgba(86, 171, 47, 0.05);
            transform: scale(1.01);
        }

        .selected-row {
            background: rgba(86, 171, 47, 0.15) !important;
            border-left: 4px solid #56ab2f;
        }

        /* ===== 用户头像 ===== */
        .user-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--success-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.4rem;
            box-shadow: var(--shadow-light);
            transition: var(--transition);
            border: 3px solid rgba(255, 255, 255, 0.8);
        }

        .user-avatar:hover {
            transform: scale(1.1) rotate(5deg);
            box-shadow: var(--shadow-medium);
        }

        /* ===== 角色徽章 ===== */
        .role-badge {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
        }

        .role-user { 
            background: linear-gradient(135deg, #e3f2fd, #bbdefb); 
            color: #1565c0; 
        }

        .role-moderator { 
            background: linear-gradient(135deg, #fff3e0, #ffcc80); 
            color: #e65100; 
        }

        .role-admin { 
            background: linear-gradient(135deg, #ffebee, #ffcdd2); 
            color: #c62828; 
        }

        /* ===== 活跃度指示器 ===== */
        .activity-indicator {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 0.5rem;
            box-shadow: 0 0 10px currentColor;
            animation: pulse 2s infinite;
        }

        .activity-today { 
            background: #4caf50; 
            box-shadow: 0 0 10px #4caf50;
        }

        .activity-week { 
            background: #ff9800; 
            box-shadow: 0 0 10px #ff9800;
        }

        .activity-month { 
            background: #2196f3; 
            box-shadow: 0 0 10px #2196f3;
        }

        .activity-older { 
            background: #9e9e9e; 
            box-shadow: 0 0 10px #9e9e9e;
        }

        .activity-never { 
            background: #f44336; 
            box-shadow: 0 0 10px #f44336;
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* ===== 统计迷你卡片 ===== */
        .stats-mini {
            font-size: 0.75rem;
            color: #6c757d;
            background: rgba(0,0,0,0.03);
            padding: 0.3rem 0.6rem;
            border-radius: 10px;
            margin-top: 0.3rem;
        }

        /* ===== 按钮样式 ===== */
        .btn {
            border-radius: 12px;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            transition: var(--transition);
            border: none;
            position: relative;
            overflow: hidden;
            font-size: 0.95rem;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn-primary {
            background: var(--primary-gradient);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: var(--success-gradient);
            box-shadow: 0 4px 15px rgba(86, 171, 47, 0.3);
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(86, 171, 47, 0.4);
        }

        .btn-info {
            background: var(--info-gradient);
            box-shadow: 0 4px 15px rgba(79, 172, 254, 0.3);
        }

        .btn-warning {
            background: var(--warning-gradient);
            box-shadow: 0 4px 15px rgba(240, 147, 251, 0.3);
        }

        .btn-danger {
            background: var(--danger-gradient);
            box-shadow: 0 4px 15px rgba(255, 65, 108, 0.3);
        }

        .btn-light {
            background: rgba(255,255,255,0.9);
            color: #2c3e50;
            backdrop-filter: blur(10px);
        }

        .btn-outline-light {
            border: 2px solid rgba(255,255,255,0.8);
            color: white;
            background: transparent;
        }

        .btn-outline-light:hover {
            background: rgba(255,255,255,0.2);
            color: white;
        }

        .btn-group-vertical .btn {
            margin-bottom: 0.3rem;
            border-radius: 8px;
            padding: 0.4rem 0.8rem;
            font-size: 0.8rem;
        }

        /* ===== 表单控件 ===== */
        .form-control, .form-select {
            border-radius: 12px;
            border: 2px solid rgba(0,0,0,0.1);
            padding: 0.75rem 1rem;
            transition: var(--transition);
            background: rgba(255,255,255,0.9);
            font-size: 0.95rem;
        }

        .form-control:focus, .form-select:focus {
            border-color: #56ab2f;
            box-shadow: 0 0 0 0.2rem rgba(86, 171, 47, 0.25);
            background: white;
        }

        .form-label {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }

        /* ===== 分页 ===== */
        .pagination {
            margin: 0;
        }

        .page-link {
            border: none;
            color: #56ab2f;
            padding: 0.75rem 1rem;
            margin: 0 0.2rem;
            border-radius: 12px;
            transition: var(--transition);
            font-weight: 600;
        }

        .page-link:hover {
            background: var(--success-gradient);
            color: white;
            transform: translateY(-2px);
        }

        .page-item.active .page-link {
            background: var(--success-gradient);
            color: white;
            box-shadow: var(--shadow-light);
        }

        /* ===== 模态框 ===== */
        .modal-content {
            border-radius: 20px;
            border: none;
            box-shadow: var(--shadow-heavy);
            overflow: hidden;
        }

        .modal-header {
            background: var(--success-gradient);
            color: white;
            border: none;
            padding: 1.5rem 2rem;
        }

        .modal-body {
            padding: 2rem;
        }

        .modal-footer {
            border: none;
            padding: 1.5rem 2rem;
            background: rgba(0,0,0,0.02);
        }

        .btn-close-white {
            filter: brightness(0) invert(1);
        }

        /* ===== 加载遮罩 ===== */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            display: none;
            backdrop-filter: blur(10px);
        }

        .loading-content {
            background: white;
            padding: 3rem;
            border-radius: 20px;
            text-align: center;
            box-shadow: var(--shadow-heavy);
            animation: loadingPulse 2s ease-in-out infinite;
        }

        @keyframes loadingPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* ===== 通知样式 ===== */
        .alert {
            border-radius: var(--border-radius);
            border: none;
            padding: 1rem 1.5rem;
            font-weight: 500;
            box-shadow: var(--shadow-light);
        }

        .alert-success {
            background: linear-gradient(135deg, #d4edda, #a8e6cf);
            color: #155724;
        }

        .alert-danger {
            background: linear-gradient(135deg, #f8d7da, #fab1a0);
            color: #721c24;
        }

        .alert-info {
            background: linear-gradient(135deg, #cce7ff, #a8d8ea);
            color: #0c5460;
        }

        .alert-warning {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
            color: #856404;
        }

        /* ===== 图表容器 ===== */
        .chart-container {
            background: white;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--shadow-light);
            margin-bottom: 1rem;
        }

        /* ===== 徽章样式 ===== */
        .badge {
            border-radius: 20px;
            padding: 0.5rem 1rem;
            font-weight: 600;
        }

        .badge.bg-success {
            background: var(--success-gradient) !important;
        }

        .badge.bg-danger {
            background: var(--danger-gradient) !important;
        }

        .badge.bg-primary {
            background: var(--primary-gradient) !important;
        }

        .badge.bg-warning {
            background: var(--warning-gradient) !important;
        }

        .badge.bg-info {
            background: var(--info-gradient) !important;
        }

        /* ===== 响应式设计 ===== */
        @media (max-width: 768px) {
            .main-container {
                margin: 10px;
                border-radius: 20px;
            }
            
            .admin-header {
                padding: 2rem 1.5rem;
            }
            
            .admin-header h1 {
                font-size: 1.8rem;
            }
            
            .stats-cards, .filter-section, .batch-actions-bar, .table-container {
                margin-left: 1rem;
                margin-right: 1rem;
                padding: 1.5rem;
            }
            
            .stat-card {
                padding: 1.5rem;
                margin-bottom: 1rem;
            }
            
            .stat-number {
                font-size: 2rem;
            }
            
            .table-responsive {
                font-size: 0.875rem;
            }
            
            .user-avatar {
                width: 40px;
                height: 40px;
                font-size: 1rem;
            }
        }

        /* ===== 滚动条样式 ===== */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.1);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--success-gradient);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #4a8c2a, #7bc96f);
        }

        /* ===== 动画增强 ===== */
        .animate-fade-in {
            animation: fadeIn 0.6s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .animate-slide-up {
            animation: slideUp 0.5s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ===== 特殊效果 ===== */
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .glow-effect {
            box-shadow: 0 0 20px rgba(86, 171, 47, 0.3);
        }

        .pulse-animation {
            animation: pulse 2s infinite;
        }

        /* ===== 工具提示 ===== */
        [data-tooltip] {
            position: relative;
            cursor: help;
        }

        [data-tooltip]::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.8rem;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        [data-tooltip]:hover::after {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(-5px);
        }
    </style>
</head>
<body>
    <!-- 顶部导航 -->
    {% include "components/admin_nav.html" %}

    <div class="main-container animate-fade-in">
        <!-- 页面标题 -->
        <div class="admin-header">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1>
                        <i class="fas fa-users me-3"></i>用户管理中心
                    </h1>
                    <p class="mb-0">智能管理系统用户和权限 · 批量操作 · 数据分析 · 用户洞察</p>
                </div>
                <div class="col-md-4 text-end">
                    <div class="btn-group" role="group">
                        <button class="btn btn-light" onclick="showCreateUserModal()" data-tooltip="创建新用户">
                            <i class="fas fa-user-plus me-2"></i>创建用户
                        </button>
                        <button class="btn btn-light" onclick="refreshData()" data-tooltip="刷新所有数据">
                            <i class="fas fa-sync-alt me-2"></i>刷新数据
                        </button>
                        <button class="btn btn-light" onclick="showAnalytics()" data-tooltip="查看用户分析">
                            <i class="fas fa-chart-bar me-2"></i>用户分析
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 统计卡片 -->
        <div class="stats-cards">
            <div class="row">
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="stat-card animate-slide-up">
                        <div class="d-flex align-items-center justify-content-between">
                            <div>
                                <div class="stat-label">总用户数</div>
                                <div class="stat-number" id="totalUsers">-</div>
                                <div class="small text-muted">
                                    <i class="fas fa-database me-1"></i>
                                    系统注册用户
                                </div>
                            </div>
                            <div>
                                <i class="fas fa-users fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="stat-card animate-slide-up" style="animation-delay: 0.1s;">
                        <div class="d-flex align-items-center justify-content-between">
                            <div>
                                <div class="stat-label">活跃用户</div>
                                <div class="stat-number" id="activeUsers">-</div>
                                <div class="small text-success">
                                    <i class="fas fa-user-check me-1"></i>
                                    账户正常
                                </div>
                            </div>
                            <div>
                                <i class="fas fa-user-check fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="stat-card animate-slide-up" style="animation-delay: 0.2s;">
                        <div class="d-flex align-items-center justify-content-between">
                            <div>
                                <div class="stat-label">今日活跃</div>
                                <div class="stat-number" id="todayActive">-</div>
                                <div class="small text-warning">
                                    <i class="fas fa-clock me-1"></i>
                                    今天登录
                                </div>
                            </div>
                            <div>
                                <i class="fas fa-clock fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="stat-card animate-slide-up" style="animation-delay: 0.3s;">
                        <div class="d-flex align-items-center justify-content-between">
                            <div>
                                <div class="stat-label">管理员</div>
                                <div class="stat-number" id="adminUsers">-</div>
                                <div class="small text-danger">
                                    <i class="fas fa-user-shield me-1"></i>
                                    高权限用户
                                </div>
                            </div>
                            <div>
                                <i class="fas fa-user-shield fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 筛选和搜索 -->
        <div class="filter-section">
            <div class="row align-items-end">
                <div class="col-md-2">
                    <label class="form-label">
                        <i class="fas fa-user-tag me-1"></i>角色筛选
                    </label>
                    <select class="form-select" id="roleFilter" onchange="loadUsers()">
                        <option value="">🔄 全部角色</option>
                        <option value="user">👤 普通用户</option>
                        <option value="moderator">👮 版主</option>
                        <option value="admin">👑 管理员</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">
                        <i class="fas fa-toggle-on me-1"></i>状态筛选
                    </label>
                    <select class="form-select" id="statusFilter" onchange="loadUsers()">
                        <option value="">📋 全部状态</option>
                        <option value="active">✅ 活跃</option>
                        <option value="inactive">❌ 禁用</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">
                        <i class="fas fa-certificate me-1"></i>验证状态
                    </label>
                    <select class="form-select" id="verifiedFilter" onchange="loadUsers()">
                        <option value="">🔄 全部</option>
                        <option value="true">✅ 已验证</option>
                        <option value="false">⏳ 未验证</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">
                        <i class="fas fa-search me-1"></i>智能搜索
                    </label>
                    <input type="text" class="form-control" id="searchInput" 
                           placeholder="搜索用户名、邮箱、真实姓名..." onkeyup="searchUsers(event)">
                </div>
                <div class="col-md-3">
                    <label class="form-label">
                        <i class="fas fa-tools me-1"></i>快速操作
                    </label>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-primary" onclick="toggleBatchActions()" data-tooltip="批量管理用户">
                            <i class="fas fa-tasks me-1"></i>批量操作
                        </button>
                        <button class="btn btn-outline-success" onclick="exportData()" data-tooltip="导出用户数据">
                            <i class="fas fa-download me-1"></i>导出
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 批量操作栏 -->
        <div class="batch-actions-bar" id="batchActionsBar">
            <div class="row align-items-center">
                <div class="col-md-2">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                        <label class="form-check-label text-white fw-bold">
                            <i class="fas fa-check-square me-1"></i>全选
                        </label>
                    </div>
                </div>
                <div class="col-md-8">
                    <div class="d-flex align-items-center gap-2 flex-wrap">
                        <div class="btn-group" role="group">
                            <button class="btn btn-outline-light btn-sm" onclick="batchAction('activate')" data-tooltip="激活选中用户">
                                <i class="fas fa-check me-1"></i>激活
                            </button>
                            <button class="btn btn-outline-light btn-sm" onclick="batchAction('deactivate')" data-tooltip="禁用选中用户">
                                <i class="fas fa-ban me-1"></i>禁用
                            </button>
                            <button class="btn btn-outline-light btn-sm" onclick="batchAction('verify')" data-tooltip="验证选中用户">
                                <i class="fas fa-certificate me-1"></i>验证
                            </button>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            <select class="form-select form-select-sm text-dark" id="batchRoleSelect" style="width: auto;">
                                <option value="">批量设置角色</option>
                                <option value="user">👤 普通用户</option>
                                <option value="moderator">👮 版主</option>
                                <option value="admin">👑 管理员</option>
                            </select>
                            <button class="btn btn-outline-light btn-sm" onclick="batchChangeRole()" data-tooltip="应用选中角色">
                                <i class="fas fa-user-cog me-1"></i>应用角色
                            </button>
                        </div>
                    </div>
                </div>
                <div class="col-md-2 text-end">
                    <span id="selectedCount" class="text-white fw-bold">
                        <i class="fas fa-check-circle me-1"></i>已选择 0 项
                    </span>
                </div>
            </div>
        </div>

        <!-- 用户列表 -->
        <div class="table-container">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th width="50" class="select-column" style="display: none;">
                                <input type="checkbox" id="selectAllHeader" onchange="toggleSelectAll()">
                            </th>
                            <th width="100">
                                <i class="fas fa-user-circle me-1"></i>头像
                            </th>
                            <th>
                                <i class="fas fa-id-card me-1"></i>用户信息
                            </th>
                            <th>
                                <i class="fas fa-user-tag me-1"></i>角色
                            </th>
                            <th>
                                <i class="fas fa-toggle-on me-1"></i>状态
                            </th>
                            <th>
                                <i class="fas fa-chart-pulse me-1"></i>活跃度
                            </th>
                            <th>
                                <i class="fas fa-chart-bar me-1"></i>统计
                            </th>
                            <th>
                                <i class="fas fa-calendar me-1"></i>注册时间
                            </th>
                            <th width="150">
                                <i class="fas fa-cogs me-1"></i>操作
                            </th>
                        </tr>
                    </thead>
                    <tbody id="userTableBody">
                        <tr>
                            <td colspan="9" class="text-center py-5">
                                <div class="spinner-border text-primary pulse-animation" role="status" style="width: 3rem; height: 3rem;">
                                    <span class="visually-hidden">加载中...</span>
                                </div>
                                <p class="mt-3 text-muted fw-semibold">正在加载用户数据...</p>
                                <small class="text-muted">请稍候，系统正在处理您的请求</small>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- 分页 -->
            <div class="d-flex justify-content-between align-items-center p-3 border-top bg-light">
                <div>
                    <span class="text-muted fw-semibold" id="pageInfo">
                        <i class="fas fa-info-circle me-1"></i>显示 0 - 0 条，共 0 条记录
                    </span>
                </div>
                <nav>
                    <ul class="pagination mb-0" id="pagination">
                        <!-- 分页按钮将在这里动态生成 -->
                    </ul>
                </nav>
            </div>
        </div>
    </div>

    <!-- 加载遮罩 -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
                <span class="visually-hidden">加载中...</span>
            </div>
            <h5 id="loadingText">系统处理中...</h5>
            <p class="text-muted mb-0">请稍候，正在执行操作</p>
        </div>
    </div>

    <script>
        // 全局变量
        let currentPage = 1;
        let totalPages = 1;
        let selectedUsers = new Set();
        let batchActionsVisible = false;
        let currentData = null;

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            loadStats();
            loadUsers();
            
            // 设置自动刷新
            setInterval(loadStats, 60000); // 1分钟刷新统计
        });

        // 检查用户权限
        async function checkAuth() {
            try {
                const response = await fetch('/api/auth/check');
                const data = await response.json();
                
                if (!data.authenticated) {
                    window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname);
                    return;
                }
                
                if (data.user.role !== 'admin' && data.user.role !== 'moderator') {
                    showError('您没有管理员权限访问此页面');
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 2000);
                    return;
                }
            } catch (error) {
                console.error('权限检查失败:', error);
                showError('权限验证失败，请重新登录');
                setTimeout(() => {
                    window.location.href = '/login';
                }, 2000);
            }
        }

        // 加载统计数据
        async function loadStats() {
            try {
                const response = await fetch('/api/admin/stats');
                const data = await response.json();
                
                if (data.success) {
                    // 使用动画效果更新数字
                    animateNumber('totalUsers', data.data.overview.total_users || 0);
                    animateNumber('activeUsers', data.data.overview.active_users || 0);
                    animateNumber('todayActive', data.data.today.active_users || 0);
                    animateNumber('adminUsers', data.data.overview.admin_users || 0);
                }
            } catch (error) {
                console.error('加载统计失败:', error);
            }
        }

        // 数字动画效果
        function animateNumber(elementId, targetValue) {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            const currentValue = parseInt(element.textContent.replace(/[^\d]/g, '')) || 0;
            const difference = targetValue - currentValue;
            const duration = 1500;
            const steps = 30;
            const stepValue = difference / steps;
            
            let currentStep = 0;
            const timer = setInterval(() => {
                currentStep++;
                const newValue = Math.round(currentValue + (stepValue * currentStep));
                element.textContent = formatNumber(newValue);
                
                if (currentStep >= steps) {
                    element.textContent = formatNumber(targetValue);
                    clearInterval(timer);
                }
            }, duration / steps);
        }

        function formatNumber(num) {
            if (num >= 1000000) {
                return (num / 1000000).toFixed(1) + 'M';
            } else if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'K';
            }
            return num.toString();
        }

        // 加载用户列表
        async function loadUsers(page = 1) {
            try {
                const role = document.getElementById('roleFilter').value;
                const status = document.getElementById('statusFilter').value;
                const verified = document.getElementById('verifiedFilter').value;
                const search = document.getElementById('searchInput').value;
                
                const params = new URLSearchParams({
                    page: page,
                    per_page: 20,
                    sort_by: 'created_at',
                    sort_order: 'desc'
                });
                
                if (role) params.append('role', role);
                if (status) params.append('status', status);
                if (verified) params.append('verified', verified);
                if (search) params.append('search', search);
                
                const response = await fetch(`/api/admin/users/list?${params}`);
                const data = await response.json();
                
                if (data.success) {
                    currentData = data.data;
                    displayUsers(data.data.users);
                    updatePagination(data.data.pagination);
                    currentPage = page;
                    totalPages = data.data.pagination.pages;
                } else {
                    showError('加载用户列表失败');
                }
            } catch (error) {
                console.error('加载用户失败:', error);
                showError('网络错误');
            }
        }

        // 显示用户列表
        function displayUsers(users) {
            const tbody = document.getElementById('userTableBody');
            
            if (users.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="text-center py-5">
                            <div class="mb-4">
                                <i class="fas fa-users fa-4x text-muted opacity-50"></i>
                            </div>
                            <h5 class="text-muted">没有找到用户</h5>
                            <p class="text-muted">请尝试调整筛选条件或搜索关键词</p>
                            <button class="btn btn-primary" onclick="loadUsers(1)">
                                <i class="fas fa-refresh me-1"></i>重新加载
                            </button>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = users.map(user => {
                const isSelected = selectedUsers.has(user.id);
                const activityClass = getActivityClass(user.last_login);
                const activityText = getActivityText(user.last_login);
                
                return `
                    <tr id="row_${user.id}" class="${isSelected ? 'selected-row' : ''}">
                        <td class="select-column" style="display: ${batchActionsVisible ? 'table-cell' : 'none'};">
                            <input type="checkbox" class="form-check-input user-checkbox" 
                                   value="${user.id}" onchange="toggleUserSelection(${user.id})"
                                   ${isSelected ? 'checked' : ''}>
                        </td>
                        <td>
                            <div class="user-avatar" title="${user.full_name || user.username}" data-tooltip="点击查看详情" onclick="viewUserDetails(${user.id})">
                                ${(user.full_name || user.username).charAt(0).toUpperCase()}
                            </div>
                        </td>
                        <td>
                            <div class="fw-bold mb-1">
                                <i class="fas fa-user me-1 text-primary"></i>
                                ${user.username}
                            </div>
                            <div class="text-muted small mb-1">
                                <i class="fas fa-envelope me-1"></i>
                                ${user.email}
                            </div>
                            ${user.full_name ? `
                            <div class="text-secondary small">
                                <i class="fas fa-id-badge me-1"></i>
                                ${user.full_name}
                            </div>
                            ` : ''}
                        </td>
                        <td>
                            <span class="role-badge role-${user.role}">
                                ${getRoleIcon(user.role)} ${getRoleText(user.role)}
                            </span>
                        </td>
                        <td>
                            <div class="d-flex flex-column gap-1">
                                <span class="badge bg-${user.is_active ? 'success' : 'danger'}">
                                    ${user.is_active ? '✅ 活跃' : '❌ 禁用'}
                                </span>
                                <span class="badge bg-${user.is_verified ? 'info' : 'secondary'}">
                                    ${user.is_verified ? '📧 已验证' : '⏳ 未验证'}
                                </span>
                            </div>
                        </td>
                        <td>
                            <div class="d-flex align-items-center mb-2">
                                <div class="activity-indicator activity-${activityClass}"></div>
                                <small class="fw-semibold">${activityText}</small>
                            </div>
                            <div class="stats-mini">
                                <i class="fas fa-images me-1"></i>
                                最近: ${user.stats?.recent_uploads || 0} 张
                            </div>
                        </td>
                        <td>
                            <div class="stats-mini">
                                <div class="mb-1">
                                    <i class="fas fa-upload me-1"></i>
                                    上传: <span class="fw-bold">${user.stats?.total_uploads || 0}</span> 张
                                </div>
                                <div class="mb-1">
                                    <i class="fas fa-hdd me-1"></i>
                                    大小: ${formatFileSize(user.stats?.total_size || 0)}
                                </div>
                                <div>
                                    <i class="fas fa-percentage me-1"></i>
                                    置信度: ${user.stats?.avg_confidence || 0}%
                                </div>
                            </div>
                        </td>
                        <td>
                            <div class="small">
                                <i class="fas fa-calendar-plus me-1 text-success"></i>
                                ${formatDate(user.created_at)}
                            </div>
                        </td>
                        <td>
                            <div class="btn-group-vertical">
                                <button class="btn btn-outline-primary btn-sm" onclick="viewUserDetails(${user.id})" 
                                        data-tooltip="查看详细信息">
                                    <i class="fas fa-info-circle me-1"></i>详情
                                </button>
                                <button class="btn btn-outline-success btn-sm" onclick="editUser(${user.id})" 
                                        data-tooltip="编辑用户信息">
                                    <i class="fas fa-edit me-1"></i>编辑
                                </button>
                                <button class="btn btn-outline-warning btn-sm" onclick="showUserActions(${user.id})" 
                                        data-tooltip="更多操作">
                                    <i class="fas fa-ellipsis-v me-1"></i>更多
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // 更新分页
        function updatePagination(pagination) {
            const paginationEl = document.getElementById('pagination');
            const pageInfo = document.getElementById('pageInfo');
            
            // 更新页面信息
            const start = (pagination.page - 1) * pagination.per_page + 1;
            const end = Math.min(pagination.page * pagination.per_page, pagination.total);
            pageInfo.innerHTML = `
                <i class="fas fa-info-circle me-1"></i>
                显示 <span class="fw-bold">${start}</span> - <span class="fw-bold">${end}</span> 条，
                共 <span class="fw-bold text-success">${pagination.total}</span> 条记录
            `;
            
            // 生成分页按钮
            let paginationHtml = '';
            
            // 上一页
            if (pagination.page > 1) {
                paginationHtml += `
                    <li class="page-item">
                        <a class="page-link" href="#" onclick="loadUsers(${pagination.page - 1})">
                            <i class="fas fa-chevron-left me-1"></i>上一页
                        </a>
                    </li>
                `;
            }
            
            // 页码
            const startPage = Math.max(1, pagination.page - 2);
            const endPage = Math.min(pagination.pages, pagination.page + 2);
            
            for (let i = startPage; i <= endPage; i++) {
                paginationHtml += `
                    <li class="page-item ${i === pagination.page ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="loadUsers(${i})">${i}</a>
                    </li>
                `;
            }
            
            // 下一页
            if (pagination.page < pagination.pages) {
                paginationHtml += `
                    <li class="page-item">
                        <a class="page-link" href="#" onclick="loadUsers(${pagination.page + 1})">
                            下一页<i class="fas fa-chevron-right ms-1"></i>
                        </a>
                    </li>
                `;
            }
            
            paginationEl.innerHTML = paginationHtml;
        }

        // 搜索功能
        function searchUsers(event) {
            if (event.key === 'Enter') {
                loadUsers(1);
            }
        }

        // 批量操作功能
        function toggleBatchActions() {
            batchActionsVisible = !batchActionsVisible;
            const batchBar = document.getElementById('batchActionsBar');
            const selectColumns = document.querySelectorAll('.select-column');
            
            if (batchActionsVisible) {
                batchBar.style.display = 'block';
                selectColumns.forEach(col => col.style.display = 'table-cell');
                showInfo('批量操作模式已启用，请选择要操作的用户');
            } else {
                batchBar.style.display = 'none';
                selectColumns.forEach(col => col.style.display = 'none');
                selectedUsers.clear();
                updateSelectedCount();
                clearSelections();
                showInfo('批量操作模式已关闭');
            }
        }

        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('selectAll') || document.getElementById('selectAllHeader');
            const checkboxes = document.querySelectorAll('.user-checkbox');
            
            if (selectAllCheckbox.checked) {
                checkboxes.forEach(checkbox => {
                    const userId = parseInt(checkbox.value);
                    selectedUsers.add(userId);
                    checkbox.checked = true;
                    document.getElementById(`row_${userId}`).classList.add('selected-row');
                });
            } else {
                selectedUsers.clear();
                checkboxes.forEach(checkbox => {
                    const userId = parseInt(checkbox.value);
                    checkbox.checked = false;
                    document.getElementById(`row_${userId}`).classList.remove('selected-row');
                });
            }
            
            updateSelectedCount();
        }

        function toggleUserSelection(userId) {
            const checkbox = document.querySelector(`input[value="${userId}"]`);
            const row = document.getElementById(`row_${userId}`);
            
            if (selectedUsers.has(userId)) {
                selectedUsers.delete(userId);
                row.classList.remove('selected-row');
            } else {
                selectedUsers.add(userId);
                row.classList.add('selected-row');
            }
            
            updateSelectedCount();
        }

        function updateSelectedCount() {
            const countElement = document.getElementById('selectedCount');
            if (countElement) {
                countElement.innerHTML = `
                    <i class="fas fa-check-circle me-1"></i>
                    已选择 <span class="badge bg-light text-dark">${selectedUsers.size}</span> 项
                `;
            }
        }

        function clearSelections() {
            document.querySelectorAll('.user-checkbox').forEach(checkbox => {
                checkbox.checked = false;
            });
            document.querySelectorAll('.selected-row').forEach(row => {
                row.classList.remove('selected-row');
            });
        }

        // 批量操作执行
        async function batchAction(action) {
            if (selectedUsers.size === 0) {
                showError('请先选择要操作的用户');
                return;
            }
            
            let confirmMessage = '';
            
            switch (action) {
                case 'activate':
                    confirmMessage = `确定要激活选中的 ${selectedUsers.size} 个用户吗？`;
                    break;
                case 'deactivate':
                    confirmMessage = `确定要禁用选中的 ${selectedUsers.size} 个用户吗？`;
                    break;
                case 'verify':
                    confirmMessage = `确定要验证选中的 ${selectedUsers.size} 个用户的邮箱吗？`;
                    break;
                default:
                    return;
            }
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            try {
                showLoading('正在执行批量操作...');
                
                const response = await fetch('/api/admin/users/batch-update', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_ids: Array.from(selectedUsers),
                        action: action
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showSuccess(`✅ 批量操作成功：${result.message}`);
                    selectedUsers.clear();
                    loadUsers(currentPage);
                    loadStats();
                    toggleBatchActions();
                } else {
                    showError(`批量操作失败：${result.detail || '未知错误'}`);
                }
            } catch (error) {
                console.error('批量操作失败:', error);
                showError('网络错误：' + error.message);
            } finally {
                hideLoading();
            }
        }

        async function batchChangeRole() {
            const newRole = document.getElementById('batchRoleSelect').value;
            
            if (!newRole) {
                showError('请选择要设置的角色');
                return;
            }
            
            if (selectedUsers.size === 0) {
                showError('请先选择要操作的用户');
                return;
            }
            
            if (!confirm(`🔄 确定要将选中的 ${selectedUsers.size} 个用户设置为 ${getRoleText(newRole)} 吗？\n\n此操作会立即生效，请谨慎操作。`)) {
                return;
            }
            
            try {
                showLoading('正在更新用户角色...');
                
                const response = await fetch('/api/admin/users/batch-update', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_ids: Array.from(selectedUsers),
                        action: 'change_role',
                        value: newRole
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showSuccess(`✅ 角色更新成功：${result.message}`);
                    selectedUsers.clear();
                    loadUsers(currentPage);
                    toggleBatchActions();
                    document.getElementById('batchRoleSelect').value = '';
                } else {
                    showError(`角色更新失败：${result.detail || '未知错误'}`);
                }
            } catch (error) {
                console.error('角色更新失败:', error);
                showError('网络错误：' + error.message);
            } finally {
                hideLoading();
            }
        }

        // 继续完成其余功能...（由于篇幅限制，这里先展示前半部分）
        // 辅助函数
        function getRoleText(role) {
            const roleMap = {
                'user': '普通用户',
                'moderator': '版主',
                'admin': '管理员'
            };
            return roleMap[role] || role;
        }

        function getRoleIcon(role) {
            const iconMap = {
                'user': '👤',
                'moderator': '👮',
                'admin': '👑'
            };
            return iconMap[role] || '👤';
        }

        function getActivityClass(lastLogin) {
            if (!lastLogin) return 'never';
            
            const now = new Date();
            const loginDate = new Date(lastLogin);
            const diffMs = now - loginDate;
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            
            if (diffDays === 0) return 'today';
            if (diffDays <= 7) return 'week';
            if (diffDays <= 30) return 'month';
            return 'older';
        }

        function getActivityText(lastLogin) {
            if (!lastLogin) return '从未登录';
            
            const now = new Date();
            const loginDate = new Date(lastLogin);
            const diffMs = now - loginDate;
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            
            if (diffDays === 0) return '今天活跃';
            if (diffDays === 1) return '昨天活跃';
            if (diffDays <= 7) return `${diffDays}天前`;
            if (diffDays <= 30) return `${diffDays}天前`;
            return `${Math.floor(diffDays / 30)}个月前`;
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('zh-CN') + ' ' + date.toLocaleTimeString('zh-CN', {hour: '2-digit', minute: '2-digit'});
        }

        function getRankBadgeClass(index) {
            if (index === 0) return 'warning';
            if (index === 1) return 'secondary';
            if (index === 2) return 'dark';
            return 'light';
        }

        // 单个用户操作
        async function viewUserDetails(userId) {
            try {
                showLoading('正在加载用户详情...');
                
                const response = await fetch(`/api/admin/users/${userId}/details`);
                const result = await response.json();
                
                if (result.success) {
                    showUserDetailsModal(result.data);
                } else {
                    showError('获取用户详情失败');
                }
            } catch (error) {
                console.error('获取用户详情失败:', error);
                showError('网络错误：' + error.message);
            } finally {
                hideLoading();
            }
        }

        async function editUser(userId) {
            try {
                showLoading('正在加载用户信息...');
                const response = await fetch(`/api/admin/users/${userId}/details`);
                const result = await response.json();
                
                if (result.success) {
                    showEditUserModal(result.data.user);
                } else {
                    showError('获取用户信息失败');
                }
            } catch (error) {
                console.error('获取用户信息失败:', error);
                showError('网络错误：' + error.message);
            } finally {
                hideLoading();
            }
        }

        function showUserActions(userId) {
            const actionsModalHtml = `
                <div class="modal fade" id="userActionsModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    <i class="fas fa-user-cog me-2"></i>用户操作中心
                                </h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="d-grid gap-3">
                                    <button class="btn btn-outline-primary" onclick="sendMessageToUser(${userId}); bootstrap.Modal.getInstance(document.getElementById('userActionsModal')).hide();">
                                        <i class="fas fa-envelope me-2"></i>发送消息
                                        <small class="d-block text-muted">向用户发送系统通知</small>
                                    </button>
                                    <button class="btn btn-outline-warning" onclick="resetUserPassword(${userId}); bootstrap.Modal.getInstance(document.getElementById('userActionsModal')).hide();">
                                        <i class="fas fa-key me-2"></i>重置密码
                                        <small class="d-block text-muted">为用户生成新密码</small>
                                    </button>
                                    <button class="btn btn-outline-info" onclick="viewUserImages(${userId}); bootstrap.Modal.getInstance(document.getElementById('userActionsModal')).hide();">
                                        <i class="fas fa-images me-2"></i>查看图片
                                        <small class="d-block text-muted">查看用户上传的所有图片</small>
                                    </button>
                                    <hr class="my-2">
                                    <button class="btn btn-outline-danger" onclick="deleteUser(${userId}); bootstrap.Modal.getInstance(document.getElementById('userActionsModal')).hide();">
                                        <i class="fas fa-trash me-2"></i>删除用户
                                        <small class="d-block text-muted">永久删除用户账户</small>
                                    </button>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                    <i class="fas fa-times me-1"></i>取消
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            removeModal('userActionsModal');
            document.body.insertAdjacentHTML('beforeend', actionsModalHtml);
            
            const modal = new bootstrap.Modal(document.getElementById('userActionsModal'));
            modal.show();
        }

        // 显示用户详情模态框
        function showUserDetailsModal(data) {
            const user = data.user;
            const stats = data.image_stats || {};
            
            const modalHtml = `
                <div class="modal fade" id="userDetailsModal" tabindex="-1">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    <i class="fas fa-user me-2"></i>用户详细信息
                                </h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="text-center mb-4">
                                            <div class="user-avatar mx-auto mb-3 glow-effect" style="width: 120px; height: 120px; font-size: 3rem;">
                                                ${(user.full_name || user.username).charAt(0).toUpperCase()}
                                            </div>
                                            <h4 class="fw-bold">${user.username}</h4>
                                            <p class="text-muted mb-2">
                                                <i class="fas fa-envelope me-1"></i>${user.email}
                                            </p>
                                            <span class="role-badge role-${user.role} fs-6">
                                                ${getRoleIcon(user.role)} ${getRoleText(user.role)}
                                            </span>
                                        </div>
                                        
                                        <div class="card shadow">
                                            <div class="card-header">
                                                <h6 class="mb-0">
                                                    <i class="fas fa-info-circle text-primary me-2"></i>基本信息
                                                </h6>
                                            </div>
                                            <div class="card-body">
                                                <table class="table table-sm">
                                                    <tr>
                                                        <th width="80"><i class="fas fa-hashtag me-1"></i>ID</th>
                                                        <td><span class="badge bg-primary">${user.id}</span></td>
                                                    </tr>
                                                    <tr>
                                                        <th><i class="fas fa-id-badge me-1"></i>真实姓名</th>
                                                        <td>${user.full_name || '<em class="text-muted">未设置</em>'}</td>
                                                    </tr>
                                                    <tr>
                                                        <th><i class="fas fa-user-tag me-1"></i>角色</th>
                                                        <td>${getRoleIcon(user.role)} ${getRoleText(user.role)}</td>
                                                    </tr>
                                                    <tr>
                                                        <th><i class="fas fa-toggle-on me-1"></i>状态</th>
                                                        <td>
                                                            <span class="badge bg-${user.is_active ? 'success' : 'danger'}">
                                                                ${user.is_active ? '✅ 活跃' : '❌ 禁用'}
                                                            </span>
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <th><i class="fas fa-certificate me-1"></i>邮箱验证</th>
                                                        <td>
                                                            <span class="badge bg-${user.is_verified ? 'info' : 'secondary'}">
                                                                ${user.is_verified ? '📧 已验证' : '⏳ 未验证'}
                                                            </span>
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <th><i class="fas fa-calendar-plus me-1"></i>注册时间</th>
                                                        <td>${formatDate(user.created_at)}</td>
                                                    </tr>
                                                    <tr>
                                                        <th><i class="fas fa-sign-in-alt me-1"></i>最后登录</th>
                                                        <td>
                                                            ${user.last_login ? formatDate(user.last_login) : 
                                                              '<em class="text-muted">从未登录</em>'}
                                                        </td>
                                                    </tr>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-8">
                                        <!-- 统计信息 -->
                                        <div class="row mb-4">
                                            <div class="col-md-3">
                                                <div class="card text-center bg-primary bg-opacity-10 border-primary">
                                                    <div class="card-body">
                                                        <i class="fas fa-upload fa-2x text-primary mb-2"></i>
                                                        <h4 class="text-primary">${stats.total_count || 0}</h4>
                                                        <small class="text-muted">总上传量</small>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="card text-center bg-success bg-opacity-10 border-success">
                                                    <div class="card-body">
                                                        <i class="fas fa-check-circle fa-2x text-success mb-2"></i>
                                                        <h4 class="text-success">${stats.active_count || 0}</h4>
                                                        <small class="text-muted">活跃图片</small>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="card text-center bg-info bg-opacity-10 border-info">
                                                    <div class="card-body">
                                                        <i class="fas fa-hdd fa-2x text-info mb-2"></i>
                                                        <h4 class="text-info">${formatFileSize(stats.total_size || 0)}</h4>
                                                        <small class="text-muted">总存储</small>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="card text-center bg-warning bg-opacity-10 border-warning">
                                                    <div class="card-body">
                                                        <i class="fas fa-percentage fa-2x text-warning mb-2"></i>
                                                        <h4 class="text-warning">${stats.avg_confidence || 0}%</h4>
                                                        <small class="text-muted">平均置信度</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- AI状态分布 -->
                                        ${data.ai_stats && data.ai_stats.length > 0 ? `
                                        <div class="card mb-4 shadow">
                                            <div class="card-header">
                                                <h6 class="mb-0">
                                                    <i class="fas fa-chart-pie text-success me-2"></i>AI分析状态
                                                </h6>
                                            </div>
                                            <div class="card-body">
                                                <canvas id="userAIStatusChart" width="400" height="200"></canvas>
                                            </div>
                                        </div>
                                        ` : ''}
                                        
                                        <!-- 最近活动 -->
                                        ${data.recent_activity && data.recent_activity.length > 0 ? `
                                        <div class="card mb-4 shadow">
                                            <div class="card-header">
                                                <h6 class="mb-0">
                                                    <i class="fas fa-chart-line text-info me-2"></i>最近30天活动
                                                </h6>
                                            </div>
                                            <div class="card-body">
                                                <canvas id="userActivityChart" width="400" height="150"></canvas>
                                            </div>
                                        </div>
                                        ` : ''}
                                        
                                        <!-- 最近图片 -->
                                        ${data.recent_images && data.recent_images.length > 0 ? `
                                        <div class="card shadow">
                                            <div class="card-header">
                                                <h6 class="mb-0">
                                                    <i class="fas fa-images text-primary me-2"></i>最近上传图片
                                                </h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="table-responsive">
                                                    <table class="table table-sm table-hover">
                                                        <thead class="table-light">
                                                            <tr>
                                                                <th>文件名</th>
                                                                <th>上传时间</th>
                                                                <th>AI状态</th>
                                                                <th>状态</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            ${data.recent_images.map(img => `
                                                                <tr>
                                                                    <td class="text-truncate" style="max-width: 200px;" title="${img.filename}">
                                                                        <i class="fas fa-image me-1 text-primary"></i>
                                                                        ${img.filename}
                                                                    </td>
                                                                    <td>${formatDate(img.upload_time)}</td>
                                                                    <td>
                                                                        <span class="status-badge status-${img.ai_analysis_status}">
                                                                            ${getStatusText(img.ai_analysis_status)}
                                                                        </span>
                                                                    </td>
                                                                    <td>
                                                                        <span class="badge bg-${img.is_active ? 'success' : 'danger'}">
                                                                            ${img.is_active ? '✅ 活跃' : '❌ 禁用'}
                                                                        </span>
                                                                    </td>
                                                                </tr>
                                                            `).join('')}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                        ` : `
                                        <div class="card shadow">
                                            <div class="card-body text-center py-5">
                                                <i class="fas fa-images fa-3x text-muted mb-3"></i>
                                                <h5 class="text-muted">暂无上传图片</h5>
                                                <p class="text-muted">该用户还没有上传任何图片</p>
                                            </div>
                                        </div>
                                        `}
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-primary" onclick="editUser(${user.id}); bootstrap.Modal.getInstance(document.getElementById('userDetailsModal')).hide();">
                                    <i class="fas fa-edit me-1"></i>编辑用户
                                </button>
                                <button type="button" class="btn btn-info" onclick="sendMessageToUser(${user.id}); bootstrap.Modal.getInstance(document.getElementById('userDetailsModal')).hide();">
                                    <i class="fas fa-envelope me-1"></i>发送消息
                                </button>
                                <button type="button" class="btn btn-warning" onclick="showUserActions(${user.id}); bootstrap.Modal.getInstance(document.getElementById('userDetailsModal')).hide();">
                                    <i class="fas fa-cogs me-1"></i>更多操作
                                </button>
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            removeModal('userDetailsModal');
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            const modal = new bootstrap.Modal(document.getElementById('userDetailsModal'));
            modal.show();
            
            // 绘制图表
            setTimeout(() => {
                if (data.ai_stats && data.ai_stats.length > 0) {
                    drawUserAIStatusChart(data.ai_stats);
                }
                if (data.recent_activity && data.recent_activity.length > 0) {
                    drawUserActivityChart(data.recent_activity);
                }
            }, 500);
        }

        // 显示编辑用户模态框
        function showEditUserModal(user) {
            const modalHtml = `
                <div class="modal fade" id="editUserModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    <i class="fas fa-edit me-2"></i>编辑用户信息
                                </h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-md-4 text-center">
                                        <div class="user-avatar mx-auto mb-3" style="width: 100px; height: 100px; font-size: 2.5rem;">
                                            ${(user.full_name || user.username).charAt(0).toUpperCase()}
                                        </div>
                                        <h5>${user.username}</h5>
                                        <p class="text-muted small">${user.email}</p>
                                    </div>
                                    <div class="col-md-8">
                                        <form id="editUserForm">
                                            <input type="hidden" id="editUserId" value="${user.id}">
                                            
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <div class="mb-3">
                                                        <label class="form-label">
                                                            <i class="fas fa-user me-1"></i>用户名
                                                        </label>
                                                        <input type="text" class="form-control" value="${user.username}" readonly>
                                                        <div class="form-text">用户名不可修改</div>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="mb-3">
                                                        <label class="form-label">
                                                            <i class="fas fa-envelope me-1"></i>邮箱
                                                        </label>
                                                        <input type="email" class="form-control" value="${user.email}" readonly>
                                                        <div class="form-text">邮箱不可修改</div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label class="form-label">
                                                    <i class="fas fa-id-badge me-1"></i>真实姓名
                                                </label>
                                                <input type="text" class="form-control" id="editUserFullName" 
                                                       value="${user.full_name || ''}" placeholder="输入真实姓名（可选）">
                                                <div class="form-text">用于显示和身份识别</div>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label class="form-label">
                                                    <i class="fas fa-user-tag me-1"></i>用户角色
                                                </label>
                                                <select class="form-select" id="editUserRole">
                                                    <option value="user" ${user.role === 'user' ? 'selected' : ''}>👤 普通用户</option>
                                                    <option value="moderator" ${user.role === 'moderator' ? 'selected' : ''}>👮 版主</option>
                                                    <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>👑 管理员</option>
                                                </select>
                                                <div class="form-text">角色决定了用户的权限范围</div>
                                            </div>
                                            
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <div class="mb-3">
                                                        <label class="form-label">
                                                            <i class="fas fa-toggle-on me-1"></i>账户状态
                                                        </label>
                                                        <select class="form-select" id="editUserActive">
                                                            <option value="true" ${user.is_active ? 'selected' : ''}>✅ 活跃</option>
                                                            <option value="false" ${!user.is_active ? 'selected' : ''}>❌ 禁用</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="mb-3">
                                                        <label class="form-label">
                                                            <i class="fas fa-certificate me-1"></i>邮箱验证
                                                        </label>
                                                        <select class="form-select" id="editUserVerified">
                                                            <option value="true" ${user.is_verified ? 'selected' : ''}>📧 已验证</option>
                                                            <option value="false" ${!user.is_verified ? 'selected' : ''}>⏳ 未验证</option>
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div class="alert alert-info">
                                                <i class="fas fa-info-circle me-2"></i>
                                                <strong>提示：</strong>修改后的信息将立即生效，请谨慎操作。
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                    <i class="fas fa-times me-1"></i>取消
                                </button>
                                <button type="button" class="btn btn-primary" onclick="saveUserEdit()">
                                    <i class="fas fa-save me-1"></i>保存更改
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            removeModal('editUserModal');
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            const modal = new bootstrap.Modal(document.getElementById('editUserModal'));
            modal.show();
        }

        // 保存用户编辑
        async function saveUserEdit() {
            const userId = document.getElementById('editUserId').value;
            const fullName = document.getElementById('editUserFullName').value;
            const role = document.getElementById('editUserRole').value;
            const isActive = document.getElementById('editUserActive').value === 'true';
            const isVerified = document.getElementById('editUserVerified').value === 'true';
            
            try {
                showLoading('正在保存更改...');
                
                const response = await fetch(`/api/admin/users/${userId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        full_name: fullName,
                        role: role,
                        is_active: isActive,
                        is_verified: isVerified
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showSuccess('✅ 用户信息更新成功！');
                    
                    // 关闭模态框
                    const modal = bootstrap.Modal.getInstance(document.getElementById('editUserModal'));
                    modal.hide();
                    
                    // 刷新列表
                    loadUsers(currentPage);
                    loadStats();
                } else {
                    showError('更新失败：' + (result.detail || '未知错误'));
                }
            } catch (error) {
                console.error('保存用户编辑失败:', error);
                showError('网络错误：' + error.message);
            } finally {
                hideLoading();
            }
        }

        // 创建用户功能
        function showCreateUserModal() {
            const modalHtml = `
                <div class="modal fade" id="createUserModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    <i class="fas fa-user-plus me-2"></i>创建新用户
                                </h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-md-12">
                                        <form id="createUserForm">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <div class="mb-3">
                                                        <label class="form-label">
                                                            <i class="fas fa-user me-1"></i>用户名 <span class="text-danger">*</span>
                                                        </label>
                                                        <input type="text" class="form-control" id="createUsername" 
                                                               placeholder="输入用户名" required>
                                                        <div class="form-text">用户名只能包含字母、数字和下划线</div>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="mb-3">
                                                        <label class="form-label">
                                                            <i class="fas fa-envelope me-1"></i>邮箱 <span class="text-danger">*</span>
                                                        </label>
                                                        <input type="email" class="form-control" id="createEmail" 
                                                               placeholder="输入邮箱地址" required>
                                                        <div class="form-text">用于登录和接收通知</div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <div class="mb-3">
                                                        <label class="form-label">
                                                            <i class="fas fa-key me-1"></i>密码 <span class="text-danger">*</span>
                                                        </label>
                                                        <input type="password" class="form-control" id="createPassword" 
                                                               placeholder="输入密码" required>
                                                        <div class="form-text">密码至少6位字符</div>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="mb-3">
                                                        <label class="form-label">
                                                            <i class="fas fa-id-badge me-1"></i>真实姓名
                                                        </label>
                                                        <input type="text" class="form-control" id="createFullName" 
                                                               placeholder="输入真实姓名（可选）">
                                                        <div class="form-text">可选，用于身份识别</div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label class="form-label">
                                                    <i class="fas fa-user-tag me-1"></i>用户角色
                                                </label>
                                                <select class="form-select" id="createRole">
                                                    <option value="user">👤 普通用户</option>
                                                    <option value="moderator">👮 版主</option>
                                                    <option value="admin">👑 管理员</option>
                                                </select>
                                                <div class="form-text">角色决定用户的权限范围</div>
                                            </div>
                                            
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <div class="form-check form-switch">
                                                        <input class="form-check-input" type="checkbox" id="createActive" checked>
                                                        <label class="form-check-label">
                                                            <i class="fas fa-toggle-on me-1"></i>激活账户
                                                        </label>
                                                        <div class="form-text">创建后立即激活账户</div>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="form-check form-switch">
                                                        <input class="form-check-input" type="checkbox" id="createVerified">
                                                        <label class="form-check-label">
                                                            <i class="fas fa-certificate me-1"></i>验证邮箱
                                                        </label>
                                                        <div class="form-text">跳过邮箱验证流程</div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div class="alert alert-success mt-3">
                                                <i class="fas fa-lightbulb me-2"></i>
                                                <strong>提示：</strong>创建成功后，系统将生成用户ID，您可以通过用户管理页面进行后续管理。
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                    <i class="fas fa-times me-1"></i>取消
                                </button>
                                <button type="button" class="btn btn-success" onclick="createUser()">
                                    <i class="fas fa-plus me-1"></i>创建用户
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            removeModal('createUserModal');
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            const modal = new bootstrap.Modal(document.getElementById('createUserModal'));
            modal.show();
        }

        async function createUser() {
            const username = document.getElementById('createUsername').value.trim();
            const email = document.getElementById('createEmail').value.trim();
            const password = document.getElementById('createPassword').value;
            const fullName = document.getElementById('createFullName').value.trim();
            const role = document.getElementById('createRole').value;
            const isActive = document.getElementById('createActive').checked;
            const isVerified = document.getElementById('createVerified').checked;
            
            // 基本验证
            if (!username || !email || !password) {
                showError('请填写所有必填字段');
                return;
            }
            
            if (password.length < 6) {
                showError('密码至少需要6位字符');
                return;
            }
            
            try {
                showLoading('正在创建用户...');
                
                const response = await fetch('/api/admin/users/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username: username,
                        email: email,
                        password: password,
                        full_name: fullName || null,
                        role: role,
                        is_active: isActive,
                        is_verified: isVerified
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showSuccess(`✅ 用户创建成功！用户ID: ${result.user_id}`);
                    
                    // 关闭模态框
                    const modal = bootstrap.Modal.getInstance(document.getElementById('createUserModal'));
                    modal.hide();
                    
                    // 刷新列表
                    loadUsers(1);
                    loadStats();
                } else {
                    showError('创建失败：' + (result.detail || '未知错误'));
                }
            } catch (error) {
                console.error('创建用户失败:', error);
                showError('网络错误：' + error.message);
            } finally {
                hideLoading();
            }
        }

        // 发送消息功能
        async function sendMessageToUser(userId) {
            const modalHtml = `
                <div class="modal fade" id="sendMessageModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    <i class="fas fa-envelope me-2"></i>发送系统消息
                                </h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <form id="sendMessageForm">
                                    <input type="hidden" id="messageUserId" value="${userId}">
                                    
                                    <div class="mb-3">
                                        <label class="form-label">
                                            <i class="fas fa-tag me-1"></i>消息主题 <span class="text-danger">*</span>
                                        </label>
                                        <input type="text" class="form-control" id="messageSubject" 
                                               placeholder="输入消息主题" required>
                                        <div class="form-text">简洁明了的主题，便于用户快速了解</div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">
                                            <i class="fas fa-align-left me-1"></i>消息内容 <span class="text-danger">*</span>
                                        </label>
                                        <textarea class="form-control" id="messageContent" rows="8" 
                                                  placeholder="输入详细的消息内容..." required></textarea>
                                        <div class="form-text">支持换行，建议内容清晰、友好</div>
                                    </div>
                                    
                                    <div class="alert alert-info">
                                        <i class="fas fa-info-circle me-2"></i>
                                        <strong>发送说明：</strong>
                                        <ul class="mb-0 mt-2">
                                            <li>消息将通过邮件发送给用户</li>
                                            <li>请确保内容准确、友好</li>
                                            <li>发送后无法撤回，请谨慎操作</li>
                                        </ul>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                    <i class="fas fa-times me-1"></i>取消
                                </button>
                                <button type="button" class="btn btn-primary" onclick="sendMessage()">
                                    <i class="fas fa-paper-plane me-1"></i>发送消息
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            removeModal('sendMessageModal');
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            const modal = new bootstrap.Modal(document.getElementById('sendMessageModal'));
            modal.show();
        }

        async function sendMessage() {
            const userId = document.getElementById('messageUserId').value;
            const subject = document.getElementById('messageSubject').value.trim();
            const content = document.getElementById('messageContent').value.trim();
            
            if (!subject || !content) {
                showError('请填写主题和消息内容');
                return;
            }
            
            try {
                showLoading('正在发送消息...');
                
                const response = await fetch(`/api/admin/users/${userId}/send-message`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        subject: subject,
                        message: content
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showSuccess('✅ 消息发送成功！');
                    
                    // 关闭模态框
                    const modal = bootstrap.Modal.getInstance(document.getElementById('sendMessageModal'));
                    modal.hide();
                } else {
                    showError('发送失败：' + (result.message || '未知错误'));
                }
            } catch (error) {
                console.error('发送消息失败:', error);
                showError('网络错误：' + error.message);
            } finally {
                hideLoading();
            }
        }

        // 重置密码功能
        async function resetUserPassword(userId) {
            const newPassword = prompt('🔐 请输入新密码（至少6位）：');
            
            if (!newPassword) {
                return;
            }
            
            if (newPassword.length < 6) {
                showError('密码至少需要6位字符');
                return;
            }
            
            const sendNotification = confirm('📧 是否发送密码重置通知邮件给用户？\n\n✅ 确定 = 发送邮件通知\n❌ 取消 = 仅重置密码');
            
            try {
                showLoading('正在重置密码...');
                
                const response = await fetch(`/api/admin/users/${userId}/reset-password`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        new_password: newPassword,
                        send_notification: sendNotification
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showSuccess(result.message);
                } else {
                    showError('重置失败：' + (result.detail || '未知错误'));
                }
            } catch (error) {
                console.error('重置密码失败:', error);
                showError('网络错误：' + error.message);
            } finally {
                hideLoading();
            }
        }

        // 删除用户功能
        async function deleteUser(userId) {
            const transferImages = confirm('🗂️ 选择图片处理方式：\n\n✅ 确定 = 转移图片到当前管理员\n❌ 取消 = 禁用用户的图片');
            
            if (!confirm(`⚠️ 确定要删除这个用户吗？\n\n📸 用户的图片将${transferImages ? '转移到您的账户' : '被禁用'}。\n\n此操作不可撤销，请谨慎操作！`)) {
                return;
            }
            
            try {
                showLoading('正在删除用户...');
                
                const response = await fetch(`/api/admin/users/${userId}?transfer_images=${transferImages}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showSuccess(`✅ ${result.message}（影响 ${result.affected_images} 张图片）`);
                    loadUsers(currentPage);
                    loadStats();
                } else {
                    showError('删除失败：' + (result.detail || '未知错误'));
                }
            } catch (error) {
                console.error('删除用户失败:', error);
                showError('网络错误：' + error.message);
            } finally {
                hideLoading();
            }
        }

        // 查看用户图片
        function viewUserImages(userId) {
            // 跳转到图片管理页面，预填充该用户的筛选条件
            window.open(`/admin/images?uploader=${encodeURIComponent(userId)}`, '_blank');
        }

        // 用户分析功能
        async function showAnalytics() {
            try {
                showLoading('正在加载用户分析数据...');
                
                const response = await fetch('/api/admin/users/analytics');
                const data = await response.json();
                
                if (data.success) {
                    showAnalyticsModal(data.data);
                } else {
                    showError('加载分析数据失败');
                }
            } catch (error) {
                console.error('加载分析失败:', error);
                showError('网络错误：' + error.message);
            } finally {
                hideLoading();
            }
        }

        function showAnalyticsModal(data) {
            const modalHtml = `
                <div class="modal fade" id="analyticsModal" tabindex="-1">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    <i class="fas fa-chart-bar me-2"></i>用户数据分析报告
                                </h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <!-- 注册趋势 -->
                                    <div class="col-md-6 mb-4">
                                        <div class="chart-container">
                                            <h6>
                                                <i class="fas fa-chart-line text-primary me-2"></i>用户注册趋势（近30天）
                                            </h6>
                                            <canvas id="registrationTrendChart" width="400" height="250"></canvas>
                                        </div>
                                    </div>
                                    
                                    <!-- 活跃度分布 -->
                                    <div class="col-md-6 mb-4">
                                        <div class="chart-container">
                                            <h6>
                                                <i class="fas fa-chart-pie text-success me-2"></i>用户活跃度分布
                                            </h6>
                                            <canvas id="activityDistChart" width="400" height="250"></canvas>
                                        </div>
                                    </div>
                                    
                                    <!-- 角色分布 -->
                                    <div class="col-md-6 mb-4">
                                        <div class="chart-container">
                                            <h6>
                                                <i class="fas fa-chart-doughnut text-warning me-2"></i>用户角色分布
                                            </h6>
                                            <canvas id="roleDistChart" width="400" height="250"></canvas>
                                        </div>
                                    </div>
                                    
                                    <!-- 上传活跃度 -->
                                    <div class="col-md-6 mb-4">
                                        <div class="chart-container">
                                            <h6>
                                                <i class="fas fa-chart-bar text-info me-2"></i>上传活跃度分布
                                            </h6>
                                            <canvas id="uploadDistChart" width="400" height="250"></canvas>
                                        </div>
                                    </div>
                                    
                                    <!-- 最活跃用户排行 -->
                                    <div class="col-md-12">
                                        <div class="chart-container">
                                            <h6>
                                                <i class="fas fa-trophy text-warning me-2"></i>最活跃用户排行榜
                                            </h6>
                                            <div class="table-responsive">
                                                <table class="table table-striped table-hover">
                                                    <thead class="table-light">
                                                        <tr>
                                                            <th width="80">排名</th>
                                                            <th>用户名</th>
                                                            <th>上传数量</th>
                                                            <th>总存储大小</th>
                                                            <th>平均置信度</th>
                                                            <th>最后活跃</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        ${data.top_uploaders?.map((user, index) => `
                                                            <tr>
                                                                <td>
                                                                    <span class="badge bg-${getRankBadgeClass(index)} fs-6">
                                                                        ${getRankIcon(index)} ${index + 1}
                                                                    </span>
                                                                </td>
                                                                <td>
                                                                    <div class="d-flex align-items-center">
                                                                        <div class="user-avatar me-2" style="width: 32px; height: 32px; font-size: 0.8rem;">
                                                                            ${user.username.charAt(0).toUpperCase()}
                                                                        </div>
                                                                        <div>
                                                                            <div class="fw-bold">${user.username}</div>
                                                                            <small class="text-muted">${getRoleIcon(user.role)} ${getRoleText(user.role)}</small>
                                                                        </div>
                                                                    </div>
                                                                </td>
                                                                <td>
                                                                    <span class="badge bg-primary fs-6">
                                                                        <i class="fas fa-images me-1"></i>${user.upload_count}
                                                                    </span>
                                                                </td>
                                                                <td>
                                                                    <span class="fw-bold">${formatFileSize(user.total_size)}</span>
                                                                </td>
                                                                <td>
                                                                    <div class="d-flex align-items-center">
                                                                        <div class="confidence-bar me-2" style="width: 50px; height: 6px;">
                                                                            <div class="confidence-fill bg-${getConfidenceColor(user.avg_confidence / 100)}" 
                                                                                 style="width: ${user.avg_confidence}%"></div>
                                                                        </div>
                                                                        <small>${user.avg_confidence}%</small>
                                                                    </div>
                                                                </td>
                                                                <td>
                                                                    <small class="text-muted">
                                                                        ${user.last_login ? formatDate(user.last_login) : '从未登录'}
                                                                    </small>
                                                                </td>
                                                            </tr>
                                                        `).join('') || '<tr><td colspan="6" class="text-center text-muted">暂无数据</td></tr>'}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <div class="text-muted me-auto">
                                    <small>
                                        <i class="fas fa-clock me-1"></i>
                                        报告生成时间: ${new Date().toLocaleString('zh-CN')}
                                    </small>
                                </div>
                                <button type="button" class="btn btn-success" onclick="exportAnalyticsReport()">
                                    <i class="fas fa-download me-1"></i>导出报告
                                </button>
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            removeModal('analyticsModal');
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            const modal = new bootstrap.Modal(document.getElementById('analyticsModal'));
            modal.show();
            
            // 等待模态框显示后绘制图表
            setTimeout(() => {
                if (data.registration_trend) drawRegistrationTrendChart(data.registration_trend);
                if (data.activity_distribution) drawActivityDistChart(data.activity_distribution);
                if (data.role_distribution) drawRoleDistChart(data.role_distribution);
                if (data.upload_distribution) drawUploadDistChart(data.upload_distribution);
            }, 500);
        }

        // 导出数据
        async function exportData() {
            const includeStats = confirm('📊 是否包含详细统计数据？\n\n✅ 确定 = 包含统计\n❌ 取消 = 仅基本信息');
            const format = prompt('📁 选择导出格式：\n\n1️⃣ = CSV格式 (Excel兼容)\n2️⃣ = JSON格式 (程序处理)', '1');
            
            if (!format || !['1', '2'].includes(format)) {
                return;
            }
            
            const exportFormat = format === '1' ? 'csv' : 'json';
            
            try {
                showLoading(`正在导出${exportFormat.toUpperCase()}格式数据...`);
                
                const response = await fetch(`/api/admin/users/export?format=${exportFormat}&include_stats=${includeStats}`);
                
                if (response.ok) {
                    // 创建下载链接
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = `users_export_${new Date().toISOString().slice(0,10)}.${exportFormat}`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    
                    showSuccess(`✅ ${exportFormat.toUpperCase()}数据导出成功！`);
                } else {
                    showError('导出数据失败');
                }
            } catch (error) {
                console.error('导出失败:', error);
                showError('网络错误：' + error.message);
            } finally {
                hideLoading();
            }
        }

        // 刷新数据
        function refreshData() {
            loadStats();
            loadUsers(currentPage);
            showSuccess('🔄 数据已刷新！');
        }

        // 辅助函数
        function getStatusText(status) {
            const statusMap = {
                'pending': '待分析',
                'completed': '已完成',
                'failed': '分析失败',
                'running': '分析中'
            };
            return statusMap[status] || status;
        }

        function getRankIcon(index) {
            if (index === 0) return '🥇';
            if (index === 1) return '🥈';
            if (index === 2) return '🥉';
            return '📍';
        }

        function getConfidenceColor(confidence) {
            if (confidence >= 0.8) return 'success';
            if (confidence >= 0.6) return 'warning';
            return 'danger';
        }

        function removeModal(modalId) {
            const existingModal = document.getElementById(modalId);
            if (existingModal) {
                existingModal.remove();
            }
        }

        // ===== UI通知系统 =====
        function showLoading(text = '处理中...') {
            document.getElementById('loadingText').textContent = text;
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        function showSuccess(message) {
            showNotification(message, 'success', 5000);
        }

        function showError(message) {
            showNotification(message, 'danger', 8000);
        }

        function showWarning(message) {
            showNotification(message, 'warning', 6000);
        }

        function showInfo(message) {
            showNotification(message, 'info', 4000);
        }

        function showNotification(message, type, duration) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed animate-slide-up`;
            alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 10000; min-width: 350px; max-width: 500px;';
            
            const icon = getNotificationIcon(type);
            alertDiv.innerHTML = `
                <div class="d-flex align-items-center">
                    <div class="me-2">${icon}</div>
                    <div class="flex-grow-1">${message}</div>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            document.body.appendChild(alertDiv);
            
            // 自动移除
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.classList.remove('show');
                    setTimeout(() => {
                        if (alertDiv.parentNode) {
                            alertDiv.parentNode.removeChild(alertDiv);
                        }
                    }, 300);
                }
            }, duration);
        }

        function getNotificationIcon(type) {
            const iconMap = {
                'success': '<i class="fas fa-check-circle text-success"></i>',
                'danger': '<i class="fas fa-exclamation-triangle text-danger"></i>',
                'warning': '<i class="fas fa-exclamation-circle text-warning"></i>',
                'info': '<i class="fas fa-info-circle text-info"></i>'
            };
            return iconMap[type] || '<i class="fas fa-bell"></i>';
        }

        // ===== 图表绘制函数 =====
        function drawRegistrationTrendChart(data) {
            const ctx = document.getElementById('registrationTrendChart');
            if (!ctx) return;
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(item => item.date),
                    datasets: [{
                        label: '每日注册数',
                        data: data.map(item => item.count),
                        borderColor: '#56ab2f',
                        backgroundColor: 'rgba(86, 171, 47, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: '#56ab2f',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 5,
                        pointHoverRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            },
                            grid: {
                                color: 'rgba(0,0,0,0.05)'
                            }
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    }
                }
            });
        }

        function drawActivityDistChart(data) {
            const ctx = document.getElementById('activityDistChart');
            if (!ctx) return;
            
            const activityLabels = {
                'today': '今天活跃',
                'week': '本周活跃',
                'month': '本月活跃',
                'older': '较早活跃',
                'never': '从未登录'
            };
            
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: data.map(item => activityLabels[item.activity] || item.activity),
                    datasets: [{
                        data: data.map(item => item.count),
                        backgroundColor: ['#28a745', '#ffc107', '#17a2b8', '#6c757d', '#dc3545'],
                        borderWidth: 0,
                        hoverOffset: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                                    return `${context.label}: ${context.parsed} 人 (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function drawRoleDistChart(data) {
            const ctx = document.getElementById('roleDistChart');
            if (!ctx) return;
            
            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: data.map(item => getRoleText(item.role)),
                    datasets: [{
                        data: data.map(item => item.count),
                        backgroundColor: ['#007bff', '#fd7e14', '#dc3545'],
                        borderWidth: 0,
                        hoverOffset: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                                    return `${context.label}: ${context.parsed} 人 (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function drawUploadDistChart(data) {
            const ctx = document.getElementById('uploadDistChart');
            if (!ctx) return;
            
            const levelLabels = {
                'none': '无上传',
                'low': '低活跃(1-5)',
                'medium': '中活跃(6-20)',
                'high': '高活跃(21-100)',
                'very_high': '超活跃(100+)'
            };
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(item => levelLabels[item.level] || item.level),
                    datasets: [{
                        label: '用户数量',
                        data: data.map(item => item.count),
                        backgroundColor: ['#6c757d', '#17a2b8', '#28a745', '#ffc107', '#fd7e14'],
                        borderWidth: 0,
                        borderRadius: 8,
                        borderSkipped: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.label}: ${context.parsed.y} 人`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            },
                            grid: {
                                color: 'rgba(0,0,0,0.05)'
                            }
                        }
                    }
                }
            });
        }

        function drawUserAIStatusChart(data) {
            const ctx = document.getElementById('userAIStatusChart');
            if (!ctx) return;
            
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: data.map(item => getStatusText(item.status)),
                    datasets: [{
                        data: data.map(item => item.count),
                        backgroundColor: ['#28a745', '#ffc107', '#dc3545', '#17a2b8'],
                        borderWidth: 0,
                        hoverOffset: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                                    return `${context.label}: ${context.parsed} 张 (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function drawUserActivityChart(data) {
            const ctx = document.getElementById('userActivityChart');
            if (!ctx) return;
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(item => item.date),
                    datasets: [{
                        label: '上传数量',
                        data: data.map(item => item.count),
                        borderColor: '#007bff',
                        backgroundColor: 'rgba(0, 123, 255, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: '#007bff',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            },
                            grid: {
                                color: 'rgba(0,0,0,0.05)'
                            }
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    }
                }
            });
        }

        // ===== 占位函数（可以后续实现） =====
        function exportAnalyticsReport() {
            showInfo('📊 分析报告导出功能开发中，敬请期待...');
        }

        // ===== 额外的样式类 =====
        const additionalStyles = `
            <style>
                .confidence-bar {
                    height: 6px;
                    background: rgba(0,0,0,0.1);
                    border-radius: 3px;
                    overflow: hidden;
                }
                
                .confidence-fill {
                    height: 100%;
                    border-radius: 3px;
                    transition: width 0.3s ease;
                }
                
                .status-badge {
                    padding: 0.3rem 0.6rem;
                    border-radius: 10px;
                    font-size: 0.75rem;
                    font-weight: 600;
                    display: inline-flex;
                    align-items: center;
                    gap: 0.2rem;
                }
                
                .status-pending {
                    background: #fff3cd;
                    color: #856404;
                }
                
                .status-completed {
                    background: #d1eddc;
                    color: #155724;
                }
                
                .status-failed {
                    background: #f8d7da;
                    color: #721c24;
                }
                
                .status-running {
                    background: #cce7ff;
                    color: #004085;
                }
                
                .animate-number {
                    transition: all 0.3s ease;
                }
                
                .card:hover .card-body i {
                    animation: iconBounce 0.6s ease;
                }
                
                @keyframes iconBounce {
                    0%, 20%, 60%, 100% {
                        transform: translateY(0);
                    }
                    40% {
                        transform: translateY(-10px);
                    }
                    80% {
                        transform: translateY(-5px);
                    }
                }
                
                .table tbody tr:hover .user-avatar {
                    transform: scale(1.1);
                }
                
                .modal-content {
                    animation: modalSlideIn 0.3s ease;
                }
                
                @keyframes modalSlideIn {
                    from {
                        opacity: 0;
                        transform: translateY(-50px);
                    }
                    to {
                        opacity: 1;
                        transform: translateY(0);
                    }
                }
                
                .chart-container canvas {
                    border-radius: 10px;
                }
                
                .btn:active {
                    transform: translateY(1px) scale(0.98);
                }
                
                .search-highlight {
                    background: linear-gradient(120deg, #f093fb 0%, #f5576c 100%);
                    color: white;
                    padding: 0.2rem 0.4rem;
                    border-radius: 4px;
                    font-weight: bold;
                }
                
                .loading-dots::after {
                    content: '';
                    animation: loadingDots 1.5s infinite;
                }
                
                @keyframes loadingDots {
                    0%, 20% {
                        content: '.';
                    }
                    40% {
                        content: '..';
                    }
                    60%, 100% {
                        content: '...';
                    }
                }
                
                .glass-card {
                    background: rgba(255, 255, 255, 0.1);
                    backdrop-filter: blur(15px);
                    border: 1px solid rgba(255, 255, 255, 0.2);
                    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
                }
                
                .hover-lift {
                    transition: transform 0.3s ease, box-shadow 0.3s ease;
                }
                
                .hover-lift:hover {
                    transform: translateY(-5px);
                    box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
                }
            </style>
        `;
        
        // 插入额外样式
        document.head.insertAdjacentHTML('beforeend', additionalStyles);

        // ===== 键盘快捷键支持 =====
        document.addEventListener('keydown', function(e) {
            // Ctrl/Cmd + R: 刷新数据
            if ((e.ctrlKey || e.metaKey) && e.key === 'r') {
                e.preventDefault();
                refreshData();
            }
            
            // Ctrl/Cmd + N: 创建新用户
            if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
                e.preventDefault();
                showCreateUserModal();
            }
            
            // Ctrl/Cmd + E: 导出数据
            if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
                e.preventDefault();
                exportData();
            }
            
            // Ctrl/Cmd + A: 显示分析
            if ((e.ctrlKey || e.metaKey) && e.key === 'a') {
                e.preventDefault();
                showAnalytics();
            }
            
            // B: 切换批量操作
            if (e.key === 'b' || e.key === 'B') {
                if (!e.target.matches('input, textarea')) {
                    e.preventDefault();
                    toggleBatchActions();
                }
            }
            
            // ESC: 关闭模态框和批量操作
            if (e.key === 'Escape') {
                // 关闭所有模态框
                document.querySelectorAll('.modal.show').forEach(modal => {
                    const bsModal = bootstrap.Modal.getInstance(modal);
                    if (bsModal) {
                        bsModal.hide();
                    }
                });
                
                // 关闭批量操作
                if (batchActionsVisible) {
                    toggleBatchActions();
                }
            }
        });

        // ===== 搜索增强功能 =====
        let searchTimeout;
        
        document.getElementById('searchInput').addEventListener('input', function(e) {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                if (e.target.value.length >= 2 || e.target.value.length === 0) {
                    loadUsers(1);
                }
            }, 500);
        });

        // ===== 页面可见性检测 =====
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                // 页面重新可见时刷新统计数据
                loadStats();
            }
        });

        // ===== 初始化完成提示 =====
        console.log('👥 AI姿势参考图库 - 用户管理系统已就绪');
        console.log('👤 当前用户:', 'marvinli001'); 
        console.log('🕒 初始化时间:', new Date().toLocaleString('zh-CN'));
        console.log('📊 功能模块: 用户管理、批量操作、数据分析、权限控制');
        console.log('⌨️  快捷键: Ctrl+R(刷新) | Ctrl+N(新建) | Ctrl+E(导出) | Ctrl+A(分析) | B(批量操作)');
        console.log('🎨 UI主题: 现代化渐变设计 | 响应式布局 | 动画效果');

        // ===== 性能监控 =====
        window.addEventListener('load', function() {
            const loadTime = performance.now();
            console.log(`⚡ 页面加载完成，耗时: ${Math.round(loadTime)}ms`);
            
            // 如果加载时间过长，显示提示
            if (loadTime > 3000) {
                setTimeout(() => {
                    showInfo('页面加载完成！如果遇到性能问题，请尝试刷新页面。');
                }, 1000);
            }
        });

        // ===== 错误处理增强 =====
        window.addEventListener('error', function(e) {
            console.error('页面错误:', e.error);
            showError('页面发生错误，请刷新重试');
        });

        window.addEventListener('unhandledrejection', function(e) {
            console.error('未处理的Promise错误:', e.reason);
            showError('网络请求失败，请检查连接后重试');
        });

        // ===== 自动保存用户偏好 =====
        function saveUserPreferences() {
            const preferences = {
                roleFilter: document.getElementById('roleFilter').value,
                statusFilter: document.getElementById('statusFilter').value,
                verifiedFilter: document.getElementById('verifiedFilter').value,
                searchInput: document.getElementById('searchInput').value
            };
            localStorage.setItem('userManagementPreferences', JSON.stringify(preferences));
        }

        function loadUserPreferences() {
            const saved = localStorage.getItem('userManagementPreferences');
            if (saved) {
                try {
                    const preferences = JSON.parse(saved);
                    if (preferences.roleFilter) document.getElementById('roleFilter').value = preferences.roleFilter;
                    if (preferences.statusFilter) document.getElementById('statusFilter').value = preferences.statusFilter;
                    if (preferences.verifiedFilter) document.getElementById('verifiedFilter').value = preferences.verifiedFilter;
                    if (preferences.searchInput) document.getElementById('searchInput').value = preferences.searchInput;
                } catch (e) {
                    console.warn('加载用户偏好设置失败:', e);
                }
            }
        }

        // 在筛选器变化时保存偏好
        ['roleFilter', 'statusFilter', 'verifiedFilter', 'searchInput'].forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.addEventListener('change', saveUserPreferences);
                if (id === 'searchInput') {
                    element.addEventListener('input', saveUserPreferences);
                }
            }
        });

        // 页面加载时恢复偏好设置
        setTimeout(loadUserPreferences, 100);

        // ===== 结束脚本 =====
    </script>
</body>
</html>