
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>系统概览 - AI姿势参考图库</title>

{% block content %}
<!-- 顶部导航 -->
{% include "components/admin_nav.html" %}
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
/* 通用样式 */
body {
    background-color: #f8f9fa;
}

.admin-header {
    background: white;
    padding: 1.5rem;
    margin-bottom: 2rem;
    border-radius: 1rem;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.filter-section {
    background: white;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    border-radius: 1rem;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.stats-cards {
    margin-bottom: 2rem;
}

.stat-card {
    background: white;
    border-radius: 1rem;
    padding: 1.5rem;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    transition: transform 0.3s ease;
    height: 100%;
}

.stat-card:hover {
    transform: translateY(-5px);
}

/* 快速操作卡片 */
.action-card {
    background: white;
    border-radius: 1rem;
    padding: 1.5rem;
    border: 2px solid #e9ecef;
    transition: all 0.3s ease;
    text-align: center;
    height: 100%;
    cursor: pointer;
}

.action-card:hover {
    border-color: #007bff;
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,123,255,0.1);
}

.action-icon {
    font-size: 2.5rem;
    margin-bottom: 1rem;
}

/* 标签内容 */
.tab-content {
    display: none;
}

.tab-content.active {
    display: block;
}

/* 日志容器 */
.log-container {
    background: #1e1e1e;
    color: #ffffff;
    font-family: 'Courier New', monospace;
    font-size: 0.85rem;
    max-height: 400px;
    overflow-y: auto;
    padding: 1rem;
    border-radius: 0.5rem;
}

/* 加载遮罩 */
.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    display: none;
}

.loading-content {
    background: white;
    padding: 2rem;
    border-radius: 1rem;
    text-align: center;
}

/* 辅助类 */
.status-badge {
    padding: 0.4rem 0.8rem;
    border-radius: 1rem;
    font-size: 0.75rem;
    font-weight: 600;
}

.status-pending { background: #fff3cd; color: #856404; }
.status-completed { background: #d4edda; color: #155724; }
.status-failed { background: #f8d7da; color: #721c24; }

/* 响应式调整 */
@media (max-width: 768px) {
    .admin-header h1 {
        font-size: 1.5rem;
    }
    
    .filter-section .row > div {
        margin-bottom: 1rem;
    }
    
    .table-responsive {
        font-size: 0.875rem;
    }
    
    .action-buttons {
        min-width: 100px;
    }
}
</style>
</head>
<body>
<div class="container-fluid py-4">
    <!-- 页面标题 -->
    <div class="admin-header">
        <div class="row align-items-center">
            <div class="col-md-6">
                <h1 class="mb-0">
                    <i class="fas fa-chart-line text-primary"></i> 系统概览
                </h1>
                <p class="text-muted mb-0">管理员控制面板</p>
            </div>
            <div class="col-md-6 text-end">
                <button class="btn btn-primary" onclick="loadStats()">
                    <i class="fas fa-sync-alt"></i> 刷新数据
                </button>
                <button class="btn btn-success" onclick="window.location.href='/'">
                    <i class="fas fa-home"></i> 返回首页
                </button>
            </div>
        </div>
    </div>

    <!-- 统计卡片 -->
    <div class="row stats-cards">
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="stat-card">
                <div class="d-flex align-items-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-images fa-2x text-primary"></i>
                    </div>
                    <div class="ms-3">
                        <div class="text-muted small">总图片数</div>
                        <h4 class="mb-0" id="totalImages">-</h4>
                        <div class="small text-muted">今日上传: <span id="todayUploads">-</span></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="stat-card">
                <div class="d-flex align-items-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-users fa-2x text-success"></i>
                    </div>
                    <div class="ms-3">
                        <div class="text-muted small">注册用户</div>
                        <h4 class="mb-0" id="totalUsers">-</h4>
                        <div class="small text-muted">今日新增: <span id="todayRegistrations">-</span></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="stat-card">
                <div class="d-flex align-items-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-brain fa-2x text-warning"></i>
                    </div>
                    <div class="ms-3">
                        <div class="text-muted small">待分析</div>
                        <h4 class="mb-0" id="pendingAnalysis">-</h4>
                        <div class="small text-muted">已完成: <span id="completedAnalysis">-</span></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="stat-card">
                <div class="d-flex align-items-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-tags fa-2x text-info"></i>
                    </div>
                    <div class="ms-3">
                        <div class="text-muted small">标签数量</div>
                        <h4 class="mb-0" id="totalTags">-</h4>
                        <div class="small text-muted">活跃: <span id="activeTags">-</span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 快速操作卡片 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-bolt"></i> 快速操作</h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-3 col-sm-6 mb-3">
                            <div class="action-card" onclick="showTab('ai-tools')">
                                <div class="action-icon">
                                    <i class="fas fa-robot text-primary"></i>
                                </div>
                                <h6>批量AI分析</h6>
                                <p class="text-muted small">批量处理图片AI分析</p>
                            </div>
                        </div>
                        <div class="col-md-3 col-sm-6 mb-3">
                            <div class="action-card" onclick="scanDirectory()">
                                <div class="action-icon">
                                    <i class="fas fa-folder-open text-success"></i>
                                </div>
                                <h6>扫描目录</h6>
                                <p class="text-muted small">导入目录中的图片</p>
                            </div>
                        </div>
                        <div class="col-md-3 col-sm-6 mb-3">
                            <div class="action-card" onclick="clearCache()">
                                <div class="action-icon">
                                    <i class="fas fa-broom text-warning"></i>
                                </div>
                                <h6>清理缓存</h6>
                                <p class="text-muted small">清理系统缓存文件</p>
                            </div>
                        </div>
                        <div class="col-md-3 col-sm-6 mb-3">
                            <div class="action-card" onclick="showSystemInfo()">
                                <div class="action-icon">
                                    <i class="fas fa-server text-info"></i>
                                </div>
                                <h6>系统信息</h6>
                                <p class="text-muted small">查看系统运行状态</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- AI工具内容区域 -->
    <div id="ai-tools" class="tab-content">
        <div class="admin-header mb-4">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h2 class="mb-0">
                        <i class="fas fa-robot text-primary"></i> AI分析工具
                    </h2>
                    <p class="text-muted mb-0">批量处理图片AI分析</p>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-magic"></i> 批量AI分析</h5>
                    </div>
                    <div class="card-body">
                        <p>对图片进行批量AI分析处理</p>
                        <div class="mb-3">
                            <label class="form-label">分析范围:</label>
                            <select class="form-select" id="batchAnalysisFilter">
                                <option value="pending">仅待分析图片</option>
                                <option value="failed">仅失败图片</option>
                                <option value="all">全部图片</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">处理数量限制:</label>
                            <input type="number" class="form-control" id="batchAnalysisLimit" value="10" min="1" max="100">
                        </div>
                        <button class="btn btn-primary" onclick="startBatchAnalysis()">
                            <i class="fas fa-play"></i> 开始批量分析
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-folder-open"></i> 目录扫描</h5>
                    </div>
                    <div class="card-body">
                        <p>扫描指定目录并导入新图片</p>
                        <div class="mb-3">
                            <label class="form-label">目录路径:</label>
                            <input type="text" class="form-control" id="scanDirectoryPath" 
                                   placeholder="例如: uploads" value="uploads">
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="autoAnalyzeScanned" checked>
                            <label class="form-check-label">自动分析新导入的图片</label>
                        </div>
                        <button class="btn btn-info" onclick="startDirectoryScan()">
                            <i class="fas fa-scan"></i> 开始扫描
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 操作日志 -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-list"></i> 操作日志</h5>
                <button class="btn btn-sm btn-outline-secondary" onclick="clearOperationLog()">
                    <i class="fas fa-trash-alt"></i> 清空
                </button>
            </div>
            <div class="card-body">
                <div id="operationLog" class="log-container">
                    <div class="text-muted">等待操作...</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 图片编辑模态框 -->
<div class="modal fade" id="imageEditModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">编辑图片信息</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="text-center">
                            <img id="editImagePreview" class="img-fluid rounded" style="max-height: 300px;" alt="图片预览">
                            <div class="mt-2">
                                <small class="text-muted">
                                    <span id="editImageDimensions"></span> | 
                                    <span id="editImageSize"></span>
                                </small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <form id="imageEditForm">
                            <input type="hidden" id="editImageId">
                            
                            <div class="mb-3">
                                <label class="form-label">文件名</label>
                                <input type="text" class="form-control" id="editImageFilename" readonly>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">上传者</label>
                                <input type="text" class="form-control" id="editImageUploader" readonly>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">AI描述</label>
                                <textarea class="form-control" id="editImageDescription" rows="3" 
                                          placeholder="编辑AI生成的描述..."></textarea>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">状态</label>
                                <select class="form-select" id="editImageStatus">
                                    <option value="true">活跃</option>
                                    <option value="false">禁用</option>
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">自定义标签</label>
                                <input type="text" class="form-control" id="editImageTags" 
                                       placeholder="用逗号分隔多个标签，例如：女性,坐姿,室内">
                                <div class="form-text">现有标签将被替换</div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">AI分析状态</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="editImageAIStatus" readonly>
                                    <span class="input-group-text">
                                        置信度: <span id="editImageConfidence">-</span>%
                                    </span>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="saveImageEdit()">
                    <i class="fas fa-save"></i> 保存更改
                </button>
                <button type="button" class="btn btn-warning" onclick="reanalyzeImageFromModal()">
                    <i class="fas fa-brain"></i> 重新分析
                </button>
                <button type="button" class="btn btn-danger" onclick="deleteImageFromModal()">
                    <i class="fas fa-trash"></i> 删除图片
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 自定义提示词分析模态框 -->
<div class="modal fade" id="customAnalysisModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">自定义AI分析</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">自定义提示词</label>
                    <textarea class="form-control" id="modalCustomPrompt" rows="6" 
                              placeholder="输入自定义的AI分析提示词...

例如：
- 专注分析图片中人物的服装风格和颜色搭配
- 详细描述图片的光线和拍摄角度
- 识别图片中的道具和背景元素"></textarea>
                </div>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <strong>提示：</strong>自定义提示词将覆盖默认的分析模式，请确保提示词清晰明确。
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="startCustomAnalysisFromModal()">
                    <i class="fas fa-brain"></i> 开始分析
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 加载遮罩 -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="loading-content">
        <div class="spinner-border text-primary mb-3" role="status">
            <span class="visually-hidden">加载中...</span>
        </div>
        <h5 id="loadingText">处理中...</h5>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentTab = 'dashboard';
let statsData = null;

document.addEventListener('DOMContentLoaded', function() {
    // 初始化
    checkAdminPermission();
    loadStats();
    initializeUI();
    
    // 启动自动更新
    startStatsAutoUpdate();
    startSystemMonitor();
});

// 页面卸载时停止计时器
window.addEventListener('beforeunload', function() {
    stopStatsAutoUpdate();
    stopSystemMonitor();
});

// 检查管理员权限
async function checkAdminPermission() {
    try {
        const response = await fetch('/api/auth/check');
        const data = await response.json();
        
        if (!data.authenticated) {
            window.location.href = '/login?redirect=/admin';
            return;
        }
        
        if (data.user.role !== 'admin' && data.user.role !== 'moderator') {
            alert('您没有管理员权限');
            window.location.href = '/';
            return;
        }
    } catch (error) {
        console.error('检查权限失败:', error);
        window.location.href = '/login';
    }
}

// 初始化UI
function initializeUI() {
    // 隐藏所有标签页
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.style.display = 'none';
    });
    
    // 根据URL参数显示指定标签页
    const urlParams = new URLSearchParams(window.location.search);
    const tab = urlParams.get('tab');
    
    if (tab === 'ai-tools') {
        showTab('ai-tools');
    }
}

// 切换标签页
function showTab(tabId) {
    // 如果是外部链接的标签页，直接跳转
    const externalTabs = {
        'images': '/admin/images',
        'users': '/admin/users', 
        'system': '/admin/system',
        'tools': '/admin/tools'
    };
    
    if (externalTabs[tabId]) {
        window.location.href = externalTabs[tabId];
        return;
    }
    
    // 隐藏所有标签页
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.style.display = 'none';
    });
    
    // 显示目标标签页
    const targetTab = document.getElementById(tabId);
    if (targetTab) {
        targetTab.style.display = 'block';
    }
    
    // 更新URL参数
    const url = new URL(window.location.href);
    url.searchParams.set('tab', tabId);
    window.history.pushState({}, '', url);
    
    // 更新当前标签
    currentTab = tabId;
}

// 加载统计数据
async function loadStats() {
    try {
        showLoading('正在加载数据...');
        
        const response = await fetch('/api/admin/stats');
        const data = await response.json();
        
        if (data.success) {
            statsData = data.data;
            displayStats(statsData);
        } else {
            showError('加载统计数据失败');
        }
    } catch (error) {
        console.error('加载统计失败:', error);
        showError('网络错误：' + error.message);
    } finally {
        hideLoading();
    }
}

// 显示统计数据
function displayStats(data) {
    document.getElementById('totalImages').textContent = data.overview.total_images || 0;
    document.getElementById('totalUsers').textContent = data.overview.total_users || 0;
    document.getElementById('totalTags').textContent = data.overview.total_tags || 0;
    document.getElementById('pendingAnalysis').textContent = data.ai_analysis.pending || 0;
    
    document.getElementById('todayUploads').textContent = data.today.uploads || 0;
    document.getElementById('todayRegistrations').textContent = data.today.registrations || 0;
    document.getElementById('completedAnalysis').textContent = data.ai_analysis.completed || 0;
    document.getElementById('activeTags').textContent = data.overview.active_tags || 0;
}

// 实时统计更新
let statsUpdateInterval;

function startStatsAutoUpdate() {
    // 每30秒自动更新统计数据
    statsUpdateInterval = setInterval(loadStats, 30000);
}

function stopStatsAutoUpdate() {
    if (statsUpdateInterval) {
        clearInterval(statsUpdateInterval);
    }
}

// 系统监控功能
let systemMonitorInterval;

function startSystemMonitor() {
    systemMonitorInterval = setInterval(async () => {
        try {
            // 检查系统状态
            const response = await fetch('/api/admin/system-info');
            const data = await response.json();
            
            if (data.success) {
                const memoryUsage = ((data.data.system.memory_total_gb - data.data.system.memory_available_gb) / data.data.system.memory_total_gb * 100).toFixed(1);
                
                // 如果内存使用率过高，发出警告
                if (memoryUsage > 80) {
                    addLog(`⚠️ 系统警告：内存使用率 ${memoryUsage}%`);
                }
            }
        } catch (error) {
            console.error('系统监控错误:', error);
        }
    }, 60000); // 每分钟检查一次
}

function stopSystemMonitor() {
    if (systemMonitorInterval) {
        clearInterval(systemMonitorInterval);
    }
}

// 批量AI分析
async function startBatchAnalysis() {
    const filter = document.getElementById('batchAnalysisFilter').value;
    const limit = document.getElementById('batchAnalysisLimit').value;
    
    // 询问是否使用自定义提示词
    if (confirm('是否使用自定义提示词进行分析？\n\n确定 = 使用自定义提示词\n取消 = 使用默认分析')) {
        showCustomAnalysisModal();
        return;
    }
    
    if (confirm(`确定要开始批量分析吗？将处理 ${filter} 图片，限制 ${limit} 张。`)) {
        try {
            showLoading('正在启动批量分析...');
            addLog('开始批量AI分析...');
            
            const response = await fetch('/api/admin/batch/analyze', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    status_filter: filter,
                    limit: parseInt(limit)
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                addLog(`批量分析任务已启动，将处理 ${data.count} 张图片`);
                showSuccess('批量分析任务已启动');
            } else {
                addLog('批量分析启动失败: ' + (data.detail || '未知错误'));
                showError('批量分析启动失败');
            }
        } catch (error) {
            addLog('批量分析启动失败: ' + error.message);
            showError('网络错误：' + error.message);
        } finally {
            hideLoading();
        }
    }
}

// 目录扫描
async function startDirectoryScan() {
    const path = document.getElementById('scanDirectoryPath').value;
    const autoAnalyze = document.getElementById('autoAnalyzeScanned').checked;
    
    if (!path) {
        alert('请输入目录路径');
        return;
    }
    
    if (confirm(`确定要扫描目录 "${path}" 吗？`)) {
        try {
            showLoading('正在扫描目录...');
            addLog(`开始扫描目录: ${path}`);
            
            const params = new URLSearchParams({
                directory_path: path,
                auto_analyze: autoAnalyze
            });
            
            const response = await fetch(`/api/admin/scan-directory?${params}`, {
                method: 'POST'
            });
            
            const data = await response.json();
            
            if (data.success) {
                addLog('目录扫描任务已启动');
                showSuccess('目录扫描任务已启动');
            } else {
                addLog('目录扫描启动失败: ' + (data.detail || '未知错误'));
                showError('目录扫描启动失败');
            }
        } catch (error) {
            addLog('目录扫描启动失败: ' + error.message);
            showError('网络错误：' + error.message);
        } finally {
            hideLoading();
        }
    }
}

// 自定义分析功能
function showCustomAnalysisModal() {
    const modal = new bootstrap.Modal(document.getElementById('customAnalysisModal'));
    modal.show();
}

// 使用自定义提示词分析
async function startCustomAnalysisFromModal() {
    const customPrompt = document.getElementById('modalCustomPrompt').value.trim();
    
    if (!customPrompt) {
        alert('请输入自定义提示词');
        return;
    }
    
    const filter = document.getElementById('batchAnalysisFilter').value;
    const limit = document.getElementById('batchAnalysisLimit').value;
    
    if (confirm(`确定要使用自定义提示词进行批量分析吗？\n范围：${filter}\n限制：${limit}张`)) {
        try {
            showLoading('正在启动自定义分析...');
            addLog('开始自定义AI分析...');
            
            const response = await fetch('/api/admin/batch/analyze', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    status_filter: filter,
                    limit: parseInt(limit),
                    custom_prompt: customPrompt
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                addLog(`自定义分析任务已启动，将处理 ${data.count} 张图片`);
                showSuccess('自定义分析任务已启动');
                
                // 关闭模态框
                const modal = bootstrap.Modal.getInstance(document.getElementById('customAnalysisModal'));
                modal.hide();
            } else {
                addLog('自定义分析启动失败: ' + (data.detail || '未知错误'));
                showError('自定义分析启动失败');
            }
        } catch (error) {
            addLog('自定义分析启动失败: ' + error.message);
            showError('网络错误：' + error.message);
        } finally {
            hideLoading();
        }
    }
}

// 清理缓存
async function clearCache() {
    if (confirm('确定要清理系统缓存吗？')) {
        try {
            showLoading('正在清理缓存...');
            
            const response = await fetch('/api/admin/clear-cache', {
                method: 'POST'
            });
            
            const data = await response.json();
            
            if (data.success) {
                showSuccess('系统缓存清理完成');
                addLog('系统缓存清理完成');
            } else {
                showError('清理缓存失败');
                addLog('清理缓存失败: ' + (data.detail || '未知错误'));
            }
        } catch (error) {
            showError('网络错误：' + error.message);
            addLog('清理缓存失败: ' + error.message);
        } finally {
            hideLoading();
        }
    }
}

// 显示系统信息
function showSystemInfo() {
    window.location.href = '/admin/system';
}

// 查看图片管理
function scanDirectory() {
    showTab('ai-tools');
}

// 添加日志
function addLog(message) {
    const logContainer = document.getElementById('operationLog');
    const timestamp = new Date().toLocaleTimeString();
    const logEntry = document.createElement('div');
    logEntry.innerHTML = `<span class="text-muted">[${timestamp}]</span> ${message}`;
    logContainer.appendChild(logEntry);
    logContainer.scrollTop = logContainer.scrollHeight;
}

// 清空操作日志
function clearOperationLog() {
    const logContainer = document.getElementById('operationLog');
    logContainer.innerHTML = '<div class="text-muted">日志已清空...</div>';
}

// 辅助函数
function formatFileSize(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('zh-CN') + ' ' + date.toLocaleTimeString('zh-CN', {hour: '2-digit', minute: '2-digit'});
}

function formatUptime(seconds) {
    if (!seconds || seconds === '未知') return '未知';
    const days = Math.floor(seconds / 86400);
    const hours = Math.floor((seconds % 86400) / 3600);
    return `${days}天 ${hours}小时`;
}

function getStatusText(status) {
    const statusMap = {
        'pending': '待分析',
        'completed': '已完成',
        'failed': '分析失败'
    };
    return statusMap[status] || status;
}

function getRoleText(role) {
    const roleMap = {
        'user': '普通用户',
        'moderator': '版主',
        'admin': '管理员'
    };
    return roleMap[role] || role;
}

// UI通知
function showLoading(text = '处理中...') {
    document.getElementById('loadingText').textContent = text;
    document.getElementById('loadingOverlay').style.display = 'flex';
}

function hideLoading() {
    document.getElementById('loadingOverlay').style.display = 'none';
}

function showSuccess(message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = 'alert alert-success alert-dismissible fade show position-fixed';
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 10000; min-width: 300px;';
    alertDiv.innerHTML = `
        <i class="fas fa-check-circle"></i> ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.parentNode.removeChild(alertDiv);
        }
    }, 5000);
}

function showError(message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = 'alert alert-danger alert-dismissible fade show position-fixed';
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 10000; min-width: 300px;';
    alertDiv.innerHTML = `
        <i class="fas fa-exclamation-triangle"></i> ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.parentNode.removeChild(alertDiv);
        }
    }, 8000);
}
</script>
{% endblock %}