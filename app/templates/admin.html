<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç³»ç»Ÿæ¦‚è§ˆ - AIå§¿åŠ¿å‚è€ƒå›¾åº“</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<style>
/* ===== å…¨å±€æ ·å¼ ===== */
:root {
    --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    --success-gradient: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
    --warning-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    --info-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    --danger-gradient: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
    --shadow-light: 0 2px 10px rgba(0,0,0,0.1);
    --shadow-medium: 0 5px 20px rgba(0,0,0,0.15);
    --shadow-heavy: 0 10px 30px rgba(0,0,0,0.2);
    --border-radius: 15px;
    --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

* {
    box-sizing: border-box;
}

body {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    color: #2c3e50;
}

/* ===== å®¹å™¨å¸ƒå±€ ===== */
.main-container {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    border-radius: 25px;
    margin: 20px;
    overflow: hidden;
    box-shadow: var(--shadow-heavy);
    min-height: calc(100vh - 40px);
}

/* ===== é¡µé¢å¤´éƒ¨ ===== */
.admin-header {
    background: var(--primary-gradient);
    color: white;
    padding: 2.5rem 2rem;
    position: relative;
    overflow: hidden;
}

.admin-header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="white" opacity="0.1"/><circle cx="75" cy="75" r="1.5" fill="white" opacity="0.08"/><circle cx="50" cy="10" r="0.5" fill="white" opacity="0.12"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
}

.admin-header .row {
    position: relative;
    z-index: 2;
}

.admin-header h1 {
    font-weight: 700;
    font-size: 2.2rem;
    margin-bottom: 0.5rem;
    text-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.admin-header p {
    opacity: 0.85;
    font-size: 1.1rem;
}

/* ===== ç»Ÿè®¡å¡ç‰‡ ===== */
.stats-cards {
    padding: 2rem;
    margin-bottom: 1rem;
}

.stat-card {
    background: linear-gradient(135deg, #fff 0%, #f8f9ff 100%);
    border-radius: 20px;
    padding: 2rem;
    box-shadow: var(--shadow-medium);
    transition: var(--transition);
    height: 100%;
    border: 1px solid rgba(102, 126, 234, 0.1);
    position: relative;
    overflow: hidden;
}

.stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: var(--primary-gradient);
}

.stat-card:hover {
    transform: translateY(-10px) scale(1.02);
    box-shadow: 0 20px 40px rgba(102, 126, 234, 0.2);
}

.stat-card .fa-2x {
    background: var(--primary-gradient);
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
    margin-bottom: 0.5rem;
}

.stat-number {
    font-size: 2.5rem;
    font-weight: 800;
    margin: 0.5rem 0;
    background: var(--primary-gradient);
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
}

.stat-label {
    font-size: 0.9rem;
    color: #6c757d;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.stat-change {
    font-size: 0.85rem;
    display: flex;
    align-items: center;
    gap: 0.3rem;
    margin-top: 0.5rem;
}

.stat-change.positive {
    color: #28a745;
}

.stat-change.negative {
    color: #dc3545;
}

/* ===== å¿«é€Ÿæ“ä½œå¡ç‰‡ ===== */
.quick-actions {
    padding: 0 2rem 2rem;
}

.action-card {
    background: linear-gradient(135deg, #fff 0%, #f8f9ff 100%);
    border-radius: 20px;
    padding: 2rem;
    border: 2px solid rgba(102, 126, 234, 0.1);
    transition: var(--transition);
    text-align: center;
    height: 100%;
    cursor: pointer;
    position: relative;
    overflow: hidden;
}

.action-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(102, 126, 234, 0.1), transparent);
    transition: left 0.6s ease;
}

.action-card:hover::before {
    left: 100%;
}

.action-card:hover {
    border-color: #667eea;
    transform: translateY(-8px) scale(1.03);
    box-shadow: 0 20px 40px rgba(102, 126, 234, 0.25);
}

.action-icon {
    font-size: 3.5rem;
    margin-bottom: 1.5rem;
    background: var(--primary-gradient);
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
}

.action-card h6 {
    font-weight: 700;
    font-size: 1.1rem;
    margin-bottom: 0.5rem;
    color: #2c3e50;
}

.action-card p {
    color: #6c757d;
    margin: 0;
    font-size: 0.9rem;
}

/* ===== å¡ç‰‡æ ·å¼ ===== */
.card {
    border: none;
    border-radius: 20px;
    box-shadow: var(--shadow-medium);
    transition: var(--transition);
    background: linear-gradient(135deg, #fff 0%, #f8f9ff 100%);
    overflow: hidden;
    margin: 1rem;
}

.card:hover {
    transform: translateY(-5px);
    box-shadow: var(--shadow-heavy);
}

.card-header {
    background: var(--primary-gradient);
    color: white;
    border: none;
    padding: 1.5rem 2rem;
    font-weight: 700;
    font-size: 1.1rem;
}

.card-body {
    padding: 2rem;
}

/* ===== æ ‡ç­¾é¡µå†…å®¹ ===== */
.tab-content {
    display: none;
    padding: 2rem;
    animation: fadeInUp 0.4s ease;
}

.tab-content.active {
    display: block;
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* ===== æ—¥å¿—å®¹å™¨ ===== */
.log-container {
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    color: #00ff88;
    font-family: 'JetBrains Mono', 'Fira Code', 'Courier New', monospace;
    font-size: 0.9rem;
    max-height: 450px;
    overflow-y: auto;
    padding: 1.5rem;
    border-radius: var(--border-radius);
    position: relative;
    line-height: 1.6;
}

.log-container::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: repeating-linear-gradient(
        0deg,
        transparent,
        transparent 2px,
        rgba(0, 255, 136, 0.03) 2px,
        rgba(0, 255, 136, 0.03) 4px
    );
    pointer-events: none;
}

.log-entry {
    margin-bottom: 0.5rem;
    padding: 0.2rem 0;
}

.log-timestamp {
    color: #64748b;
    margin-right: 0.5rem;
}

.log-container::-webkit-scrollbar {
    width: 8px;
}

.log-container::-webkit-scrollbar-track {
    background: rgba(0,0,0,0.2);
    border-radius: 10px;
}

.log-container::-webkit-scrollbar-thumb {
    background: #00ff88;
    border-radius: 10px;
    opacity: 0.7;
}

/* ===== è¡¨å•æ§ä»¶ ===== */
.form-control, .form-select {
    border-radius: 12px;
    border: 2px solid rgba(0,0,0,0.1);
    padding: 0.75rem 1rem;
    transition: var(--transition);
    background: rgba(255,255,255,0.9);
    font-size: 0.95rem;
}

.form-control:focus, .form-select:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    background: white;
}

.form-label {
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 0.5rem;
}

/* ===== æŒ‰é’®æ ·å¼ ===== */
.btn {
    border-radius: 12px;
    padding: 0.75rem 1.5rem;
    font-weight: 600;
    transition: var(--transition);
    border: none;
    position: relative;
    overflow: hidden;
    font-size: 0.95rem;
}

.btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    transition: left 0.5s;
}

.btn:hover::before {
    left: 100%;
}

.btn-primary {
    background: var(--primary-gradient);
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
}

.btn-success {
    background: var(--success-gradient);
    box-shadow: 0 4px 15px rgba(86, 171, 47, 0.3);
}

.btn-info {
    background: var(--info-gradient);
    box-shadow: 0 4px 15px rgba(79, 172, 254, 0.3);
}

.btn-warning {
    background: var(--warning-gradient);
    box-shadow: 0 4px 15px rgba(240, 147, 251, 0.3);
}

.btn-danger {
    background: var(--danger-gradient);
    box-shadow: 0 4px 15px rgba(255, 65, 108, 0.3);
}

.btn-light {
    background: rgba(255,255,255,0.9);
    color: #2c3e50;
    backdrop-filter: blur(10px);
}

.btn-outline-primary {
    border: 2px solid #667eea;
    color: #667eea;
    background: transparent;
}

.btn-outline-primary:hover {
    background: var(--primary-gradient);
    color: white;
}

/* ===== æ¨¡æ€æ¡† ===== */
.modal-content {
    border-radius: 20px;
    border: none;
    box-shadow: var(--shadow-heavy);
    overflow: hidden;
}

.modal-header {
    background: var(--primary-gradient);
    color: white;
    border: none;
    padding: 1.5rem 2rem;
}

.modal-body {
    padding: 2rem;
}

.modal-footer {
    border: none;
    padding: 1.5rem 2rem;
    background: rgba(0,0,0,0.02);
}

.btn-close-white {
    filter: brightness(0) invert(1);
}

/* ===== åŠ è½½é®ç½© ===== */
.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    display: none;
    backdrop-filter: blur(10px);
}

.loading-content {
    background: white;
    padding: 3rem;
    border-radius: 20px;
    text-align: center;
    box-shadow: var(--shadow-heavy);
    animation: loadingPulse 2s ease-in-out infinite;
}

@keyframes loadingPulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
}

.progress {
    height: 8px;
    border-radius: 10px;
    overflow: hidden;
}

.progress-bar {
    border-radius: 10px;
    transition: width 0.3s ease;
}

/* ===== é€šçŸ¥æ ·å¼ ===== */
.alert {
    border-radius: var(--border-radius);
    border: none;
    padding: 1rem 1.5rem;
    font-weight: 500;
    box-shadow: var(--shadow-light);
}

.alert-success {
    background: linear-gradient(135deg, #d4edda, #a8e6cf);
    color: #155724;
}

.alert-danger {
    background: linear-gradient(135deg, #f8d7da, #fab1a0);
    color: #721c24;
}

.alert-info {
    background: linear-gradient(135deg, #cce7ff, #a8d8ea);
    color: #0c5460;
}

.alert-warning {
    background: linear-gradient(135deg, #fff3cd, #ffeaa7);
    color: #856404;
}

/* ===== çŠ¶æ€å¾½ç«  ===== */
.status-badge {
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.status-pending { 
    background: linear-gradient(135deg, #fff3cd, #ffeaa7); 
    color: #856404; 
}

.status-completed { 
    background: linear-gradient(135deg, #d4edda, #a8e6cf); 
    color: #155724; 
}

.status-failed { 
    background: linear-gradient(135deg, #f8d7da, #fab1a0); 
    color: #721c24; 
}

/* ===== æ€§èƒ½ç›‘æ§ ===== */
.performance-panel {
    background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
    color: white;
    border-radius: 20px;
    padding: 2rem;
    margin: 1rem;
}

.performance-item {
    margin-bottom: 1.5rem;
}

.performance-label {
    font-size: 0.9rem;
    opacity: 0.8;
    margin-bottom: 0.5rem;
}

.performance-value {
    font-size: 1.1rem;
    font-weight: 700;
}

.performance-bar {
    height: 6px;
    background: rgba(255,255,255,0.2);
    border-radius: 10px;
    overflow: hidden;
    margin-top: 0.5rem;
}

.performance-bar-fill {
    height: 100%;
    border-radius: 10px;
    transition: width 0.5s ease;
}

/* ===== å·¥å…·æç¤º ===== */
.tooltip-custom {
    position: relative;
    cursor: help;
}

.tooltip-custom::after {
    content: attr(data-tooltip);
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0,0,0,0.9);
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 8px;
    font-size: 0.8rem;
    white-space: nowrap;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
    z-index: 1000;
}

.tooltip-custom:hover::after {
    opacity: 1;
    visibility: visible;
    transform: translateX(-50%) translateY(-5px);
}

/* ===== å“åº”å¼è®¾è®¡ ===== */
@media (max-width: 768px) {
    .main-container {
        margin: 10px;
        border-radius: 20px;
    }
    
    .admin-header {
        padding: 2rem 1.5rem;
    }
    
    .admin-header h1 {
        font-size: 1.8rem;
    }
    
    .stats-cards, .quick-actions, .tab-content {
        padding: 1.5rem;
    }
    
    .stat-card, .action-card {
        padding: 1.5rem;
        margin-bottom: 1rem;
    }
    
    .stat-number {
        font-size: 2rem;
    }
    
    .action-icon {
        font-size: 2.5rem;
    }
    
    .card {
        margin: 0.5rem;
    }
    
    .card-body {
        padding: 1.5rem;
    }
}

/* ===== æ»šåŠ¨æ¡æ ·å¼ ===== */
::-webkit-scrollbar {
    width: 8px;
}

::-webkit-scrollbar-track {
    background: rgba(0,0,0,0.1);
    border-radius: 10px;
}

::-webkit-scrollbar-thumb {
    background: var(--primary-gradient);
    border-radius: 10px;
}

::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(135deg, #5a67d8, #6b46c1);
}

/* ===== åŠ¨ç”»å¢å¼º ===== */
.animate-fade-in {
    animation: fadeIn 0.6s ease;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.animate-slide-up {
    animation: slideUp 0.5s ease;
}

@keyframes slideUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* ===== ç‰¹æ®Šæ•ˆæœ ===== */
.glass-effect {
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.glow-effect {
    box-shadow: 0 0 20px rgba(102, 126, 234, 0.3);
}

.pulse-animation {
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}
</style>
</head>
<body>
{% block content %}
<!-- é¡¶éƒ¨å¯¼èˆª -->
{% include "components/admin_nav.html" %}

<div class="main-container animate-fade-in">
    <!-- é¡µé¢æ ‡é¢˜ -->
    <div class="admin-header">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1>
                    <i class="fas fa-chart-line me-3"></i>ç³»ç»Ÿæ¦‚è§ˆä»ªè¡¨ç›˜
                </h1>
                <p class="mb-0">å®æ—¶ç›‘æ§ç³»ç»ŸçŠ¶æ€ Â· æ™ºèƒ½ç®¡ç†å¹³å° Â· æ•°æ®é©±åŠ¨å†³ç­–</p>
            </div>
            <div class="col-md-4 text-end">
                <div class="btn-group" role="group">
                    <button class="btn btn-light" onclick="loadStats()" data-tooltip="åˆ·æ–°æ‰€æœ‰ç»Ÿè®¡æ•°æ®">
                        <i class="fas fa-sync-alt me-2"></i>åˆ·æ–°æ•°æ®
                    </button>
                    <button class="btn btn-success" onclick="window.location.href='/'" data-tooltip="è¿”å›ç½‘ç«™é¦–é¡µ">
                        <i class="fas fa-home me-2"></i>è¿”å›é¦–é¡µ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ç»Ÿè®¡å¡ç‰‡ -->
    <div class="stats-cards">
        <div class="row">
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="stat-card animate-slide-up">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <div class="stat-label">æ€»å›¾ç‰‡æ•°</div>
                            <div class="stat-number" id="totalImages">-</div>
                            <div class="stat-change positive">
                                <i class="fas fa-arrow-up"></i>
                                ä»Šæ—¥: <span id="todayUploads">-</span>
                            </div>
                        </div>
                        <div>
                            <i class="fas fa-images fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="stat-card animate-slide-up" style="animation-delay: 0.1s;">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <div class="stat-label">æ³¨å†Œç”¨æˆ·</div>
                            <div class="stat-number" id="totalUsers">-</div>
                            <div class="stat-change positive">
                                <i class="fas fa-user-plus"></i>
                                æ–°å¢: <span id="todayRegistrations">-</span>
                            </div>
                        </div>
                        <div>
                            <i class="fas fa-users fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="stat-card animate-slide-up" style="animation-delay: 0.2s;">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <div class="stat-label">å¾…åˆ†æ</div>
                            <div class="stat-number" id="pendingAnalysis">-</div>
                            <div class="stat-change positive">
                                <i class="fas fa-check-circle"></i>
                                å®Œæˆ: <span id="completedAnalysis">-</span>
                            </div>
                        </div>
                        <div>
                            <i class="fas fa-brain fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="stat-card animate-slide-up" style="animation-delay: 0.3s;">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <div class="stat-label">æ ‡ç­¾æ•°é‡</div>
                            <div class="stat-number" id="totalTags">-</div>
                            <div class="stat-change positive">
                                <i class="fas fa-star"></i>
                                æ´»è·ƒ: <span id="activeTags">-</span>
                            </div>
                        </div>
                        <div>
                            <i class="fas fa-tags fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- å¿«é€Ÿæ“ä½œä¸­å¿ƒ -->
    <div class="quick-actions">
        <div class="card">
            <div class="card-header">
                <div class="d-flex align-items-center justify-content-between">
                    <div>
                        <i class="fas fa-bolt me-2"></i>å¿«é€Ÿæ“ä½œä¸­å¿ƒ
                    </div>
                    <div class="badge bg-light text-dark">
                        <i class="fas fa-clock me-1"></i>
                        <span id="currentTime">--:--</span>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 col-sm-6 mb-3">
                        <div class="action-card" onclick="showTab('ai-tools')">
                            <div class="action-icon">
                                <i class="fas fa-robot"></i>
                            </div>
                            <h6>AIæ‰¹é‡åˆ†æ</h6>
                            <p>æ™ºèƒ½å›¾åƒåˆ†æå¤„ç†</p>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6 mb-3">
                        <div class="action-card" onclick="scanDirectory()">
                            <div class="action-icon">
                                <i class="fas fa-folder-open"></i>
                            </div>
                            <h6>ç›®å½•æ‰«æ</h6>
                            <p>æ‰¹é‡å¯¼å…¥å›¾ç‰‡æ–‡ä»¶</p>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6 mb-3">
                        <div class="action-card" onclick="clearCache()">
                            <div class="action-icon">
                                <i class="fas fa-broom"></i>
                            </div>
                            <h6>æ¸…ç†ç¼“å­˜</h6>
                            <p>é‡Šæ”¾ç³»ç»Ÿå­˜å‚¨ç©ºé—´</p>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6 mb-3">
                        <div class="action-card" onclick="showSystemInfo()">
                            <div class="action-icon">
                                <i class="fas fa-server"></i>
                            </div>
                            <h6>ç³»ç»Ÿç›‘æ§</h6>
                            <p>å®æ—¶æ€§èƒ½çŠ¶æ€</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- AIå·¥å…·æ ‡ç­¾é¡µ -->
    <div id="ai-tools" class="tab-content">
        <div class="row mb-4">
            <div class="col-md-8">
                <h2 class="mb-2">
                    <i class="fas fa-robot text-primary me-3"></i>AIåˆ†æå·¥å…·ä¸­å¿ƒ
                </h2>
                <p class="text-muted mb-0">é«˜æ•ˆæ™ºèƒ½çš„æ‰¹é‡å›¾åƒå¤„ç†è§£å†³æ–¹æ¡ˆ</p>
            </div>
            <div class="col-md-4 text-end">
                <div class="btn-group" role="group">
                    <button class="btn btn-outline-primary" onclick="refreshAIStats()">
                        <i class="fas fa-chart-bar me-1"></i>åˆ†æç»Ÿè®¡
                    </button>
                    <button class="btn btn-outline-info" onclick="showAIHistory()">
                        <i class="fas fa-history me-1"></i>å†å²è®°å½•
                    </button>
                </div>
            </div>
        </div>
        
        <div class="row">
            <!-- æ‰¹é‡åˆ†æå·¥å…· -->
            <div class="col-md-6 mb-4">
                <div class="card h-100">
                    <div class="card-header">
                        <i class="fas fa-magic me-2"></i>æ‰¹é‡AIåˆ†æ
                    </div>
                    <div class="card-body">
                        <p class="text-muted mb-4">
                            <i class="fas fa-info-circle me-1"></i>
                            ä½¿ç”¨å…ˆè¿›çš„äººå·¥æ™ºèƒ½æŠ€æœ¯å¯¹å›¾ç‰‡è¿›è¡Œæ™ºèƒ½åˆ†æå’Œæ ‡æ³¨
                        </p>
                        
                        <div class="mb-3">
                            <label class="form-label">
                                <i class="fas fa-filter me-1"></i>åˆ†æèŒƒå›´
                            </label>
                            <select class="form-select" id="batchAnalysisFilter">
                                <option value="pending">ğŸ“‹ ä»…å¾…åˆ†æå›¾ç‰‡</option>
                                <option value="failed">âŒ ä»…å¤±è´¥å›¾ç‰‡</option>
                                <option value="all">ğŸ”„ å…¨éƒ¨å›¾ç‰‡</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">
                                <i class="fas fa-list-ol me-1"></i>å¤„ç†æ•°é‡é™åˆ¶
                            </label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="batchAnalysisLimit" 
                                       value="10" min="1" max="100">
                                <span class="input-group-text">å¼ å›¾ç‰‡</span>
                            </div>
                            <div class="form-text">
                                <i class="fas fa-lightbulb me-1"></i>
                                å»ºè®®å•æ¬¡å¤„ç†ä¸è¶…è¿‡50å¼ ä»¥ä¿è¯æœ€ä½³æ€§èƒ½
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="enableProgressNotification" checked>
                                <label class="form-check-label">
                                    <i class="fas fa-bell me-1"></i>å¯ç”¨è¿›åº¦å®æ—¶é€šçŸ¥
                                </label>
                            </div>
                        </div>
                        
                        <button class="btn btn-primary w-100" onclick="startBatchAnalysis()">
                            <i class="fas fa-play me-2"></i>å¼€å§‹æ‰¹é‡åˆ†æ
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- ç›®å½•æ‰«æå·¥å…· -->
            <div class="col-md-6 mb-4">
                <div class="card h-100">
                    <div class="card-header">
                        <i class="fas fa-folder-open me-2"></i>æ™ºèƒ½ç›®å½•æ‰«æ
                    </div>
                    <div class="card-body">
                        <p class="text-muted mb-4">
                            <i class="fas fa-info-circle me-1"></i>
                            è‡ªåŠ¨å‘ç°å¹¶å¯¼å…¥æŒ‡å®šç›®å½•ä¸­çš„å›¾ç‰‡æ–‡ä»¶
                        </p>
                        
                        <div class="mb-3">
                            <label class="form-label">
                                <i class="fas fa-folder me-1"></i>ç›®å½•è·¯å¾„
                            </label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-folder-open"></i></span>
                                <input type="text" class="form-control" id="scanDirectoryPath" 
                                       placeholder="ä¾‹å¦‚: uploads/images" value="uploads">
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">
                                <i class="fas fa-file-image me-1"></i>æ–‡ä»¶ç±»å‹è¿‡æ»¤
                            </label>
                            <select class="form-select" id="fileTypeFilter">
                                <option value="all">ğŸ–¼ï¸ æ‰€æœ‰å›¾ç‰‡æ ¼å¼</option>
                                <option value="jpg">ğŸ“· ä»… JPG/JPEG</option>
                                <option value="png">ğŸ¨ ä»… PNG</option>
                                <option value="webp">ğŸŒ ä»… WebP</option>
                            </select>
                        </div>
                        
                        <div class="mb-4">
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="autoAnalyzeScanned" checked>
                                <label class="form-check-label">
                                    <i class="fas fa-brain me-1"></i>è‡ªåŠ¨åˆ†ææ–°å¯¼å…¥çš„å›¾ç‰‡
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="recursiveScan">
                                <label class="form-check-label">
                                    <i class="fas fa-sitemap me-1"></i>é€’å½’æ‰«æå­ç›®å½•
                                </label>
                            </div>
                        </div>
                        
                        <button class="btn btn-info w-100" onclick="startDirectoryScan()">
                            <i class="fas fa-search me-2"></i>å¼€å§‹æ™ºèƒ½æ‰«æ
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- æ“ä½œç›‘æ§é¢æ¿ -->
        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-terminal me-2"></i>å®æ—¶æ“ä½œæ—¥å¿—
                        </div>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-light" onclick="toggleAutoScroll()" id="autoScrollBtn">
                                <i class="fas fa-arrow-down me-1"></i>è‡ªåŠ¨æ»šåŠ¨
                            </button>
                            <button class="btn btn-outline-light" onclick="exportLog()">
                                <i class="fas fa-download me-1"></i>å¯¼å‡º
                            </button>
                            <button class="btn btn-outline-light" onclick="clearOperationLog()">
                                <i class="fas fa-trash-alt me-1"></i>æ¸…ç©º
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div id="operationLog" class="log-container">
                            <div class="log-entry">
                                <span class="log-timestamp">[ç³»ç»Ÿ]</span>
                                <span style="color: #00ff88;">
                                    <i class="fas fa-check-circle"></i> ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆï¼Œå‡†å¤‡æ¥æ”¶æŒ‡ä»¤...
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="performance-panel">
                    <h6 class="mb-3">
                        <i class="fas fa-tachometer-alt me-2"></i>æ€§èƒ½ç›‘æ§
                    </h6>
                    
                    <div class="performance-item">
                        <div class="performance-label">å†…å­˜ä½¿ç”¨ç‡</div>
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="performance-value" id="memoryUsage">-</div>
                            <small id="memoryDetails">- / -</small>
                        </div>
                        <div class="performance-bar">
                            <div class="performance-bar-fill bg-primary" id="memoryBar" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div class="performance-item">
                        <div class="performance-label">CPUä½¿ç”¨ç‡</div>
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="performance-value" id="cpuUsage">-</div>
                            <small id="cpuCores">- æ ¸å¿ƒ</small>
                        </div>
                        <div class="performance-bar">
                            <div class="performance-bar-fill bg-success" id="cpuBar" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div class="performance-item">
                        <div class="performance-label">å¤„ç†é˜Ÿåˆ—</div>
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="performance-value" id="queueTasks">-</div>
                            <small>ä¸ªä»»åŠ¡</small>
                        </div>
                        <div class="performance-bar">
                            <div class="performance-bar-fill bg-warning" id="queueBar" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <hr class="my-3" style="border-color: rgba(255,255,255,0.2);">
                    
                    <div class="text-center">
                        <div class="performance-label">ç³»ç»Ÿè¿è¡Œæ—¶é—´</div>
                        <div class="performance-value" id="systemUptime">è®¡ç®—ä¸­...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- å›¾ç‰‡ç¼–è¾‘æ¨¡æ€æ¡† -->
<div class="modal fade" id="imageEditModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-edit me-2"></i>ç¼–è¾‘å›¾ç‰‡ä¿¡æ¯
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="text-center">
                            <img id="editImagePreview" class="img-fluid rounded-3 shadow" 
                                 style="max-height: 300px;" alt="å›¾ç‰‡é¢„è§ˆ">
                            <div class="mt-3">
                                <div class="badge bg-light text-dark me-2">
                                    <i class="fas fa-expand-arrows-alt me-1"></i>
                                    <span id="editImageDimensions">-</span>
                                </div>
                                <div class="badge bg-light text-dark">
                                    <i class="fas fa-weight-hanging me-1"></i>
                                    <span id="editImageSize">-</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <form id="imageEditForm">
                            <input type="hidden" id="editImageId">
                            
                            <div class="mb-3">
                                <label class="form-label">
                                    <i class="fas fa-file-image me-1"></i>æ–‡ä»¶å
                                </label>
                                <input type="text" class="form-control" id="editImageFilename" readonly>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">
                                    <i class="fas fa-user me-1"></i>ä¸Šä¼ è€…
                                </label>
                                <input type="text" class="form-control" id="editImageUploader" readonly>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">
                                    <i class="fas fa-robot me-1"></i>AIæè¿°
                                </label>
                                <textarea class="form-control" id="editImageDescription" rows="3" 
                                          placeholder="ç¼–è¾‘AIç”Ÿæˆçš„æè¿°..."></textarea>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">
                                    <i class="fas fa-toggle-on me-1"></i>çŠ¶æ€
                                </label>
                                <select class="form-select" id="editImageStatus">
                                    <option value="true">âœ… æ´»è·ƒ</option>
                                    <option value="false">âŒ ç¦ç”¨</option>
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">
                                    <i class="fas fa-tags me-1"></i>è‡ªå®šä¹‰æ ‡ç­¾
                                </label>
                                <input type="text" class="form-control" id="editImageTags" 
                                       placeholder="ç”¨é€—å·åˆ†éš”ï¼Œä¾‹å¦‚ï¼šå¥³æ€§,åå§¿,å®¤å†…">
                                <div class="form-text">
                                    <i class="fas fa-info-circle me-1"></i>ç°æœ‰æ ‡ç­¾å°†è¢«æ›¿æ¢
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">
                                    <i class="fas fa-brain me-1"></i>AIåˆ†æçŠ¶æ€
                                </label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="editImageAIStatus" readonly>
                                    <span class="input-group-text">
                                        <i class="fas fa-percentage me-1"></i>
                                        <span id="editImageConfidence">-</span>%
                                    </span>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>å–æ¶ˆ
                </button>
                <button type="button" class="btn btn-primary" onclick="saveImageEdit()">
                    <i class="fas fa-save me-1"></i>ä¿å­˜æ›´æ”¹
                </button>
                <button type="button" class="btn btn-warning" onclick="reanalyzeImageFromModal()">
                    <i class="fas fa-brain me-1"></i>é‡æ–°åˆ†æ
                </button>
                <button type="button" class="btn btn-danger" onclick="deleteImageFromModal()">
                    <i class="fas fa-trash me-1"></i>åˆ é™¤å›¾ç‰‡
                </button>
            </div>
        </div>
    </div>
</div>

<!-- è‡ªå®šä¹‰AIåˆ†ææ¨¡æ€æ¡† -->
<div class="modal fade" id="customAnalysisModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-brain me-2"></i>è‡ªå®šä¹‰AIåˆ†æå¼•æ“
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-4">
                    <label class="form-label">
                        <i class="fas fa-comment-dots me-1"></i>è‡ªå®šä¹‰æç¤ºè¯
                    </label>
                    <textarea class="form-control" id="modalCustomPrompt" rows="8" 
                              placeholder="è¾“å…¥è‡ªå®šä¹‰çš„AIåˆ†ææç¤ºè¯...

ğŸ’¡ ç¤ºä¾‹æç¤ºè¯ï¼š
â€¢ ä¸“æ³¨åˆ†æå›¾ç‰‡ä¸­äººç‰©çš„æœè£…é£æ ¼å’Œé¢œè‰²æ­é…
â€¢ è¯¦ç»†æè¿°å›¾ç‰‡çš„å…‰çº¿ã€æ‹æ‘„è§’åº¦å’Œæ„å›¾æŠ€å·§
â€¢ è¯†åˆ«å›¾ç‰‡ä¸­çš„é“å…·ã€èƒŒæ™¯å…ƒç´ å’Œç¯å¢ƒç‰¹å¾
â€¢ åˆ†æäººç‰©çš„å§¿åŠ¿ã€è¡¨æƒ…å’ŒåŠ¨ä½œçš„è‰ºæœ¯è¡¨ç°åŠ›"></textarea>
                </div>
                
                <div class="mb-4">
                    <h6 class="fw-semibold mb-3">
                        <i class="fas fa-lightbulb text-warning me-1"></i>æ™ºèƒ½æç¤ºè¯æ¨¡æ¿
                    </h6>
                    <div class="row">
                        <div class="col-md-6 mb-2">
                            <button class="btn btn-outline-primary btn-sm w-100" 
                                    onclick="insertPromptTemplate('pose')">
                                <i class="fas fa-user me-1"></i>å§¿åŠ¿åˆ†ææ¨¡æ¿
                            </button>
                        </div>
                        <div class="col-md-6 mb-2">
                            <button class="btn btn-outline-success btn-sm w-100" 
                                    onclick="insertPromptTemplate('style')">
                                <i class="fas fa-palette me-1"></i>é£æ ¼åˆ†ææ¨¡æ¿
                            </button>
                        </div>
                        <div class="col-md-6 mb-2">
                            <button class="btn btn-outline-info btn-sm w-100" 
                                    onclick="insertPromptTemplate('composition')">
                                <i class="fas fa-camera me-1"></i>æ„å›¾åˆ†ææ¨¡æ¿
                            </button>
                        </div>
                        <div class="col-md-6 mb-2">
                            <button class="btn btn-outline-warning btn-sm w-100" 
                                    onclick="insertPromptTemplate('detail')">
                                <i class="fas fa-search me-1"></i>ç»†èŠ‚åˆ†ææ¨¡æ¿
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>æ™ºèƒ½æç¤ºï¼š</strong>
                    è‡ªå®šä¹‰æç¤ºè¯å°†æ›¿ä»£é»˜è®¤åˆ†ææ¨¡å¼ã€‚æ›´è¯¦ç»†ã€æ›´å…·ä½“çš„æç¤ºè¯é€šå¸¸èƒ½è·å¾—æ›´å‡†ç¡®å’Œä¸°å¯Œçš„åˆ†æç»“æœã€‚
                    å»ºè®®ä½¿ç”¨æ¸…æ™°çš„è¯­è¨€æè¿°æ‚¨å¸Œæœ›AIå…³æ³¨çš„é‡ç‚¹ã€‚
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>å–æ¶ˆ
                </button>
                <button type="button" class="btn btn-outline-secondary" onclick="clearCustomPrompt()">
                    <i class="fas fa-eraser me-1"></i>æ¸…ç©ºå†…å®¹
                </button>
                <button type="button" class="btn btn-primary" onclick="startCustomAnalysisFromModal()">
                    <i class="fas fa-brain me-1"></i>å¼€å§‹æ™ºèƒ½åˆ†æ
                </button>
            </div>
        </div>
    </div>
</div>

<!-- åŠ è½½é®ç½© -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="loading-content">
        <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
            <span class="visually-hidden">å¤„ç†ä¸­...</span>
        </div>
        <h5 id="loadingText">ç³»ç»Ÿå¤„ç†ä¸­...</h5>
        <p class="text-muted mb-3" id="loadingSubtext">è¯·ç¨å€™ï¼Œæ­£åœ¨æ‰§è¡Œæ“ä½œ</p>
        <div class="progress" style="height: 6px; display: none;" id="loadingProgress">
            <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 0%"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// ===== å…¨å±€å˜é‡ =====
let currentTab = 'dashboard';
let statsData = null;
let autoScrollEnabled = true;
let performanceData = {};
let statsUpdateInterval;
let systemMonitorInterval;
let performanceMonitorInterval;
let clockInterval;

// ===== é¢„å®šä¹‰æ¨¡æ¿ =====
const promptTemplates = {
    pose: "è¯·è¯¦ç»†åˆ†æå›¾ç‰‡ä¸­äººç‰©çš„å§¿åŠ¿ç‰¹å¾ï¼ŒåŒ…æ‹¬èº«ä½“å§¿æ€ã€æ‰‹éƒ¨åŠ¨ä½œã€è…¿éƒ¨ä½ç½®ã€å¤´éƒ¨æœå‘ç­‰ï¼Œæè¿°å§¿åŠ¿çš„åŠ¨æ€æ„Ÿå’Œè¡¨ç°åŠ›ï¼Œä»¥åŠå§¿åŠ¿ä¼ è¾¾çš„æƒ…æ„Ÿå’Œæ„å›¾ã€‚",
    style: "è¯·æ·±å…¥åˆ†æå›¾ç‰‡çš„æ•´ä½“é£æ ¼ç‰¹å¾ï¼ŒåŒ…æ‹¬è‰²å½©æ­é…ã€å…‰çº¿æ•ˆæœã€æ‹æ‘„é£æ ¼ã€åæœŸå¤„ç†æŠ€å·§ï¼Œä»¥åŠæ•´ä½“çš„è§†è§‰ç¾æ„Ÿå’Œè‰ºæœ¯è¡¨ç°åŠ›ã€‚",
    composition: "è¯·ä¸“ä¸šåˆ†æå›¾ç‰‡çš„æ„å›¾ç‰¹ç‚¹ï¼ŒåŒ…æ‹¬æ‹æ‘„è§’åº¦ã€æ™¯æ·±æ•ˆæœã€ä¸»ä½“ä½ç½®ã€èƒŒæ™¯å¸ƒå±€ã€ç”»é¢å¹³è¡¡æ„Ÿã€å¼•å¯¼çº¿è¿ç”¨ç­‰æ‘„å½±æ„å›¾æŠ€å·§ã€‚",
    detail: "è¯·å…¨é¢ç»†è‡´åˆ†æå›¾ç‰‡ä¸­çš„æ‰€æœ‰å¯è§å…ƒç´ ï¼ŒåŒ…æ‹¬æœè£…ç»†èŠ‚ã€é“å…·ç‰©å“ã€ç¯å¢ƒç‰¹å¾ã€æè´¨çº¹ç†ã€å…‰å½±å˜åŒ–ã€è‰²å½©å±‚æ¬¡ç­‰è§†è§‰ç»†èŠ‚ã€‚"
};

// ===== åˆå§‹åŒ– =====
document.addEventListener('DOMContentLoaded', function() {
    initializeSystem();
});

window.addEventListener('beforeunload', function() {
    cleanupSystem();
});

async function initializeSystem() {
    try {
        // æ£€æŸ¥æƒé™
        await checkAdminPermission();
        
        // åˆå§‹åŒ–UI
        initializeUI();
        
        // åŠ è½½æ•°æ®
        await loadStats();
        
        // å¯åŠ¨ç›‘æ§
        startAllMonitors();
        
        // åˆå§‹åŒ–æ—¶é’Ÿ
        startClock();
        
        // æ˜¾ç¤ºæ¬¢è¿æ¶ˆæ¯
        addLog('ğŸš€ ç®¡ç†é¢æ¿åˆå§‹åŒ–å®Œæˆ', 'success');
        
    } catch (error) {
        console.error('ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥:', error);
        addLog('âŒ ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥: ' + error.message, 'error');
    }
}

function cleanupSystem() {
    stopAllMonitors();
    if (clockInterval) clearInterval(clockInterval);
}

// ===== æƒé™æ£€æŸ¥ =====
async function checkAdminPermission() {
    try {
        const response = await fetch('/api/auth/check');
        const data = await response.json();
        
        if (!data.authenticated) {
            window.location.href = '/login?redirect=/admin';
            return;
        }
        
        if (data.user.role !== 'admin' && data.user.role !== 'moderator') {
            showError('æ‚¨æ²¡æœ‰ç®¡ç†å‘˜æƒé™è®¿é—®æ­¤é¡µé¢');
            setTimeout(() => {
                window.location.href = '/';
            }, 2000);
            return;
        }
        
        addLog(`ğŸ‘‹ æ¬¢è¿å›æ¥ï¼Œ${data.user.username} (${getRoleText(data.user.role)})`, 'info');
    } catch (error) {
        console.error('æƒé™æ£€æŸ¥å¤±è´¥:', error);
        showError('æƒé™éªŒè¯å¤±è´¥ï¼Œè¯·é‡æ–°ç™»å½•');
        setTimeout(() => {
            window.location.href = '/login';
        }, 2000);
    }
}

// ===== UIåˆå§‹åŒ– =====
function initializeUI() {
    // éšè—æ‰€æœ‰æ ‡ç­¾é¡µ
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.style.display = 'none';
        tab.classList.remove('active');
    });
    
    // æ£€æŸ¥URLå‚æ•°
    const urlParams = new URLSearchParams(window.location.search);
    const tab = urlParams.get('tab');
    
    if (tab === 'ai-tools') {
        showTab('ai-tools');
    }
    
    // åˆå§‹åŒ–æŒ‰é’®çŠ¶æ€
    updateAutoScrollButton();
}

// ===== æ ‡ç­¾é¡µç®¡ç† =====
function showTab(tabId) {
    const externalTabs = {
        'images': '/admin/images',
        'users': '/admin/users', 
        'system': '/admin/system',
        'tools': '/admin/tools'
    };
    
    if (externalTabs[tabId]) {
        window.location.href = externalTabs[tabId];
        return;
    }
    
    // éšè—æ‰€æœ‰æ ‡ç­¾é¡µ
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.style.display = 'none';
        tab.classList.remove('active');
    });
    
    // æ˜¾ç¤ºç›®æ ‡æ ‡ç­¾é¡µ
    const targetTab = document.getElementById(tabId);
    if (targetTab) {
        targetTab.style.display = 'block';
        targetTab.classList.add('active');
    }
    
    // æ›´æ–°URL
    const url = new URL(window.location.href);
    url.searchParams.set('tab', tabId);
    window.history.pushState({}, '', url);
    
    currentTab = tabId;
    
    // æ ‡ç­¾é¡µç‰¹æ®Šå¤„ç†
    if (tabId === 'ai-tools') {
        refreshAIStats();
        addLog('ğŸ”§ AIå·¥å…·é¢æ¿å·²æ¿€æ´»', 'info');
    }
}

// ===== ç»Ÿè®¡æ•°æ®ç®¡ç† =====
async function loadStats() {
    try {
        showLoading('æ­£åœ¨åŠ è½½ç»Ÿè®¡æ•°æ®...', 'è·å–æœ€æ–°çš„ç³»ç»ŸçŠ¶æ€ä¿¡æ¯');
        
        const response = await fetch('/api/admin/stats');
        const data = await response.json();
        
        if (data.success) {
            statsData = data.data;
            displayStats(statsData);
            addLog('ğŸ“Š ç»Ÿè®¡æ•°æ®åˆ·æ–°å®Œæˆ', 'success');
        } else {
            throw new Error(data.detail || 'ç»Ÿè®¡æ•°æ®åŠ è½½å¤±è´¥');
        }
    } catch (error) {
        console.error('ç»Ÿè®¡åŠ è½½å¤±è´¥:', error);
        showError('ç»Ÿè®¡æ•°æ®åŠ è½½å¤±è´¥: ' + error.message);
        addLog('âŒ ç»Ÿè®¡æ•°æ®åŠ è½½å¤±è´¥: ' + error.message, 'error');
    } finally {
        hideLoading();
    }
}

function displayStats(data) {
    // ä½¿ç”¨åŠ¨ç”»æ•ˆæœæ›´æ–°æ•°å­—
    animateNumber('totalImages', data.overview.total_images || 0);
    animateNumber('totalUsers', data.overview.total_users || 0);
    animateNumber('totalTags', data.overview.total_tags || 0);
    animateNumber('pendingAnalysis', data.ai_analysis.pending || 0);
    
    animateNumber('todayUploads', data.today.uploads || 0);
    animateNumber('todayRegistrations', data.today.registrations || 0);
    animateNumber('completedAnalysis', data.ai_analysis.completed || 0);
    animateNumber('activeTags', data.overview.active_tags || 0);
}

function animateNumber(elementId, targetValue) {
    const element = document.getElementById(elementId);
    if (!element) return;
    
    const currentValue = parseInt(element.textContent.replace(/[^\d]/g, '')) || 0;
    const difference = targetValue - currentValue;
    const duration = 1500;
    const steps = 30;
    const stepValue = difference / steps;
    
    let currentStep = 0;
    const timer = setInterval(() => {
        currentStep++;
        const newValue = Math.round(currentValue + (stepValue * currentStep));
        element.textContent = formatNumber(newValue);
        
        if (currentStep >= steps) {
            element.textContent = formatNumber(targetValue);
            clearInterval(timer);
        }
    }, duration / steps);
}

// ===== ç›‘æ§ç³»ç»Ÿ =====
function startAllMonitors() {
    startStatsAutoUpdate();
    startSystemMonitor();
    startPerformanceMonitor();
}

function stopAllMonitors() {
    stopStatsAutoUpdate();
    stopSystemMonitor();
    stopPerformanceMonitor();
}

function startStatsAutoUpdate() {
    statsUpdateInterval = setInterval(loadStats, 30000);
}

function stopStatsAutoUpdate() {
    if (statsUpdateInterval) {
        clearInterval(statsUpdateInterval);
    }
}

function startSystemMonitor() {
    systemMonitorInterval = setInterval(async () => {
        try {
            const response = await fetch('/api/admin/system-info');
            const data = await response.json();
            
            if (data.success) {
                updateSystemInfo(data.data);
            }
        } catch (error) {
            console.error('ç³»ç»Ÿç›‘æ§é”™è¯¯:', error);
        }
    }, 60000);
}

function stopSystemMonitor() {
    if (systemMonitorInterval) {
        clearInterval(systemMonitorInterval);
    }
}

function startPerformanceMonitor() {
    performanceMonitorInterval = setInterval(async () => {
        try {
            const response = await fetch('/api/admin/performance');
            const data = await response.json();
            
            if (data.success) {
                updatePerformanceMetrics(data.data);
            }
        } catch (error) {
            console.error('æ€§èƒ½ç›‘æ§é”™è¯¯:', error);
        }
    }, 5000); // æ¯5ç§’æ›´æ–°ä¸€æ¬¡æ€§èƒ½æ•°æ®
}
function stopPerformanceMonitor() {
    if (performanceMonitorInterval) {
        clearInterval(performanceMonitorInterval);
    }
}

function updateSystemInfo(systemData) {
    if (systemData.system) {
        const memoryTotal = systemData.system.memory_total_gb || 0;
        const memoryAvailable = systemData.system.memory_available_gb || 0;
        const memoryUsed = memoryTotal - memoryAvailable;
        const memoryUsagePercent = memoryTotal > 0 ? (memoryUsed / memoryTotal * 100).toFixed(1) : 0;
        
        // æ›´æ–°è¿è¡Œæ—¶é—´
        if (systemData.system.uptime) {
            document.getElementById('systemUptime').textContent = formatUptime(systemData.system.uptime);
        }
        
        // å†…å­˜ä½¿ç”¨ç‡è­¦å‘Š
        if (memoryUsagePercent > 85) {
            addLog(`ğŸ”¥ è­¦å‘Šï¼šç³»ç»Ÿå†…å­˜ä½¿ç”¨ç‡è¿‡é«˜ ${memoryUsagePercent}%`, 'warning');
            showWarning(`ç³»ç»Ÿå†…å­˜ä½¿ç”¨ç‡å·²è¾¾åˆ° ${memoryUsagePercent}%ï¼Œå»ºè®®æ¸…ç†ç¼“å­˜æˆ–é‡å¯æœåŠ¡`);
        }
    }
}

function updatePerformanceMetrics(perfData) {
    // æ›´æ–°å†…å­˜ä½¿ç”¨ç‡
    if (perfData.memory) {
        const memoryPercent = perfData.memory.usage_percent || 0;
        document.getElementById('memoryUsage').textContent = `${memoryPercent}%`;
        document.getElementById('memoryDetails').textContent = 
            `${formatBytes(perfData.memory.used)} / ${formatBytes(perfData.memory.total)}`;
        document.getElementById('memoryBar').style.width = `${memoryPercent}%`;
        
        // åŠ¨æ€é¢œè‰²
        const memoryBar = document.getElementById('memoryBar');
        if (memoryPercent > 80) {
            memoryBar.className = 'performance-bar-fill bg-danger';
        } else if (memoryPercent > 60) {
            memoryBar.className = 'performance-bar-fill bg-warning';
        } else {
            memoryBar.className = 'performance-bar-fill bg-primary';
        }
    }
    
    // æ›´æ–°CPUä½¿ç”¨ç‡
    if (perfData.cpu) {
        const cpuPercent = perfData.cpu.usage_percent || 0;
        document.getElementById('cpuUsage').textContent = `${cpuPercent}%`;
        document.getElementById('cpuCores').textContent = `${perfData.cpu.cores || '-'} æ ¸å¿ƒ`;
        document.getElementById('cpuBar').style.width = `${cpuPercent}%`;
    }
    
    // æ›´æ–°é˜Ÿåˆ—çŠ¶æ€
    if (perfData.queue) {
        const queueCount = perfData.queue.pending || 0;
        const queueMax = perfData.queue.max || 100;
        const queuePercent = queueMax > 0 ? Math.min(queueCount / queueMax * 100, 100) : 0;
        
        document.getElementById('queueTasks').textContent = queueCount;
        document.getElementById('queueBar').style.width = `${queuePercent}%`;
    }
}

// ===== æ—¶é’ŸåŠŸèƒ½ =====
function startClock() {
    function updateClock() {
        const now = new Date();
        const timeString = now.toLocaleTimeString('zh-CN', {
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        });
        const timeElement = document.getElementById('currentTime');
        if (timeElement) {
            timeElement.textContent = timeString;
        }
    }
    
    updateClock();
    clockInterval = setInterval(updateClock, 1000);
}

// ===== AIåˆ†æåŠŸèƒ½ =====
async function startBatchAnalysis() {
    const filter = document.getElementById('batchAnalysisFilter').value;
    const limit = document.getElementById('batchAnalysisLimit').value;
    
    // è¯¢é—®æ˜¯å¦ä½¿ç”¨è‡ªå®šä¹‰æç¤ºè¯
    if (confirm('ğŸ¤– æ˜¯å¦ä½¿ç”¨è‡ªå®šä¹‰æç¤ºè¯è¿›è¡ŒAIåˆ†æï¼Ÿ\n\nâœ… ç¡®å®š = ä½¿ç”¨è‡ªå®šä¹‰æç¤ºè¯\nâŒ å–æ¶ˆ = ä½¿ç”¨é»˜è®¤åˆ†ææ¨¡å¼')) {
        showCustomAnalysisModal();
        return;
    }
    
    if (confirm(`ğŸš€ ç¡®å®šè¦å¼€å§‹æ‰¹é‡AIåˆ†æå—ï¼Ÿ\n\nğŸ“‹ åˆ†æèŒƒå›´ï¼š${getFilterText(filter)}\nğŸ”¢ å¤„ç†æ•°é‡ï¼š${limit} å¼ å›¾ç‰‡\n\næ­¤æ“ä½œå¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…ã€‚`)) {
        try {
            showLoading('ğŸ§  æ­£åœ¨å¯åŠ¨AIåˆ†æå¼•æ“...', 'åˆå§‹åŒ–æ‰¹é‡å¤„ç†ä»»åŠ¡');
            addLog(`ğŸš€ å¼€å§‹æ‰¹é‡AIåˆ†æ - èŒƒå›´ï¼š${getFilterText(filter)}ï¼Œé™åˆ¶ï¼š${limit}å¼ `, 'info');
            
            const response = await fetch('/api/admin/batch/analyze', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    status_filter: filter,
                    limit: parseInt(limit)
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                addLog(`âœ… æ‰¹é‡åˆ†æä»»åŠ¡å¯åŠ¨æˆåŠŸï¼Œå°†å¤„ç† ${data.count} å¼ å›¾ç‰‡`, 'success');
                showSuccess(`æ‰¹é‡AIåˆ†æä»»åŠ¡å·²å¯åŠ¨ï¼å°†å¤„ç† ${data.count} å¼ å›¾ç‰‡`);
                
                // å¯åŠ¨è¿›åº¦ç›‘æ§
                if (document.getElementById('enableProgressNotification').checked) {
                    startAnalysisProgressMonitor();
                }
            } else {
                throw new Error(data.detail || 'æœªçŸ¥é”™è¯¯');
            }
        } catch (error) {
            addLog(`âŒ æ‰¹é‡åˆ†æå¯åŠ¨å¤±è´¥: ${error.message}`, 'error');
            showError('æ‰¹é‡åˆ†æå¯åŠ¨å¤±è´¥: ' + error.message);
        } finally {
            hideLoading();
        }
    }
}

async function startDirectoryScan() {
    const path = document.getElementById('scanDirectoryPath').value.trim();
    const autoAnalyze = document.getElementById('autoAnalyzeScanned').checked;
    const recursiveScan = document.getElementById('recursiveScan').checked;
    const fileType = document.getElementById('fileTypeFilter').value;
    
    if (!path) {
        showError('è¯·è¾“å…¥æœ‰æ•ˆçš„ç›®å½•è·¯å¾„');
        document.getElementById('scanDirectoryPath').focus();
        return;
    }
    
    const scanOptions = [];
    if (autoAnalyze) scanOptions.push('ğŸ§  è‡ªåŠ¨AIåˆ†æ');
    if (recursiveScan) scanOptions.push('ğŸ“ é€’å½’æ‰«æ');
    scanOptions.push(`ğŸ“¸ æ–‡ä»¶ç±»å‹ï¼š${getFileTypeText(fileType)}`);
    
    if (confirm(`ğŸ“‚ ç¡®å®šè¦æ‰«æç›®å½•å—ï¼Ÿ\n\nğŸ“ è·¯å¾„ï¼š${path}\nâš™ï¸ é€‰é¡¹ï¼š${scanOptions.join('ã€')}\n\næ‰«æå¯èƒ½éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…ã€‚`)) {
        try {
            showLoading('ğŸ“‚ æ­£åœ¨æ‰«æç›®å½•...', 'å‘ç°å¹¶å¯¼å…¥æ–°å›¾ç‰‡æ–‡ä»¶');
            addLog(`ğŸ“‚ å¼€å§‹ç›®å½•æ‰«æ: ${path}`, 'info');
            
            const params = new URLSearchParams({
                directory_path: path,
                auto_analyze: autoAnalyze,
                recursive: recursiveScan,
                file_type: fileType
            });
            
            const response = await fetch(`/api/admin/scan-directory?${params}`, {
                method: 'POST'
            });
            
            const data = await response.json();
            
            if (data.success) {
                addLog(`âœ… ç›®å½•æ‰«æä»»åŠ¡å¯åŠ¨æˆåŠŸ`, 'success');
                showSuccess('ç›®å½•æ‰«æä»»åŠ¡å·²å¯åŠ¨ï¼');
                
                // å¦‚æœè¿”å›äº†æ‰«æç»“æœ
                if (data.found_files) {
                    addLog(`ğŸ“¸ å‘ç° ${data.found_files} ä¸ªæ–°æ–‡ä»¶`, 'info');
                }
            } else {
                throw new Error(data.detail || 'æœªçŸ¥é”™è¯¯');
            }
        } catch (error) {
            addLog(`âŒ ç›®å½•æ‰«æå¯åŠ¨å¤±è´¥: ${error.message}`, 'error');
            showError('ç›®å½•æ‰«æå¯åŠ¨å¤±è´¥: ' + error.message);
        } finally {
            hideLoading();
        }
    }
}

// ===== è‡ªå®šä¹‰åˆ†æåŠŸèƒ½ =====
function showCustomAnalysisModal() {
    const modal = new bootstrap.Modal(document.getElementById('customAnalysisModal'));
    modal.show();
}

function insertPromptTemplate(templateType) {
    const textarea = document.getElementById('modalCustomPrompt');
    const template = promptTemplates[templateType];
    
    if (template) {
        // å¦‚æœå·²æœ‰å†…å®¹ï¼Œåœ¨åé¢æ·»åŠ 
        const currentText = textarea.value.trim();
        if (currentText) {
            textarea.value = currentText + '\n\n' + template;
        } else {
            textarea.value = template;
        }
        
        // è‡ªåŠ¨è°ƒæ•´é«˜åº¦å’Œèšç„¦
        textarea.style.height = 'auto';
        textarea.style.height = textarea.scrollHeight + 'px';
        textarea.focus();
        
        showSuccess(`å·²æ’å…¥${getTemplateTypeName(templateType)}æ¨¡æ¿`);
    }
}

function clearCustomPrompt() {
    if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æç¤ºè¯å†…å®¹å—ï¼Ÿ')) {
        document.getElementById('modalCustomPrompt').value = '';
        showSuccess('æç¤ºè¯å†…å®¹å·²æ¸…ç©º');
    }
}

async function startCustomAnalysisFromModal() {
    const customPrompt = document.getElementById('modalCustomPrompt').value.trim();
    
    if (!customPrompt) {
        showError('è¯·è¾“å…¥è‡ªå®šä¹‰æç¤ºè¯å†…å®¹');
        document.getElementById('modalCustomPrompt').focus();
        return;
    }
    
    const filter = document.getElementById('batchAnalysisFilter').value;
    const limit = document.getElementById('batchAnalysisLimit').value;
    
    if (confirm(`ğŸ§  ç¡®å®šè¦ä½¿ç”¨è‡ªå®šä¹‰æç¤ºè¯è¿›è¡ŒAIåˆ†æå—ï¼Ÿ\n\nğŸ“‹ åˆ†æèŒƒå›´ï¼š${getFilterText(filter)}\nğŸ”¢ å¤„ç†æ•°é‡ï¼š${limit}å¼ \nğŸ“ æç¤ºè¯é•¿åº¦ï¼š${customPrompt.length}å­—ç¬¦\n\nè‡ªå®šä¹‰åˆ†æé€šå¸¸éœ€è¦æ›´é•¿æ—¶é—´ã€‚`)) {
        try {
            showLoading('ğŸ¯ æ­£åœ¨å¯åŠ¨è‡ªå®šä¹‰AIåˆ†æ...', 'ä½¿ç”¨æ‚¨çš„ä¸“å±æç¤ºè¯');
            addLog(`ğŸ¯ å¼€å§‹è‡ªå®šä¹‰AIåˆ†æ - æç¤ºè¯é•¿åº¦ï¼š${customPrompt.length}å­—ç¬¦`, 'info');
            
            const response = await fetch('/api/admin/batch/analyze', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    status_filter: filter,
                    limit: parseInt(limit),
                    custom_prompt: customPrompt
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                addLog(`âœ… è‡ªå®šä¹‰åˆ†æä»»åŠ¡å¯åŠ¨æˆåŠŸï¼Œå°†å¤„ç† ${data.count} å¼ å›¾ç‰‡`, 'success');
                showSuccess(`è‡ªå®šä¹‰AIåˆ†æä»»åŠ¡å·²å¯åŠ¨ï¼å°†ä½¿ç”¨æ‚¨çš„æç¤ºè¯å¤„ç† ${data.count} å¼ å›¾ç‰‡`);
                
                // å…³é—­æ¨¡æ€æ¡†
                const modal = bootstrap.Modal.getInstance(document.getElementById('customAnalysisModal'));
                modal.hide();
                
                // å¯åŠ¨è¿›åº¦ç›‘æ§
                if (document.getElementById('enableProgressNotification').checked) {
                    startAnalysisProgressMonitor();
                }
            } else {
                throw new Error(data.detail || 'æœªçŸ¥é”™è¯¯');
            }
        } catch (error) {
            addLog(`âŒ è‡ªå®šä¹‰åˆ†æå¯åŠ¨å¤±è´¥: ${error.message}`, 'error');
            showError('è‡ªå®šä¹‰åˆ†æå¯åŠ¨å¤±è´¥: ' + error.message);
        } finally {
            hideLoading();
        }
    }
}

// ===== ç³»ç»Ÿç»´æŠ¤åŠŸèƒ½ =====
async function clearCache() {
    if (confirm('ğŸ§¹ ç¡®å®šè¦æ¸…ç†ç³»ç»Ÿç¼“å­˜å—ï¼Ÿ\n\næ­¤æ“ä½œå°†æ¸…ç†ï¼š\nâ€¢ ä¸´æ—¶æ–‡ä»¶ç¼“å­˜\nâ€¢ å›¾ç‰‡ç¼©ç•¥å›¾ç¼“å­˜\nâ€¢ APIå“åº”ç¼“å­˜\n\næ¸…ç†åç³»ç»Ÿæ€§èƒ½å¯èƒ½ä¼šæœ‰çŸ­æš‚å½±å“ã€‚')) {
        try {
            showLoading('ğŸ§¹ æ­£åœ¨æ¸…ç†ç³»ç»Ÿç¼“å­˜...', 'é‡Šæ”¾å­˜å‚¨ç©ºé—´ï¼Œä¼˜åŒ–æ€§èƒ½');
            addLog('ğŸ§¹ å¼€å§‹æ¸…ç†ç³»ç»Ÿç¼“å­˜', 'info');
            
            const response = await fetch('/api/admin/clear-cache', {
                method: 'POST'
            });
            
            const data = await response.json();
            
            if (data.success) {
                const freedSpace = data.freed_space ? formatBytes(data.freed_space) : 'æœªçŸ¥';
                addLog(`âœ… ç³»ç»Ÿç¼“å­˜æ¸…ç†å®Œæˆï¼Œé‡Šæ”¾ç©ºé—´ï¼š${freedSpace}`, 'success');
                showSuccess(`ç³»ç»Ÿç¼“å­˜æ¸…ç†å®Œæˆï¼é‡Šæ”¾äº† ${freedSpace} å­˜å‚¨ç©ºé—´`);
                
                // åˆ·æ–°ç»Ÿè®¡æ•°æ®
                setTimeout(loadStats, 1000);
            } else {
                throw new Error(data.detail || 'æœªçŸ¥é”™è¯¯');
            }
        } catch (error) {
            addLog(`âŒ ç¼“å­˜æ¸…ç†å¤±è´¥: ${error.message}`, 'error');
            showError('ç¼“å­˜æ¸…ç†å¤±è´¥: ' + error.message);
        } finally {
            hideLoading();
        }
    }
}

function showSystemInfo() {
    addLog('ğŸ”„ è·³è½¬åˆ°ç³»ç»Ÿä¿¡æ¯é¡µé¢', 'info');
    window.location.href = '/admin/system';
}

function scanDirectory() {
    showTab('ai-tools');
}

// ===== è¿›åº¦ç›‘æ§ =====
function startAnalysisProgressMonitor() {
    const progressInterval = setInterval(async () => {
        try {
            const response = await fetch('/api/admin/analysis-progress');
            const data = await response.json();
            
            if (data.success) {
                const progress = data.progress;
                
                if (progress.status === 'completed') {
                    addLog(`ğŸ‰ AIåˆ†æä»»åŠ¡å®Œæˆï¼æˆåŠŸå¤„ç† ${progress.completed} å¼ å›¾ç‰‡`, 'success');
                    clearInterval(progressInterval);
                } else if (progress.status === 'running') {
                    const percent = Math.round((progress.completed / progress.total) * 100);
                    addLog(`âš¡ åˆ†æè¿›åº¦ï¼š${progress.completed}/${progress.total} (${percent}%)`, 'info');
                }
            }
        } catch (error) {
            console.error('è¿›åº¦ç›‘æ§é”™è¯¯:', error);
            clearInterval(progressInterval);
        }
    }, 10000); // æ¯10ç§’æ£€æŸ¥ä¸€æ¬¡è¿›åº¦
    
    // 30åˆ†é’Ÿåè‡ªåŠ¨åœæ­¢ç›‘æ§
    setTimeout(() => {
        clearInterval(progressInterval);
    }, 30 * 60 * 1000);
}

// ===== æ—¥å¿—ç®¡ç† =====
function addLog(message, type = 'info') {
    const logContainer = document.getElementById('operationLog');
    if (!logContainer) return;
    
    const timestamp = new Date().toLocaleTimeString('zh-CN');
    const logEntry = document.createElement('div');
    logEntry.className = 'log-entry';
    
    const icon = getLogIcon(type);
    const color = getLogColor(type);
    
    logEntry.innerHTML = `
        <span class="log-timestamp">[${timestamp}]</span>
        <span style="color: ${color};">
            ${icon} ${message}
        </span>
    `;
    
    logContainer.appendChild(logEntry);
    
    // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
    if (autoScrollEnabled) {
        logContainer.scrollTop = logContainer.scrollHeight;
    }
    
    // é™åˆ¶æ—¥å¿—æ¡æ•°ï¼ˆä¿ç•™æœ€æ–°500æ¡ï¼‰
    const logEntries = logContainer.querySelectorAll('.log-entry');
    if (logEntries.length > 500) {
        logEntries[0].remove();
    }
}

function clearOperationLog() {
    if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ“ä½œæ—¥å¿—å—ï¼Ÿ')) {
        const logContainer = document.getElementById('operationLog');
        logContainer.innerHTML = `
            <div class="log-entry">
                <span class="log-timestamp">[ç³»ç»Ÿ]</span>
                <span style="color: #6c757d;">
                    <i class="fas fa-info-circle"></i> æ“ä½œæ—¥å¿—å·²æ¸…ç©ºï¼Œå‡†å¤‡è®°å½•æ–°çš„æ“ä½œ...
                </span>
            </div>
        `;
        showSuccess('æ“ä½œæ—¥å¿—å·²æ¸…ç©º');
    }
}

function toggleAutoScroll() {
    autoScrollEnabled = !autoScrollEnabled;
    updateAutoScrollButton();
    
    const status = autoScrollEnabled ? 'å¯ç”¨' : 'ç¦ç”¨';
    addLog(`ğŸ“œ è‡ªåŠ¨æ»šåŠ¨å·²${status}`, 'info');
}

function updateAutoScrollButton() {
    const btn = document.getElementById('autoScrollBtn');
    if (btn) {
        if (autoScrollEnabled) {
            btn.innerHTML = '<i class="fas fa-arrow-down me-1"></i>è‡ªåŠ¨æ»šåŠ¨';
            btn.className = 'btn btn-outline-light active';
        } else {
            btn.innerHTML = '<i class="fas fa-pause me-1"></i>æ‰‹åŠ¨æ»šåŠ¨';
            btn.className = 'btn btn-outline-light';
        }
    }
}

function exportLog() {
    const logContainer = document.getElementById('operationLog');
    const logEntries = logContainer.querySelectorAll('.log-entry');
    
    let logText = '# AIå§¿åŠ¿å‚è€ƒå›¾åº“ - ç®¡ç†é¢æ¿æ“ä½œæ—¥å¿—\n';
    logText += `# å¯¼å‡ºæ—¶é—´: ${new Date().toLocaleString('zh-CN')}\n\n`;
    
    logEntries.forEach(entry => {
        logText += entry.textContent + '\n';
    });
    
    // åˆ›å»ºä¸‹è½½é“¾æ¥
    const blob = new Blob([logText], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `admin-log-${new Date().toISOString().slice(0, 10)}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    addLog('ğŸ“„ æ“ä½œæ—¥å¿—å¯¼å‡ºå®Œæˆ', 'success');
    showSuccess('æ“ä½œæ—¥å¿—å·²å¯¼å‡ºåˆ°æœ¬åœ°æ–‡ä»¶');
}

// ===== AIå·¥å…·å¢å¼ºåŠŸèƒ½ =====
function refreshAIStats() {
    addLog('ğŸ“Š åˆ·æ–°AIåˆ†æç»Ÿè®¡', 'info');
    loadStats();
}

function showAIHistory() {
    addLog('ğŸ“š æŸ¥çœ‹AIåˆ†æå†å²', 'info');
    window.location.href = '/admin/ai-history';
}

// ===== è¾…åŠ©å‡½æ•° =====
function formatNumber(num) {
    if (num >= 1000000) {
        return (num / 1000000).toFixed(1) + 'M';
    } else if (num >= 1000) {
        return (num / 1000).toFixed(1) + 'K';
    }
    return num.toString();
}

function formatBytes(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function formatUptime(seconds) {
    if (!seconds || seconds === 'æœªçŸ¥') return 'æœªçŸ¥';
    const days = Math.floor(seconds / 86400);
    const hours = Math.floor((seconds % 86400) / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    
    if (days > 0) {
        return `${days}å¤© ${hours}å°æ—¶`;
    } else if (hours > 0) {
        return `${hours}å°æ—¶ ${minutes}åˆ†é’Ÿ`;
    } else {
        return `${minutes}åˆ†é’Ÿ`;
    }
}

function getStatusText(status) {
    const statusMap = {
        'pending': 'â³ å¾…åˆ†æ',
        'completed': 'âœ… å·²å®Œæˆ',
        'failed': 'âŒ åˆ†æå¤±è´¥',
        'running': 'ğŸ”„ åˆ†æä¸­'
    };
    return statusMap[status] || status;
}

function getRoleText(role) {
    const roleMap = {
        'user': 'ğŸ‘¤ æ™®é€šç”¨æˆ·',
        'moderator': 'ğŸ‘® ç‰ˆä¸»',
        'admin': 'ğŸ‘‘ ç®¡ç†å‘˜'
    };
    return roleMap[role] || role;
}

function getFilterText(filter) {
    const filterMap = {
        'pending': 'å¾…åˆ†æå›¾ç‰‡',
        'failed': 'å¤±è´¥å›¾ç‰‡',
        'all': 'å…¨éƒ¨å›¾ç‰‡'
    };
    return filterMap[filter] || filter;
}

function getFileTypeText(fileType) {
    const typeMap = {
        'all': 'æ‰€æœ‰æ ¼å¼',
        'jpg': 'JPG/JPEG',
        'png': 'PNG',
        'webp': 'WebP'
    };
    return typeMap[fileType] || fileType;
}

function getTemplateTypeName(type) {
    const nameMap = {
        'pose': 'å§¿åŠ¿åˆ†æ',
        'style': 'é£æ ¼åˆ†æ',
        'composition': 'æ„å›¾åˆ†æ',
        'detail': 'ç»†èŠ‚åˆ†æ'
    };
    return nameMap[type] || type;
}

function getLogIcon(type) {
    const iconMap = {
        'success': '<i class="fas fa-check-circle"></i>',
        'error': '<i class="fas fa-exclamation-triangle"></i>',
        'warning': '<i class="fas fa-exclamation-circle"></i>',
        'info': '<i class="fas fa-info-circle"></i>'
    };
    return iconMap[type] || '<i class="fas fa-circle"></i>';
}

function getLogColor(type) {
    const colorMap = {
        'success': '#00ff88',
        'error': '#ff4757',
        'warning': '#ffa502',
        'info': '#70a1ff'
    };
    return colorMap[type] || '#ffffff';
}

// ===== UIé€šçŸ¥ç³»ç»Ÿ =====
function showLoading(text = 'å¤„ç†ä¸­...', subtext = '') {
    const overlay = document.getElementById('loadingOverlay');
    const textElement = document.getElementById('loadingText');
    const subtextElement = document.getElementById('loadingSubtext');
    
    if (textElement) textElement.textContent = text;
    if (subtextElement) {
        subtextElement.textContent = subtext;
        subtextElement.style.display = subtext ? 'block' : 'none';
    }
    
    if (overlay) overlay.style.display = 'flex';
}

function hideLoading() {
    const overlay = document.getElementById('loadingOverlay');
    if (overlay) overlay.style.display = 'none';
}

function showSuccess(message) {
    showNotification(message, 'success', 5000);
}

function showError(message) {
    showNotification(message, 'danger', 8000);
}

function showWarning(message) {
    showNotification(message, 'warning', 6000);
}

function showInfo(message) {
    showNotification(message, 'info', 4000);
}

function showNotification(message, type, duration) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed animate-slide-up`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 10000; min-width: 350px; max-width: 500px;';
    
    const icon = getNotificationIcon(type);
    alertDiv.innerHTML = `
        <div class="d-flex align-items-center">
            <div class="me-2">${icon}</div>
            <div class="flex-grow-1">${message}</div>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    document.body.appendChild(alertDiv);
    
    // è‡ªåŠ¨ç§»é™¤
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.classList.remove('show');
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.parentNode.removeChild(alertDiv);
                }
            }, 300);
        }
    }, duration);
}

function getNotificationIcon(type) {
    const iconMap = {
        'success': '<i class="fas fa-check-circle text-success"></i>',
        'danger': '<i class="fas fa-exclamation-triangle text-danger"></i>',
        'warning': '<i class="fas fa-exclamation-circle text-warning"></i>',
        'info': '<i class="fas fa-info-circle text-info"></i>'
    };
    return iconMap[type] || '<i class="fas fa-bell"></i>';
}

// ===== å›¾ç‰‡ç¼–è¾‘åŠŸèƒ½ï¼ˆé¢„ç•™æ¥å£ï¼‰ =====
function saveImageEdit() {
    // å›¾ç‰‡ç¼–è¾‘ä¿å­˜åŠŸèƒ½
    showInfo('å›¾ç‰‡ç¼–è¾‘åŠŸèƒ½å¼€å‘ä¸­...');
}

function reanalyzeImageFromModal() {
    // é‡æ–°åˆ†æå›¾ç‰‡åŠŸèƒ½
    showInfo('é‡æ–°åˆ†æåŠŸèƒ½å¼€å‘ä¸­...');
}

function deleteImageFromModal() {
    // åˆ é™¤å›¾ç‰‡åŠŸèƒ½
    showInfo('åˆ é™¤å›¾ç‰‡åŠŸèƒ½å¼€å‘ä¸­...');
}

// ===== åˆå§‹åŒ–å®Œæˆæç¤º =====
console.log('ğŸš€ AIå§¿åŠ¿å‚è€ƒå›¾åº“ç®¡ç†é¢æ¿å·²å°±ç»ª');
console.log('ğŸ“± å½“å‰ç”¨æˆ·:', 'marvinli001');
console.log('ğŸ•’ åˆå§‹åŒ–æ—¶é—´:', new Date().toLocaleString('zh-CN'));
</script>
{% endblock %}