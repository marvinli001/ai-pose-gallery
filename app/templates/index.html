{% extends "base.html" %}

{% block title %}AIå§¿åŠ¿å‚è€ƒå›¾åº“ - æ™ºèƒ½å§¿åŠ¿æœç´¢{% endblock %}

{% block content %}
<style>
/* å…¨æ–°HeroåŒºåŸŸæ ·å¼ */
.hero-section-new {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
    min-height: 100vh;
    position: relative;
    overflow: hidden;
    display: flex;
    align-items: center;
}

.hero-section-new::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: 
        radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.3) 0%, transparent 50%);
    z-index: 1;
}

.hero-section-new .container {
    position: relative;
    z-index: 2;
}

/* å·¦ä¾§å†…å®¹æ ·å¼ */
.hero-content {
    color: white;
    padding-right: 2rem;
}

.hero-badge {
    display: inline-block;
    margin-bottom: 1.5rem;
}

.badge-text {
    background: rgba(255, 255, 255, 0.2);
    color: white;
    padding: 0.5rem 1.5rem;
    border-radius: 50px;
    font-size: 0.9rem;
    font-weight: 500;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.3);
}

.hero-title-new {
    font-size: 3.5rem;
    font-weight: 800;
    line-height: 1.2;
    margin-bottom: 1rem;
    background: linear-gradient(135deg, #fff 0%, #f8f9ff 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.title-accent {
    display: block;
    font-size: 1.5rem;
    font-weight: 400;
    color: rgba(255, 255, 255, 0.9);
    margin-top: 0.5rem;
}

.hero-description {
    font-size: 1.2rem;
    line-height: 1.7;
    color: rgba(255, 255, 255, 0.95);
    margin-bottom: 2.5rem;
}

.hero-description strong {
    color: #fff;
    font-weight: 600;
}

/* æŒ‰é’®æ ·å¼ */
.hero-actions {
    margin-bottom: 3rem;
}

.btn-primary-new {
    background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
    border: none;
    color: white;
    padding: 1rem 2.5rem;
    font-weight: 600;
    border-radius: 50px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 8px 30px rgba(255, 107, 107, 0.3);
}

.btn-primary-new:hover {
    transform: translateY(-3px);
    box-shadow: 0 15px 40px rgba(255, 107, 107, 0.4);
    background: linear-gradient(135deg, #ff5252 0%, #d63031 100%);
}

.btn-outline-new {
    background: transparent;
    border: 2px solid rgba(255, 255, 255, 0.8);
    color: white;
    padding: 1rem 2.5rem;
    font-weight: 600;
    border-radius: 50px;
    transition: all 0.3s ease;
    backdrop-filter: blur(10px);
}

.btn-outline-new:hover {
    background: rgba(255, 255, 255, 0.2);
    border-color: white;
    color: white;
    transform: translateY(-3px);
}

/* ç»Ÿè®¡æ•°æ®æ ·å¼ */
.hero-stats-new {
    display: flex;
    gap: 3rem;
    margin-top: 2rem;
}

.stat-item-new {
    text-align: center;
}

.stat-number {
    font-size: 2.5rem;
    font-weight: 800;
    color: white;
    line-height: 1;
    margin-bottom: 0.5rem;
    text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
}

.stat-label {
    font-size: 0.9rem;
    color: rgba(255, 255, 255, 0.8);
    font-weight: 500;
}

/* å³ä¾§åŠŸèƒ½å±•ç¤º */
.features-showcase-new {
    position: relative;
    padding: 2rem;
}

.feature-card-new {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    border-radius: 2rem;
    padding: 2.5rem;
    margin-bottom: 2rem;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    border: 1px solid rgba(255, 255, 255, 0.3);
    position: relative;
    overflow: hidden;
}

.feature-card-new::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
}

.feature-primary::before {
    background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
}

.feature-secondary::before {
    background: linear-gradient(90deg, #f093fb 0%, #f5576c 100%);
}

.feature-card-new:hover {
    transform: translateY(-10px) scale(1.02);
    box-shadow: 0 30px 80px rgba(0, 0, 0, 0.15);
}

.feature-icon {
    width: 70px;
    height: 70px;
    border-radius: 1.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 1.5rem;
    font-size: 2rem;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
}

.feature-secondary .feature-icon {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    box-shadow: 0 10px 30px rgba(245, 87, 108, 0.3);
}

.feature-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: #2c3e50;
    margin-bottom: 1rem;
    line-height: 1.3;
}

.feature-desc {
    font-size: 1rem;
    line-height: 1.7;
    color: #5a6c7d;
    margin-bottom: 1.5rem;
}

.feature-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
}

.tag {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    color: #495057;
    padding: 0.4rem 1rem;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 500;
    border: 1px solid #dee2e6;
}

.search-demo {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    padding: 1rem 1.5rem;
    border-radius: 50px;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    border: 1px solid #dee2e6;
    margin-top: 1rem;
}

.search-demo i {
    color: #6c757d;
}

.search-demo span {
    color: #495057;
    font-weight: 500;
}

/* è£…é¥°å…ƒç´  */
.floating-elements {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    pointer-events: none;
    z-index: -1;
}

.float-element {
    position: absolute;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.1);
    animation: float 6s ease-in-out infinite;
}

.float-1 {
    width: 100px;
    height: 100px;
    top: 10%;
    right: 10%;
    animation-delay: 0s;
}

.float-2 {
    width: 60px;
    height: 60px;
    top: 60%;
    right: 80%;
    animation-delay: 2s;
}

.float-3 {
    width: 80px;
    height: 80px;
    top: 80%;
    right: 20%;
    animation-delay: 4s;
}

@keyframes float {
    0%, 100% {
        transform: translateY(0px) rotate(0deg);
        opacity: 0.5;
    }
    50% {
        transform: translateY(-20px) rotate(180deg);
        opacity: 0.8;
    }
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 992px) {
    .hero-title-new {
        font-size: 2.8rem;
    }
    
    .title-accent {
        font-size: 1.3rem;
    }
    
    .hero-description {
        font-size: 1.1rem;
    }
    
    .features-showcase-new {
        margin-top: 3rem;
        padding: 1rem;
    }
    
    .hero-stats-new {
        gap: 2rem;
        justify-content: center;
    }
}

@media (max-width: 768px) {
    .hero-section-new {
        min-height: 90vh;
        padding: 2rem 0;
    }
    
    .hero-content {
        text-align: center;
        padding-right: 0;
        margin-bottom: 2rem;
    }
    
    .hero-title-new {
        font-size: 2.2rem;
    }
    
    .title-accent {
        font-size: 1.1rem;
    }
    
    .hero-description {
        font-size: 1rem;
    }
    
    .hero-actions {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        align-items: center;
    }
    
    .btn-primary-new,
    .btn-outline-new {
        width: 80%;
        max-width: 300px;
    }
    
    .hero-stats-new {
        gap: 1.5rem;
        margin-top: 2rem;
    }
    
    .stat-number {
        font-size: 2rem;
    }
    
    .feature-card-new {
        padding: 2rem 1.5rem;
        margin-bottom: 1.5rem;
    }
    
    .feature-icon {
        width: 60px;
        height: 60px;
        font-size: 1.5rem;
    }
    
    .feature-title {
        font-size: 1.3rem;
    }
    
    .feature-desc {
        font-size: 0.95rem;
    }
}

@media (max-width: 576px) {
    .hero-title-new {
        font-size: 1.8rem;
    }
    
    .title-accent {
        font-size: 1rem;
    }
    
    .hero-description {
        font-size: 0.95rem;
    }
    
    .btn-primary-new,
    .btn-outline-new {
        width: 100%;
        padding: 0.8rem 2rem;
        font-size: 0.9rem;
    }
    
    .hero-stats-new {
        flex-direction: column;
        gap: 1rem;
        text-align: center;
    }
    
    .stat-item-new {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 1rem;
    }
    
    .stat-number {
        font-size: 1.8rem;
        margin-bottom: 0;
    }
    
    .feature-card-new {
        padding: 1.5rem;
    }
    
    .feature-tags {
        justify-content: center;
    }
    
    .search-demo {
        padding: 0.8rem 1.2rem;
        font-size: 0.9rem;
    }
}

/* æš—è‰²æ¨¡å¼é€‚é… */
@media (prefers-color-scheme: dark) {
    .feature-card-new {
        background: rgba(30, 30, 30, 0.95);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .feature-title {
        color: #f8f9fa;
    }
    
    .feature-desc {
        color: #adb5bd;
    }
    
    .tag {
        background: rgba(52, 58, 64, 0.8);
        color: #adb5bd;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .search-demo {
        background: rgba(52, 58, 64, 0.8);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .search-demo span {
        color: #adb5bd;
    }
}

/* é«˜æ€§èƒ½åŠ¨ç”» */
.feature-card-new,
.btn-primary-new,
.btn-outline-new {
    will-change: transform;
}

/* æ— éšœç¢æ”¯æŒ */
@media (prefers-reduced-motion: reduce) {
    .feature-card-new,
    .btn-primary-new,
    .btn-outline-new,
    .float-element {
        animation: none;
        transition: none;
    }
    
    .feature-card-new:hover,
    .btn-primary-new:hover,
    .btn-outline-new:hover {
        transform: none;
    }
}

/* æ‰“å°æ ·å¼ */
@media print {
    .hero-section-new {
        background: white;
        color: black;
        min-height: auto;
    }
    
    .feature-card-new {
        background: white;
        border: 1px solid #ddd;
        box-shadow: none;
    }
    
    .floating-elements {
        display: none;
    }
}
</style>
<!-- å…¨æ–°è®¾è®¡çš„HeroåŒºåŸŸ -->
<div class="hero-section-new">
    <div class="container py-5">
        <div class="row align-items-center min-vh-70">
            <!-- å·¦ä¾§ä¸»è¦å†…å®¹ -->
            <div class="col-lg-6 hero-content">
                <div class="hero-badge mb-3">
                    <span class="badge-text">AIé©±åŠ¨çš„æ™ºèƒ½å›¾åº“</span>
                </div>
                <h1 class="hero-title-new mb-4">
                    AIå§¿åŠ¿å‚è€ƒå›¾åº“
                    <span class="title-accent">è®©åˆ›ä½œæ›´ç®€å•</span>
                </h1>
                <p class="hero-description mb-4">
                    ä¸ºæ’ç”»å¸ˆã€æ‘„å½±å¸ˆã€è®¾è®¡å¸ˆé‡èº«æ‰“é€ çš„æ™ºèƒ½å§¿åŠ¿å‚è€ƒåº“ã€‚
                    <strong>ä½¿ç”¨GPT-4oè¿›è¡Œå›¾åƒåˆ†æï¼Œæ”¯æŒè‡ªç„¶è¯­è¨€æœç´¢ã€‚</strong>
                </p>
                
                <!-- è¡ŒåŠ¨æŒ‰é’® -->
                <div class="hero-actions mb-5">
                    <a href="/upload" class="btn btn-primary-new btn-lg me-3">
                        <i class="fas fa-upload me-2"></i>
                        ç«‹å³ä¸Šä¼ 
                    </a>
                    <a href="#search-section" class="btn btn-outline-new btn-lg">
                        <i class="fas fa-search me-2"></i>
                        å¼€å§‹æœç´¢
                    </a>
                </div>
            </div>
            
            <!-- å³ä¾§åŠŸèƒ½å±•ç¤º -->
            <div class="col-lg-6">
                <div class="features-showcase-new">
                    <!-- AIåˆ†æåŠŸèƒ½å¡ç‰‡ -->
                    <div class="feature-card-new feature-primary">
                        <div class="feature-icon">
                            <i class="fas fa-robot"></i>
                        </div>
                        <div class="feature-content">
                            <h3 class="feature-title">GPT-4oæ™ºèƒ½åˆ†æ</h3>
                            <p class="feature-desc">
                                è‡ªåŠ¨è¯†åˆ«å§¿åŠ¿ã€è¡¨æƒ…ã€åœºæ™¯ã€å…‰çº¿ã€è§’åº¦ç­‰ç‰¹å¾ï¼Œ
                                ç”Ÿæˆç²¾å‡†çš„æ ‡ç­¾å’Œæè¿°ã€‚
                            </p>
                            <div class="feature-tags">
                                <span class="tag">å§¿åŠ¿è¯†åˆ«</span>
                                <span class="tag">è¡¨æƒ…åˆ†æ</span>
                                <span class="tag">åœºæ™¯ç†è§£</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- æœç´¢åŠŸèƒ½å¡ç‰‡ -->
                    <div class="feature-card-new feature-secondary">
                        <div class="feature-icon">
                            <i class="fas fa-comments"></i>
                        </div>
                        <div class="feature-content">
                            <h3 class="feature-title">è‡ªç„¶è¯­è¨€æœç´¢</h3>
                            <p class="feature-desc">
                                æ”¯æŒ"å¥³æ€§åå§¿å®¤å†…"ã€"ç”·æ€§ç«™ç«‹æˆ·å¤–"ç­‰
                                è‡ªç„¶è¯­è¨€æŸ¥è¯¢æ–¹å¼ã€‚
                            </p>
                            <div class="feature-example">
                                <div class="search-demo">
                                    <i class="fas fa-search"></i>
                                    <span>"å¥³æ€§æ€è€ƒå§¿åŠ¿"</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- è£…é¥°å…ƒç´  -->
                    <div class="floating-elements">
                        <div class="float-element float-1"></div>
                        <div class="float-element float-2"></div>
                        <div class="float-element float-3"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- æœç´¢åŒºåŸŸ -->
<section id="search-section" class="py-5 bg-light">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <h2 class="text-center mb-4 section-title">æ™ºèƒ½å§¿åŠ¿æœç´¢</h2>
                
                <!-- æœç´¢æ¡† -->
                <div class="search-container mb-4">
                    <div class="input-group input-group-lg">
                        <input type="text" class="form-control search-input" id="searchInput" 
                               placeholder="è¯•è¯•è¾“å…¥ï¼šå¥³æ€§åå§¿ã€ç”·æ€§ç«™ç«‹ã€æ€è€ƒè¡¨æƒ…...">
                        <button class="btn btn-primary search-btn" type="button" id="searchBtn">
                            <i class="fas fa-search"></i> æœç´¢
                        </button>
                    </div>
                    <div id="searchSuggestions" class="suggestions-dropdown"></div>
                </div>
                
                <!-- çƒ­é—¨æœç´¢ -->
                <div class="popular-searches mb-4">
                    <h6 class="popular-title mb-3">çƒ­é—¨æœç´¢ï¼š</h6>
                    <div id="popularTags" class="d-flex flex-wrap gap-2">
                        <!-- åŠ¨æ€åŠ è½½çƒ­é—¨æ ‡ç­¾ -->
                    </div>
                </div>
                
                <!-- é«˜çº§æœç´¢é€‰é¡¹ -->
                <div class="advanced-search-toggle text-center">
                    <button class="btn btn-link advanced-toggle" type="button" data-bs-toggle="collapse" 
                            data-bs-target="#advancedSearch">
                        <i class="fas fa-cog"></i> é«˜çº§æœç´¢é€‰é¡¹
                    </button>
                </div>
                
                <div class="collapse" id="advancedSearch">
                    <div class="card mt-3 advanced-card">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <label class="form-label filter-label">æ€§åˆ«</label>
                                    <select class="form-select filter-select" id="genderFilter">
                                        <option value="">ä¸é™</option>
                                        <option value="å¥³æ€§">å¥³æ€§</option>
                                        <option value="ç”·æ€§">ç”·æ€§</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label filter-label">å§¿åŠ¿ç±»å‹</label>
                                    <select class="form-select filter-select" id="poseFilter">
                                        <option value="">ä¸é™</option>
                                        <option value="ç«™å§¿">ç«™å§¿</option>
                                        <option value="åå§¿">åå§¿</option>
                                        <option value="èººå§¿">èººå§¿</option>
                                        <option value="è¹²å§¿">è¹²å§¿</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label filter-label">åœºæ™¯</label>
                                    <select class="form-select filter-select" id="sceneFilter">
                                        <option value="">ä¸é™</option>
                                        <option value="å®¤å†…">å®¤å†…</option>
                                        <option value="æˆ·å¤–">æˆ·å¤–</option>
                                        <option value="åŠå…¬å®¤">åŠå…¬å®¤</option>
                                        <option value="å®¶å±…">å®¶å±…</option>
                                    </select>
                                </div>
                            </div>
                            <div class="text-center mt-3">
                                <button class="btn btn-primary advanced-apply" onclick="performAdvancedSearch()">
                                    <i class="fas fa-filter"></i> åº”ç”¨ç­›é€‰
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- æœç´¢ç»“æœåŒºåŸŸ -->
<section class="py-5" id="results-section" style="display: none;">
    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3 id="resultsTitle" class="results-title">æœç´¢ç»“æœ</h3>
            <div class="view-controls">
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-primary active" onclick="setViewMode('grid')">
                        <i class="fas fa-th"></i> ç½‘æ ¼
                    </button>
                    <button type="button" class="btn btn-outline-primary" onclick="setViewMode('list')">
                        <i class="fas fa-list"></i> åˆ—è¡¨
                    </button>
                </div>
            </div>
        </div>
        
        <div id="searchResults" class="results-container">
            <!-- æœç´¢ç»“æœå°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
        </div>
        
        <!-- åŠ è½½æ›´å¤š -->
        <div class="text-center mt-4" id="loadMoreSection" style="display: none;">
            <button class="btn btn-outline-primary" onclick="loadMoreResults()">
                <i class="fas fa-plus"></i> åŠ è½½æ›´å¤š
            </button>
        </div>
    </div>
</section>

<!-- æ¨èå›¾ç‰‡åŒºåŸŸ -->
<section class="py-5 bg-light" id="recommended-section">
    <div class="container">
        <h3 class="text-center mb-4 section-title">æ¨èå›¾ç‰‡</h3>
        <div id="recommendedImages" class="row">
            <!-- æ¨èå›¾ç‰‡å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
        </div>
    </div>
</section>
{% endblock %}

{% block styles %}

{% endblock %}

{% block scripts %}
<script>
let currentSearchQuery = '';
let currentPage = 1;
let viewMode = 'grid';

document.addEventListener('DOMContentLoaded', function() {
    initializePage();
    setupSearchHandlers();
    loadRecommendedImages();
    loadPopularTags();
    loadStats();
});

async function initializePage() {
    // åˆå§‹åŒ–é¡µé¢åŠŸèƒ½
    console.log('AIå§¿åŠ¿å‚è€ƒå›¾åº“åˆå§‹åŒ–å®Œæˆ');
}

function setupSearchHandlers() {
    const searchInput = document.getElementById('searchInput');
    const searchBtn = document.getElementById('searchBtn');
    
    // æœç´¢æŒ‰é’®ç‚¹å‡»
    searchBtn.addEventListener('click', performSearch);
    
    // å›è½¦é”®æœç´¢
    searchInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            performSearch();
        }
    });
    
    // æœç´¢å»ºè®®
    let suggestionTimeout;
    searchInput.addEventListener('input', function() {
        clearTimeout(suggestionTimeout);
        suggestionTimeout = setTimeout(() => {
            showSearchSuggestions(this.value);
        }, 300);
    });
    
    // ç‚¹å‡»å…¶ä»–åœ°æ–¹éšè—å»ºè®®
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.search-container')) {
            hideSearchSuggestions();
        }
    });
}

async function performSearch() {
    const query = document.getElementById('searchInput').value.trim();
    if (!query) {
        alert('è¯·è¾“å…¥æœç´¢å…³é”®è¯');
        return;
    }
    
    currentSearchQuery = query;
    currentPage = 1;
    
    showResultsSection();
    showSearchLoading();
    
    try {
        const response = await fetch(`/api/search?q=${encodeURIComponent(query)}&limit=20&use_ai=true`);
        const data = await response.json();
        
        if (data.success) {
            displaySearchResults(data.data);
        } else {
            showSearchError('æœç´¢å¤±è´¥ï¼Œè¯·é‡è¯•');
        }
    } catch (error) {
        showSearchError('ç½‘ç»œé”™è¯¯ï¼š' + error.message);
    }
}

async function performAdvancedSearch() {
    const gender = document.getElementById('genderFilter').value;
    const pose = document.getElementById('poseFilter').value;
    const scene = document.getElementById('sceneFilter').value;
    
    let query = document.getElementById('searchInput').value.trim();
    
    // æ„å»ºé«˜çº§æœç´¢æŸ¥è¯¢
    const filters = [gender, pose, scene].filter(f => f);
    if (filters.length > 0) {
        query = query ? `${query} ${filters.join(' ')}` : filters.join(' ');
    }
    
    if (!query) {
        alert('è¯·è¾“å…¥æœç´¢æ¡ä»¶');
        return;
    }
    
    document.getElementById('searchInput').value = query;
    await performSearch();
}

function displaySearchResults(searchData) {
    const resultsContainer = document.getElementById('searchResults');
    const images = searchData.images || [];
    
    document.getElementById('resultsTitle').textContent = 
        `æœç´¢"${currentSearchQuery}"çš„ç»“æœ (${images.length}å¼ )`;
    
    if (images.length === 0) {
        resultsContainer.innerHTML = `
            <div class="text-center py-5">
                <i class="fas fa-search fa-3x text-muted mb-3"></i>
                <h5 style="color: #666;">æ²¡æœ‰æ‰¾åˆ°ç›¸å…³å›¾ç‰‡</h5>
                <p style="color: #999;">å°è¯•ä½¿ç”¨å…¶ä»–å…³é”®è¯æˆ–ä¸Šä¼ æ›´å¤šå›¾ç‰‡</p>
                <a href="/upload" class="btn btn-primary">
                    <i class="fas fa-upload"></i> ä¸Šä¼ å›¾ç‰‡
                </a>
            </div>
        `;
        return;
    }
    
    resultsContainer.className = `results-container ${viewMode}-view`;
    
    let html = '';
    if (viewMode === 'grid') {
        html = '<div class="row">';
        images.forEach(image => {
            html += generateImageCard(image, 'col-lg-3 col-md-4 col-sm-6 mb-4');
        });
        html += '</div>';
    } else {
        images.forEach(image => {
            html += generateImageListItem(image);
        });
    }
    
    resultsContainer.innerHTML = html;
    
    // æ˜¾ç¤ºåŠ è½½æ›´å¤šæŒ‰é’®ï¼ˆå¦‚æœæœ‰æ›´å¤šç»“æœï¼‰
    const loadMoreSection = document.getElementById('loadMoreSection');
    if (images.length >= 20) {
        loadMoreSection.style.display = 'block';
    } else {
        loadMoreSection.style.display = 'none';
    }
}

// ä¿®æ”¹ generateImageCard å‡½æ•°
function generateImageCard(image, colClass = '') {
    // ä¿®å¤å›¾ç‰‡URLå¤„ç†é€»è¾‘
    let imageUrl = image.url || image.thumbnail_url;
    
    // è°ƒè¯•è¾“å‡º
    console.log('åŸå§‹å›¾ç‰‡æ•°æ®:', image);
    console.log('åŸå§‹å›¾ç‰‡URL:', imageUrl);
    
    // å¦‚æœURLä¸æ˜¯å®Œæ•´çš„http/httpsé“¾æ¥ï¼Œåˆ™è¡¥å……å®Œæ•´
    if (imageUrl && !imageUrl.startsWith('http')) {
        // ç¡®ä¿URLæ ¼å¼æ­£ç¡®
        const baseUrl = 'https://poseapp-ai.cat.sd';
        const cleanUrl = imageUrl.replace(/^\/+/, ''); // ç§»é™¤å¼€å¤´çš„æ–œæ 
        imageUrl = `${baseUrl}/${cleanUrl}`;
    }
    
    console.log('ä¿®å¤åå›¾ç‰‡URL:', imageUrl);
    
    const confidence = image.confidence ? (image.confidence * 100).toFixed(0) : '0';
    const tags = (image.tags || []).slice(0, 3).map(tag => 
        `<span class="badge bg-secondary me-1">${tag.name || tag}</span>`
    ).join('');
    
    return `
        <div class="${colClass}">
            <div class="card image-card border-0 shadow-sm" onclick="openImageDetail(${image.id})">
                <div class="position-relative">
                    <img src="${imageUrl}" 
                         class="image-thumbnail" 
                         alt="${image.description || image.filename || 'å›¾ç‰‡'}"
                         style="width: 100%; height: 250px; object-fit: cover; cursor: pointer;"
                         onerror="this.onerror=null; this.src='/static/images/placeholder.jpg'; console.error('å›¾ç‰‡åŠ è½½å¤±è´¥:', '${imageUrl}');"
                         onload="console.log('å›¾ç‰‡åŠ è½½æˆåŠŸ:', '${imageUrl}');">
                    <span class="badge bg-primary confidence-badge position-absolute top-0 end-0 m-2">${confidence}%</span>
                </div>
                <div class="card-body">
                    <p class="card-text small mb-2" style="color: #666;">${image.description || 'æš‚æ— æè¿°'}</p>
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="tags-container">
                            ${tags}
                        </div>
                        <small style="color: #999;">
                            <i class="fas fa-eye"></i> ${image.view_count || 0}
                        </small>
                    </div>
                </div>
            </div>
        </div>
    `;
}

// ä¿®æ”¹ generateImageListItem å‡½æ•°
function generateImageListItem(image) {
    // ä¿®å¤å›¾ç‰‡URLå¤„ç†é€»è¾‘
    let imageUrl = image.url || image.thumbnail_url;
    
    if (imageUrl && !imageUrl.startsWith('http')) {
        const baseUrl = 'https://poseapp-ai.cat.sd';
        const cleanUrl = imageUrl.replace(/^\/+/, '');
        imageUrl = `${baseUrl}/${cleanUrl}`;
    }
    
    const confidence = image.confidence ? (image.confidence * 100).toFixed(0) : '0';
    const tags = (image.tags || []).map(tag => 
        `<span class="badge bg-light me-1" style="color: #333;">${tag.name || tag}</span>`
    ).join('');
    
    return `
        <div class="card image-card mb-3" onclick="openImageDetail(${image.id})">
            <div class="row g-0">
                <div class="col-md-3">
                    <img src="${imageUrl}" 
                         class="img-fluid rounded-start h-100" 
                         style="object-fit: cover; cursor: pointer;" 
                         alt="${image.description || image.filename || 'å›¾ç‰‡'}"
                         onerror="this.onerror=null; this.src='/static/images/placeholder.jpg'; console.error('åˆ—è¡¨å›¾ç‰‡åŠ è½½å¤±è´¥:', '${imageUrl}');"
                         onload="console.log('åˆ—è¡¨å›¾ç‰‡åŠ è½½æˆåŠŸ:', '${imageUrl}');">
                </div>
                <div class="col-md-9">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6 class="card-title" style="color: #333;">${image.filename || 'æœªçŸ¥æ–‡ä»¶'}</h6>
                            <span class="badge bg-primary">${confidence}% ç½®ä¿¡åº¦</span>
                        </div>
                        <p class="card-text" style="color: #666;">${image.description || 'æš‚æ— æè¿°'}</p>
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="tags-container">
                                ${tags}
                            </div>
                            <div style="color: #999;">
                                <small>
                                    <i class="fas fa-eye"></i> ${image.view_count || 0} | 
                                    <i class="fas fa-clock"></i> ${formatDate(image.upload_time)}
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
}

async function showSearchSuggestions(query) {
    if (!query || query.length < 2) {
        hideSearchSuggestions();
        return;
    }
    
    try {
        const response = await fetch(`/api/search/suggestions?q=${encodeURIComponent(query)}`);
        const data = await response.json();
        
        if (data.success && data.data.suggestions.length > 0) {
            displaySuggestions(data.data.suggestions);
        } else {
            hideSearchSuggestions();
        }
    } catch (error) {
        console.error('è·å–æœç´¢å»ºè®®å¤±è´¥:', error);
        hideSearchSuggestions();
    }
}

function displaySuggestions(suggestions) {
    const dropdown = document.getElementById('searchSuggestions');
    
    let html = '';
    suggestions.forEach(suggestion => {
        html += `
            <div class="suggestion-item" onclick="selectSuggestion('${suggestion}')">
                <i class="fas fa-search text-muted me-2"></i>${suggestion}
            </div>
        `;
    });
    
    dropdown.innerHTML = html;
    dropdown.style.display = 'block';
}

function hideSearchSuggestions() {
    document.getElementById('searchSuggestions').style.display = 'none';
}

function selectSuggestion(suggestion) {
    document.getElementById('searchInput').value = suggestion;
    hideSearchSuggestions();
    performSearch();
}

async function loadPopularTags() {
    try {
        const response = await fetch('/api/search/popular');
        const data = await response.json();
        
        if (data.success) {
            const container = document.getElementById('popularTags');
            let html = '';
            
            data.data.popular_searches.forEach(tag => {
                html += `
                    <span class="badge bg-primary me-2 mb-2" onclick="searchTag('${tag}')">
                        ${tag}
                    </span>
                `;
            });
            
            container.innerHTML = html;
        }
    } catch (error) {
        console.error('åŠ è½½çƒ­é—¨æ ‡ç­¾å¤±è´¥:', error);
    }
}

// åœ¨ loadRecommendedImages å‡½æ•°ä¸­æ·»åŠ è°ƒè¯•
async function loadRecommendedImages() {
    try {
        console.log('ğŸ”„ å¼€å§‹åŠ è½½æ¨èå›¾ç‰‡...');
        const response = await fetch('/api/images?per_page=8');
        const data = await response.json();
        
        console.log('ğŸ“Š APIå“åº”æ•°æ®:', data);
        
        if (data.success) {
            const container = document.getElementById('recommendedImages');
            const images = data.data.images || [];
            
            console.log(`ğŸ“¸ è·å¾— ${images.length} å¼ æ¨èå›¾ç‰‡`);
            
            if (images.length === 0) {
                container.innerHTML = `
                    <div class="col-12 text-center py-5">
                        <i class="fas fa-images fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">æš‚æ— æ¨èå›¾ç‰‡</h5>
                        <p class="text-muted">è¯·å…ˆä¸Šä¼ ä¸€äº›å›¾ç‰‡</p>
                        <a href="/upload" class="btn btn-primary">
                            <i class="fas fa-upload"></i> ä¸Šä¼ å›¾ç‰‡
                        </a>
                    </div>
                `;
                return;
            }
            
            let html = '';
            images.forEach((image, index) => {
                console.log(`ğŸ–¼ï¸  å›¾ç‰‡ ${index + 1}:`, image);
                html += generateImageCard(image, 'col-lg-3 col-md-4 col-sm-6 mb-4');
            });
            
            container.innerHTML = html;
            console.log('âœ… æ¨èå›¾ç‰‡åŠ è½½å®Œæˆ');
        } else {
            console.error('âŒ APIè¿”å›å¤±è´¥:', data.message);
            document.getElementById('recommendedImages').innerHTML = `
                <div class="col-12 text-center py-5">
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i> 
                        åŠ è½½æ¨èå›¾ç‰‡å¤±è´¥ï¼š${data.message || 'æœªçŸ¥é”™è¯¯'}
                    </div>
                </div>
            `;
        }
    } catch (error) {
        console.error('âŒ åŠ è½½æ¨èå›¾ç‰‡å¤±è´¥:', error);
        document.getElementById('recommendedImages').innerHTML = `
            <div class="col-12 text-center py-5">
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i> 
                    ç½‘ç»œé”™è¯¯ï¼š${error.message}
                </div>
            </div>
        `;
    }
}

async function loadStats() {
    try {
        const response = await fetch('/api/admin/stats');
        const data = await response.json();
        
        if (data.success) {
            const stats = data.data;
            document.getElementById('totalImages').textContent = stats.active_images || 0;
            document.getElementById('totalTags').textContent = stats.active_tags || 0;
            document.getElementById('totalSearches').textContent = stats.total_connections || 0;
        }
    } catch (error) {
        console.error('åŠ è½½ç»Ÿè®¡å¤±è´¥:', error);
    }
}

function searchTag(tag) {
    document.getElementById('searchInput').value = tag;
    performSearch();
}

function setViewMode(mode) {
    viewMode = mode;
    
    // æ›´æ–°æŒ‰é’®çŠ¶æ€
    document.querySelectorAll('.view-controls .btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    // é‡æ–°æ˜¾ç¤ºç»“æœ
    if (document.getElementById('results-section').style.display !== 'none') {
        const resultsContainer = document.getElementById('searchResults');
        if (resultsContainer.innerHTML.trim()) {
            // è§¦å‘é‡æ–°æ¸²æŸ“
            performSearch();
        }
    }
}

function showResultsSection() {
    document.getElementById('results-section').style.display = 'block';
    document.getElementById('results-section').scrollIntoView({ 
        behavior: 'smooth', 
        block: 'start' 
    });
}

function showSearchLoading() {
    document.getElementById('searchResults').innerHTML = `
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">æœç´¢ä¸­...</span>
            </div>
            <p class="mt-3" style="color: #666;">æ­£åœ¨ä½¿ç”¨GPT-4oæ™ºèƒ½æœç´¢...</p>
        </div>
    `;
}

function showSearchError(message) {
    document.getElementById('searchResults').innerHTML = `
        <div class="alert alert-danger text-center">
            <i class="fas fa-exclamation-triangle me-2"></i>${message}
        </div>
    `;
}

function openImageDetail(imageId) {
    window.open(`/image/${imageId}`, '_blank');
}

function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('zh-CN');
}

async function loadMoreResults() {
    currentPage++;
    // å®ç°åŠ è½½æ›´å¤šé€»è¾‘
    console.log('åŠ è½½æ›´å¤šç»“æœ, é¡µç :', currentPage);
}
</script>
{% endblock %}