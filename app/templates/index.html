{% extends "base.html" %}

{% block title %}AI姿势参考图库 - 智能姿势搜索{% endblock %}

{% block content %}
<style>
/* 全新Hero区域样式 */
.hero-section-new {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
    min-height: 100vh;
    position: relative;
    overflow: hidden;
    display: flex;
    align-items: center;
}

.hero-section-new::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: 
        radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.3) 0%, transparent 50%);
    z-index: 1;
}

.hero-section-new .container {
    position: relative;
    z-index: 2;
}

/* 左侧内容样式 */
.hero-content {
    color: white;
    padding-right: 2rem;
}

.hero-badge {
    display: inline-block;
    margin-bottom: 1.5rem;
}

.badge-text {
    background: rgba(255, 255, 255, 0.2);
    color: white;
    padding: 0.5rem 1.5rem;
    border-radius: 50px;
    font-size: 0.9rem;
    font-weight: 500;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.3);
}

.hero-title-new {
    font-size: 3.5rem;
    font-weight: 800;
    line-height: 1.2;
    margin-bottom: 1rem;
    background: linear-gradient(135deg, #fff 0%, #f8f9ff 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.title-accent {
    display: block;
    font-size: 1.5rem;
    font-weight: 400;
    color: rgba(255, 255, 255, 0.9);
    margin-top: 0.5rem;
}

.hero-description {
    font-size: 1.2rem;
    line-height: 1.7;
    color: rgba(255, 255, 255, 0.95);
    margin-bottom: 2.5rem;
}

.hero-description strong {
    color: #fff;
    font-weight: 600;
}

/* 按钮样式 */
.hero-actions {
    margin-bottom: 3rem;
}

.btn-primary-new {
    background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
    border: none;
    color: white;
    padding: 1rem 2.5rem;
    font-weight: 600;
    border-radius: 50px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 8px 30px rgba(255, 107, 107, 0.3);
}

.btn-primary-new:hover {
    transform: translateY(-3px);
    box-shadow: 0 15px 40px rgba(255, 107, 107, 0.4);
    background: linear-gradient(135deg, #ff5252 0%, #d63031 100%);
}

.btn-outline-new {
    background: transparent;
    border: 2px solid rgba(255, 255, 255, 0.8);
    color: white;
    padding: 1rem 2.5rem;
    font-weight: 600;
    border-radius: 50px;
    transition: all 0.3s ease;
    backdrop-filter: blur(10px);
}

.btn-outline-new:hover {
    background: rgba(255, 255, 255, 0.2);
    border-color: white;
    color: white;
    transform: translateY(-3px);
}

/* 统计数据样式 */
.hero-stats-new {
    display: flex;
    gap: 3rem;
    margin-top: 2rem;
}

.stat-item-new {
    text-align: center;
}

.stat-number {
    font-size: 2.5rem;
    font-weight: 800;
    color: white;
    line-height: 1;
    margin-bottom: 0.5rem;
    text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
}

.stat-label {
    font-size: 0.9rem;
    color: rgba(255, 255, 255, 0.8);
    font-weight: 500;
}

/* 右侧功能展示 */
.features-showcase-new {
    position: relative;
    padding: 2rem;
}

.feature-card-new {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    border-radius: 2rem;
    padding: 2.5rem;
    margin-bottom: 2rem;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    border: 1px solid rgba(255, 255, 255, 0.3);
    position: relative;
    overflow: hidden;
}

.feature-card-new::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
}

.feature-primary::before {
    background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
}

.feature-secondary::before {
    background: linear-gradient(90deg, #f093fb 0%, #f5576c 100%);
}

.feature-card-new:hover {
    transform: translateY(-10px) scale(1.02);
    box-shadow: 0 30px 80px rgba(0, 0, 0, 0.15);
}

.feature-icon {
    width: 70px;
    height: 70px;
    border-radius: 1.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 1.5rem;
    font-size: 2rem;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
}

.feature-secondary .feature-icon {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    box-shadow: 0 10px 30px rgba(245, 87, 108, 0.3);
}

.feature-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: #2c3e50;
    margin-bottom: 1rem;
    line-height: 1.3;
}

.feature-desc {
    font-size: 1rem;
    line-height: 1.7;
    color: #5a6c7d;
    margin-bottom: 1.5rem;
}

.feature-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
}

.tag {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    color: #495057;
    padding: 0.4rem 1rem;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 500;
    border: 1px solid #dee2e6;
}

.search-demo {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    padding: 1rem 1.5rem;
    border-radius: 50px;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    border: 1px solid #dee2e6;
    margin-top: 1rem;
}

.search-demo i {
    color: #6c757d;
}

.search-demo span {
    color: #495057;
    font-weight: 500;
}

/* 装饰元素 */
.floating-elements {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    pointer-events: none;
    z-index: -1;
}

.float-element {
    position: absolute;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.1);
    animation: float 6s ease-in-out infinite;
}

.float-1 {
    width: 100px;
    height: 100px;
    top: 10%;
    right: 10%;
    animation-delay: 0s;
}

.float-2 {
    width: 60px;
    height: 60px;
    top: 60%;
    right: 80%;
    animation-delay: 2s;
}

.float-3 {
    width: 80px;
    height: 80px;
    top: 80%;
    right: 20%;
    animation-delay: 4s;
}

@keyframes float {
    0%, 100% {
        transform: translateY(0px) rotate(0deg);
        opacity: 0.5;
    }
    50% {
        transform: translateY(-20px) rotate(180deg);
        opacity: 0.8;
    }
}

/* 响应式设计 */
@media (max-width: 992px) {
    .hero-title-new {
        font-size: 2.8rem;
    }
    
    .title-accent {
        font-size: 1.3rem;
    }
    
    .hero-description {
        font-size: 1.1rem;
    }
    
    .features-showcase-new {
        margin-top: 3rem;
        padding: 1rem;
    }
    
    .hero-stats-new {
        gap: 2rem;
        justify-content: center;
    }
}

@media (max-width: 768px) {
    .hero-section-new {
        min-height: 90vh;
        padding: 2rem 0;
    }
    
    .hero-content {
        text-align: center;
        padding-right: 0;
        margin-bottom: 2rem;
    }
    
    .hero-title-new {
        font-size: 2.2rem;
    }
    
    .title-accent {
        font-size: 1.1rem;
    }
    
    .hero-description {
        font-size: 1rem;
    }
    
    .hero-actions {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        align-items: center;
    }
    
    .btn-primary-new,
    .btn-outline-new {
        width: 80%;
        max-width: 300px;
    }
    
    .hero-stats-new {
        gap: 1.5rem;
        margin-top: 2rem;
    }
    
    .stat-number {
        font-size: 2rem;
    }
    
    .feature-card-new {
        padding: 2rem 1.5rem;
        margin-bottom: 1.5rem;
    }
    
    .feature-icon {
        width: 60px;
        height: 60px;
        font-size: 1.5rem;
    }
    
    .feature-title {
        font-size: 1.3rem;
    }
    
    .feature-desc {
        font-size: 0.95rem;
    }
}

@media (max-width: 576px) {
    .hero-title-new {
        font-size: 1.8rem;
    }
    
    .title-accent {
        font-size: 1rem;
    }
    
    .hero-description {
        font-size: 0.95rem;
    }
    
    .btn-primary-new,
    .btn-outline-new {
        width: 100%;
        padding: 0.8rem 2rem;
        font-size: 0.9rem;
    }
    
    .hero-stats-new {
        flex-direction: column;
        gap: 1rem;
        text-align: center;
    }
    
    .stat-item-new {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 1rem;
    }
    
    .stat-number {
        font-size: 1.8rem;
        margin-bottom: 0;
    }
    
    .feature-card-new {
        padding: 1.5rem;
    }
    
    .feature-tags {
        justify-content: center;
    }
    
    .search-demo {
        padding: 0.8rem 1.2rem;
        font-size: 0.9rem;
    }
}

/* 暗色模式适配 */
@media (prefers-color-scheme: dark) {
    .feature-card-new {
        background: rgba(30, 30, 30, 0.95);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .feature-title {
        color: #f8f9fa;
    }
    
    .feature-desc {
        color: #adb5bd;
    }
    
    .tag {
        background: rgba(52, 58, 64, 0.8);
        color: #adb5bd;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .search-demo {
        background: rgba(52, 58, 64, 0.8);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .search-demo span {
        color: #adb5bd;
    }
}

/* 高性能动画 */
.feature-card-new,
.btn-primary-new,
.btn-outline-new {
    will-change: transform;
}

/* 无障碍支持 */
@media (prefers-reduced-motion: reduce) {
    .feature-card-new,
    .btn-primary-new,
    .btn-outline-new,
    .float-element {
        animation: none;
        transition: none;
    }
    
    .feature-card-new:hover,
    .btn-primary-new:hover,
    .btn-outline-new:hover {
        transform: none;
    }
}

/* 打印样式 */
@media print {
    .hero-section-new {
        background: white;
        color: black;
        min-height: auto;
    }
    
    .feature-card-new {
        background: white;
        border: 1px solid #ddd;
        box-shadow: none;
    }
    
    .floating-elements {
        display: none;
    }
}
</style>
<!-- 全新设计的Hero区域 -->
<div class="hero-section-new">
    <div class="container py-5">
        <div class="row align-items-center min-vh-70">
            <!-- 左侧主要内容 -->
            <div class="col-lg-6 hero-content">
                <div class="hero-badge mb-3">
                    <span class="badge-text">AI驱动的智能图库</span>
                </div>
                <h1 class="hero-title-new mb-4">
                    AI姿势参考图库
                    <span class="title-accent">让创作更简单</span>
                </h1>
                <p class="hero-description mb-4">
                    为插画师、摄影师、设计师量身打造的智能姿势参考库。
                    <strong>使用GPT-4o进行图像分析，支持自然语言搜索。</strong>
                </p>
                
                <!-- 行动按钮 -->
                <div class="hero-actions mb-5">
                    <a href="/upload" class="btn btn-primary-new btn-lg me-3">
                        <i class="fas fa-upload me-2"></i>
                        立即上传
                    </a>
                    <a href="#search-section" class="btn btn-outline-new btn-lg">
                        <i class="fas fa-search me-2"></i>
                        开始搜索
                    </a>
                </div>
            </div>
            
            <!-- 右侧功能展示 -->
            <div class="col-lg-6">
                <div class="features-showcase-new">
                    <!-- AI分析功能卡片 -->
                    <div class="feature-card-new feature-primary">
                        <div class="feature-icon">
                            <i class="fas fa-robot"></i>
                        </div>
                        <div class="feature-content">
                            <h3 class="feature-title">GPT-4o智能分析</h3>
                            <p class="feature-desc">
                                自动识别姿势、表情、场景、光线、角度等特征，
                                生成精准的标签和描述。
                            </p>
                            <div class="feature-tags">
                                <span class="tag">姿势识别</span>
                                <span class="tag">表情分析</span>
                                <span class="tag">场景理解</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 搜索功能卡片 -->
                    <div class="feature-card-new feature-secondary">
                        <div class="feature-icon">
                            <i class="fas fa-comments"></i>
                        </div>
                        <div class="feature-content">
                            <h3 class="feature-title">自然语言搜索</h3>
                            <p class="feature-desc">
                                支持"女性坐姿室内"、"男性站立户外"等
                                自然语言查询方式。
                            </p>
                            <div class="feature-example">
                                <div class="search-demo">
                                    <i class="fas fa-search"></i>
                                    <span>"女性思考姿势"</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 装饰元素 -->
                    <div class="floating-elements">
                        <div class="float-element float-1"></div>
                        <div class="float-element float-2"></div>
                        <div class="float-element float-3"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 搜索区域 -->
<section id="search-section" class="py-5 bg-light">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <h2 class="text-center mb-4 section-title">智能姿势搜索</h2>
                
                <!-- 搜索框 -->
                <div class="search-container mb-4">
                    <div class="input-group input-group-lg">
                        <input type="text" class="form-control search-input" id="searchInput" 
                               placeholder="试试输入：女性坐姿、男性站立、思考表情...">
                        <button class="btn btn-primary search-btn" type="button" id="searchBtn">
                            <i class="fas fa-search"></i> 搜索
                        </button>
                    </div>
                    <div id="searchSuggestions" class="suggestions-dropdown"></div>
                </div>
                
                <!-- 热门搜索 -->
                <div class="popular-searches mb-4">
                    <h6 class="popular-title mb-3">热门搜索：</h6>
                    <div id="popularTags" class="d-flex flex-wrap gap-2">
                        <!-- 动态加载热门标签 -->
                    </div>
                </div>
                
                <!-- 高级搜索选项 -->
                <div class="advanced-search-toggle text-center">
                    <button class="btn btn-link advanced-toggle" type="button" data-bs-toggle="collapse" 
                            data-bs-target="#advancedSearch">
                        <i class="fas fa-cog"></i> 高级搜索选项
                    </button>
                </div>
                
                <div class="collapse" id="advancedSearch">
                    <div class="card mt-3 advanced-card">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <label class="form-label filter-label">性别</label>
                                    <select class="form-select filter-select" id="genderFilter">
                                        <option value="">不限</option>
                                        <option value="女性">女性</option>
                                        <option value="男性">男性</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label filter-label">姿势类型</label>
                                    <select class="form-select filter-select" id="poseFilter">
                                        <option value="">不限</option>
                                        <option value="站姿">站姿</option>
                                        <option value="坐姿">坐姿</option>
                                        <option value="躺姿">躺姿</option>
                                        <option value="蹲姿">蹲姿</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label filter-label">场景</label>
                                    <select class="form-select filter-select" id="sceneFilter">
                                        <option value="">不限</option>
                                        <option value="室内">室内</option>
                                        <option value="户外">户外</option>
                                        <option value="办公室">办公室</option>
                                        <option value="家居">家居</option>
                                    </select>
                                </div>
                            </div>
                            <div class="text-center mt-3">
                                <button class="btn btn-primary advanced-apply" onclick="performAdvancedSearch()">
                                    <i class="fas fa-filter"></i> 应用筛选
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- 搜索结果区域 -->
<section class="py-5" id="results-section" style="display: none;">
    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3 id="resultsTitle" class="results-title">搜索结果</h3>
            <div class="view-controls">
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-primary active" onclick="setViewMode('grid')">
                        <i class="fas fa-th"></i> 网格
                    </button>
                    <button type="button" class="btn btn-outline-primary" onclick="setViewMode('list')">
                        <i class="fas fa-list"></i> 列表
                    </button>
                </div>
            </div>
        </div>
        
        <div id="searchResults" class="results-container">
            <!-- 搜索结果将在这里动态加载 -->
        </div>
        
        <!-- 加载更多 -->
        <div class="text-center mt-4" id="loadMoreSection" style="display: none;">
            <button class="btn btn-outline-primary" onclick="loadMoreResults()">
                <i class="fas fa-plus"></i> 加载更多
            </button>
        </div>
    </div>
</section>

<!-- 推荐图片区域 -->
<section class="py-5 bg-light" id="recommended-section">
    <div class="container">
        <h3 class="text-center mb-4 section-title">推荐图片</h3>
        <div id="recommendedImages" class="row">
            <!-- 推荐图片将在这里动态加载 -->
        </div>
    </div>
</section>
{% endblock %}

{% block styles %}

{% endblock %}

{% block scripts %}
<script>
let currentSearchQuery = '';
let currentPage = 1;
let viewMode = 'grid';

document.addEventListener('DOMContentLoaded', function() {
    initializePage();
    setupSearchHandlers();
    loadRecommendedImages();
    loadPopularTags();
    loadStats();
});

async function initializePage() {
    // 初始化页面功能
    console.log('AI姿势参考图库初始化完成');
}

function setupSearchHandlers() {
    const searchInput = document.getElementById('searchInput');
    const searchBtn = document.getElementById('searchBtn');
    
    // 搜索按钮点击
    searchBtn.addEventListener('click', performSearch);
    
    // 回车键搜索
    searchInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            performSearch();
        }
    });
    
    // 搜索建议
    let suggestionTimeout;
    searchInput.addEventListener('input', function() {
        clearTimeout(suggestionTimeout);
        suggestionTimeout = setTimeout(() => {
            showSearchSuggestions(this.value);
        }, 300);
    });
    
    // 点击其他地方隐藏建议
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.search-container')) {
            hideSearchSuggestions();
        }
    });
}

async function performSearch() {
    const query = document.getElementById('searchInput').value.trim();
    if (!query) {
        alert('请输入搜索关键词');
        return;
    }
    
    currentSearchQuery = query;
    currentPage = 1;
    
    showResultsSection();
    showSearchLoading();
    
    try {
        const response = await fetch(`/api/search?q=${encodeURIComponent(query)}&limit=20&use_ai=true`);
        const data = await response.json();
        
        if (data.success) {
            displaySearchResults(data.data);
        } else {
            showSearchError('搜索失败，请重试');
        }
    } catch (error) {
        showSearchError('网络错误：' + error.message);
    }
}

async function performAdvancedSearch() {
    const gender = document.getElementById('genderFilter').value;
    const pose = document.getElementById('poseFilter').value;
    const scene = document.getElementById('sceneFilter').value;
    
    let query = document.getElementById('searchInput').value.trim();
    
    // 构建高级搜索查询
    const filters = [gender, pose, scene].filter(f => f);
    if (filters.length > 0) {
        query = query ? `${query} ${filters.join(' ')}` : filters.join(' ');
    }
    
    if (!query) {
        alert('请输入搜索条件');
        return;
    }
    
    document.getElementById('searchInput').value = query;
    await performSearch();
}

function displaySearchResults(searchData) {
    const resultsContainer = document.getElementById('searchResults');
    const images = searchData.images || [];
    
    document.getElementById('resultsTitle').textContent = 
        `搜索"${currentSearchQuery}"的结果 (${images.length}张)`;
    
    if (images.length === 0) {
        resultsContainer.innerHTML = `
            <div class="text-center py-5">
                <i class="fas fa-search fa-3x text-muted mb-3"></i>
                <h5 style="color: #666;">没有找到相关图片</h5>
                <p style="color: #999;">尝试使用其他关键词或上传更多图片</p>
                <a href="/upload" class="btn btn-primary">
                    <i class="fas fa-upload"></i> 上传图片
                </a>
            </div>
        `;
        return;
    }
    
    resultsContainer.className = `results-container ${viewMode}-view`;
    
    let html = '';
    if (viewMode === 'grid') {
        html = '<div class="row">';
        images.forEach(image => {
            html += generateImageCard(image, 'col-lg-3 col-md-4 col-sm-6 mb-4');
        });
        html += '</div>';
    } else {
        images.forEach(image => {
            html += generateImageListItem(image);
        });
    }
    
    resultsContainer.innerHTML = html;
    
    // 显示加载更多按钮（如果有更多结果）
    const loadMoreSection = document.getElementById('loadMoreSection');
    if (images.length >= 20) {
        loadMoreSection.style.display = 'block';
    } else {
        loadMoreSection.style.display = 'none';
    }
}

function generateImageCard(image, colClass = '') {
    const confidence = (image.confidence * 100).toFixed(0);
    const tags = image.tags.slice(0, 3).map(tag => 
        `<span class="badge bg-secondary me-1">${tag.name}</span>`
    ).join('');
    
    return `
        <div class="${colClass}">
            <div class="card image-card border-0 shadow-sm" onclick="openImageDetail(${image.id})">
                <div class="position-relative">
                    <img src="${image.url}" class="image-thumbnail" alt="${image.description}">
                    <span class="badge bg-primary confidence-badge">${confidence}%</span>
                </div>
                <div class="card-body">
                    <p class="card-text small mb-2" style="color: #666;">${image.description || '暂无描述'}</p>
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="tags-container">
                            ${tags}
                        </div>
                        <small style="color: #999;">
                            <i class="fas fa-eye"></i> ${image.view_count}
                        </small>
                    </div>
                </div>
            </div>
        </div>
    `;
}

function generateImageListItem(image) {
    const confidence = (image.confidence * 100).toFixed(0);
    const tags = image.tags.map(tag => 
        `<span class="badge bg-light me-1" style="color: #333;">${tag.name}</span>`
    ).join('');
    
    return `
        <div class="card image-card mb-3" onclick="openImageDetail(${image.id})">
            <div class="row g-0">
                <div class="col-md-3">
                    <img src="${image.url}" class="img-fluid rounded-start h-100" 
                         style="object-fit: cover;" alt="${image.description}">
                </div>
                <div class="col-md-9">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6 class="card-title" style="color: #333;">${image.filename}</h6>
                            <span class="badge bg-primary">${confidence}% 置信度</span>
                        </div>
                        <p class="card-text" style="color: #666;">${image.description || '暂无描述'}</p>
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="tags-container">
                                ${tags}
                            </div>
                            <div style="color: #999;">
                                <small>
                                    <i class="fas fa-eye"></i> ${image.view_count} | 
                                    <i class="fas fa-clock"></i> ${formatDate(image.upload_time)}
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
}

async function showSearchSuggestions(query) {
    if (!query || query.length < 2) {
        hideSearchSuggestions();
        return;
    }
    
    try {
        const response = await fetch(`/api/search/suggestions?q=${encodeURIComponent(query)}`);
        const data = await response.json();
        
        if (data.success && data.data.suggestions.length > 0) {
            displaySuggestions(data.data.suggestions);
        } else {
            hideSearchSuggestions();
        }
    } catch (error) {
        console.error('获取搜索建议失败:', error);
        hideSearchSuggestions();
    }
}

function displaySuggestions(suggestions) {
    const dropdown = document.getElementById('searchSuggestions');
    
    let html = '';
    suggestions.forEach(suggestion => {
        html += `
            <div class="suggestion-item" onclick="selectSuggestion('${suggestion}')">
                <i class="fas fa-search text-muted me-2"></i>${suggestion}
            </div>
        `;
    });
    
    dropdown.innerHTML = html;
    dropdown.style.display = 'block';
}

function hideSearchSuggestions() {
    document.getElementById('searchSuggestions').style.display = 'none';
}

function selectSuggestion(suggestion) {
    document.getElementById('searchInput').value = suggestion;
    hideSearchSuggestions();
    performSearch();
}

async function loadPopularTags() {
    try {
        const response = await fetch('/api/search/popular');
        const data = await response.json();
        
        if (data.success) {
            const container = document.getElementById('popularTags');
            let html = '';
            
            data.data.popular_searches.forEach(tag => {
                html += `
                    <span class="badge bg-primary me-2 mb-2" onclick="searchTag('${tag}')">
                        ${tag}
                    </span>
                `;
            });
            
            container.innerHTML = html;
        }
    } catch (error) {
        console.error('加载热门标签失败:', error);
    }
}

async function loadRecommendedImages() {
    try {
        const response = await fetch('/api/images?per_page=8');
        const data = await response.json();
        
        if (data.success) {
            const container = document.getElementById('recommendedImages');
            let html = '';
            
            data.data.images.forEach(image => {
                html += generateImageCard(image, 'col-lg-3 col-md-4 col-sm-6 mb-4');
            });
            
            container.innerHTML = html;
        }
    } catch (error) {
        console.error('加载推荐图片失败:', error);
    }
}

async function loadStats() {
    try {
        const response = await fetch('/api/admin/stats');
        const data = await response.json();
        
        if (data.success) {
            const stats = data.data;
            document.getElementById('totalImages').textContent = stats.active_images || 0;
            document.getElementById('totalTags').textContent = stats.active_tags || 0;
            document.getElementById('totalSearches').textContent = stats.total_connections || 0;
        }
    } catch (error) {
        console.error('加载统计失败:', error);
    }
}

function searchTag(tag) {
    document.getElementById('searchInput').value = tag;
    performSearch();
}

function setViewMode(mode) {
    viewMode = mode;
    
    // 更新按钮状态
    document.querySelectorAll('.view-controls .btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    // 重新显示结果
    if (document.getElementById('results-section').style.display !== 'none') {
        const resultsContainer = document.getElementById('searchResults');
        if (resultsContainer.innerHTML.trim()) {
            // 触发重新渲染
            performSearch();
        }
    }
}

function showResultsSection() {
    document.getElementById('results-section').style.display = 'block';
    document.getElementById('results-section').scrollIntoView({ 
        behavior: 'smooth', 
        block: 'start' 
    });
}

function showSearchLoading() {
    document.getElementById('searchResults').innerHTML = `
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">搜索中...</span>
            </div>
            <p class="mt-3" style="color: #666;">正在使用GPT-4o智能搜索...</p>
        </div>
    `;
}

function showSearchError(message) {
    document.getElementById('searchResults').innerHTML = `
        <div class="alert alert-danger text-center">
            <i class="fas fa-exclamation-triangle me-2"></i>${message}
        </div>
    `;
}

function openImageDetail(imageId) {
    window.open(`/image/${imageId}`, '_blank');
}

function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('zh-CN');
}

async function loadMoreResults() {
    currentPage++;
    // 实现加载更多逻辑
    console.log('加载更多结果, 页码:', currentPage);
}
</script>
{% endblock %}